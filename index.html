<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0"/>
<title>RAPHAEL · Lord of Wisdom</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&family=UnifrakturMaguntia&family=Cinzel:wght@400;700;900&family=Special+Elite&display=swap" rel="stylesheet"/>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --void:#010409;--cyan:#00c8ff;--cyan2:#0088cc;--cyan3:rgba(0,200,255,.12);
  --purple:#8844ff;--purple2:rgba(136,68,255,.12);
  --danger:#ff2255;--success:#00ffaa;--gold:#ffcc44;
  --txt:#b8dff5;--txt2:#5588aa;--txt3:#4a7a9b;
  --border:rgba(0,180,255,.28);--border2:rgba(0,180,255,.1);
  --font-main:'Rajdhani',sans-serif;--font-mono:'Share Tech Mono',monospace;--font-head:'Orbitron',monospace;
  --tw-speed:30ms;
}
html,body{height:100%;overflow:hidden;background:var(--void);}
body{font-family:var(--font-main);color:var(--txt);}

/* ═══ LIVE BACKGROUND ═══ */
#live-bg{position:fixed;inset:0;z-index:0;overflow:hidden;}
#live-bg video,#live-bg iframe{width:100%;height:100%;object-fit:cover;pointer-events:none;}
#bgc{position:fixed;inset:0;z-index:0;pointer-events:none;}
.scan{position:fixed;inset:0;z-index:1;pointer-events:none;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,.06) 3px,rgba(0,0,0,.06) 4px);}
.vig{position:fixed;inset:0;z-index:2;pointer-events:none;background:radial-gradient(ellipse at center,transparent 40%,rgba(0,0,0,.75) 100%);}
/* Overlay for live bg mode */
body.livebg-on #bgc{display:none;}
body.livebg-on .scan{opacity:.3;}
body.livebg-on .vig{background:radial-gradient(ellipse at center,rgba(0,0,0,.25) 0%,rgba(0,0,0,.7) 100%);}

/* ═══ THEMES — FULL UI PERSONALITY ═══ */
/* Solo Leveling (default) */
body{--theme-font-head:'Orbitron',monospace;--theme-font-body:'Rajdhani',sans-serif;--theme-font-mono:'Share Tech Mono',monospace;}

/* Ancient Scroll */
body.theme-scroll{
  --void:#1a1208;--cyan:#c8a84b;--cyan2:#a0803a;--cyan3:rgba(200,168,75,.12);
  --purple:#8b6914;--border:rgba(200,168,75,.35);--border2:rgba(200,168,75,.12);
  --txt:#e8d5a3;--txt2:#a08040;--txt3:#7a6030;
  --theme-font-head:'Cinzel',serif;--theme-font-body:'Special Elite',cursive;--theme-font-mono:'Special Elite',cursive;
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Cfilter id='n'%3E%3CfeTurbulence baseFrequency='.9' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23n)' opacity='.04'/%3E%3C/svg%3E");
}
body.theme-scroll .topbar{background:linear-gradient(180deg,rgba(30,20,8,.99),rgba(20,12,4,.98));border-bottom:2px solid var(--cyan);}
body.theme-scroll .sb{background:rgba(20,14,6,.97);}
body.theme-scroll .msg.assistant .bb2{background:rgba(200,168,75,.04);border:1px solid rgba(200,168,75,.25);border-left:3px solid var(--cyan);}
body.theme-scroll .lname,.body.theme-scroll .wtitle,.body.theme-scroll .bt{font-family:'Cinzel',serif;}
body.theme-scroll .panel{background:#140e06;}
body.theme-scroll .bb2{font-family:'Special Elite',cursive;font-size:13px;line-height:1.9;}

/* Stone Tablet */
body.theme-stone{
  --void:#0e0c0a;--cyan:#9aa89b;--cyan2:#7a8a7b;--cyan3:rgba(154,168,155,.1);
  --purple:#6a7a6b;--border:rgba(154,168,155,.3);--border2:rgba(154,168,155,.1);
  --txt:#c8cfc8;--txt2:#7a8a7a;--txt3:#5a6a5a;
  --theme-font-head:'Cinzel',serif;--theme-font-body:'Rajdhani',sans-serif;
}
body.theme-stone .topbar{background:linear-gradient(180deg,rgba(20,18,16,.99),rgba(14,12,10,.98));border-bottom:2px solid rgba(154,168,155,.4);}
body.theme-stone .sb{background:rgba(14,12,10,.97);}
body.theme-stone .msg.assistant .bb2{background:rgba(154,168,155,.03);border:1px solid rgba(154,168,155,.2);border-left:3px solid var(--cyan);}
body.theme-stone .panel{background:#0e0c0a;}

/* Nature/Leaf */
body.theme-nature{
  --void:#030d05;--cyan:#44cc77;--cyan2:#33aa55;--cyan3:rgba(68,204,119,.12);
  --purple:#22aa44;--border:rgba(68,204,119,.3);--border2:rgba(68,204,119,.1);
  --txt:#a8ddb8;--txt2:#4a8a5a;--txt3:#3a6a4a;
}
body.theme-nature .topbar{background:linear-gradient(180deg,rgba(3,18,8,.99),rgba(2,12,5,.98));}
body.theme-nature .sb{background:rgba(3,12,6,.97);}
body.theme-nature .panel{background:#030d05;}

/* Neon Cyberpunk */
body.theme-cyber{
  --void:#040010;--cyan:#ff00ff;--cyan2:#cc00cc;--cyan3:rgba(255,0,255,.12);
  --purple:#00ffff;--border:rgba(255,0,255,.35);--border2:rgba(255,0,255,.12);
  --txt:#ffccff;--txt2:#aa44aa;--txt3:#882288;
}
body.theme-cyber .topbar{background:linear-gradient(180deg,rgba(8,0,20,.99),rgba(4,0,14,.98));border-bottom:2px solid var(--cyan);}
body.theme-cyber .sb{background:rgba(4,0,14,.97);}
body.theme-cyber .panel{background:#040010;}
body.theme-cyber .msg.assistant .bb2{border-left:3px solid var(--cyan);box-shadow:0 0 8px rgba(255,0,255,.1);}

/* Dragon Blood */
body.theme-dragon{
  --void:#0d0003;--cyan:#ff4422;--cyan2:#cc2200;--cyan3:rgba(255,68,34,.12);
  --purple:#ff8844;--border:rgba(255,68,34,.35);--border2:rgba(255,68,34,.12);
  --txt:#ffd0b8;--txt2:#aa4422;--txt3:#882200;
}
body.theme-dragon .topbar{background:linear-gradient(180deg,rgba(20,0,4,.99),rgba(14,0,2,.98));}
body.theme-dragon .sb{background:rgba(14,0,3,.97);}
body.theme-dragon .panel{background:#0d0003;}

/* Deep Ocean */
body.theme-ocean{
  --void:#000a18;--cyan:#00ccff;--cyan2:#0088cc;--cyan3:rgba(0,204,255,.12);
  --purple:#0066aa;--border:rgba(0,204,255,.3);--border2:rgba(0,204,255,.1);
  --txt:#a0d8f8;--txt2:#3a6a8a;--txt3:#2a5a7a;
}
body.theme-ocean .topbar{background:linear-gradient(180deg,rgba(0,14,28,.99),rgba(0,8,20,.98));}
body.theme-ocean .sb{background:rgba(0,8,20,.97);}
body.theme-ocean .panel{background:#000a18;}

/* Moonlit Forest */
body.theme-moon{
  --void:#040810;--cyan:#8899ff;--cyan2:#6677dd;--cyan3:rgba(136,153,255,.12);
  --purple:#aabbff;--border:rgba(136,153,255,.3);--border2:rgba(136,153,255,.1);
  --txt:#c8d0f8;--txt2:#4a5888;--txt3:#3a4878;
}
body.theme-moon .topbar{background:linear-gradient(180deg,rgba(6,10,22,.99),rgba(4,6,16,.98));}
body.theme-moon .sb{background:rgba(4,6,18,.97);}
body.theme-moon .panel{background:#040810;}

/* Typewriter effect for assistant messages */
@keyframes tw{from{opacity:0;}to{opacity:1;}}
.tw-char{display:inline;animation:tw var(--tw-speed) ease forwards;opacity:0;}

/* BOOT */
#boot{position:fixed;inset:0;z-index:999;background:var(--void);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:22px;}
#boot.out{animation:bout .6s ease forwards;pointer-events:none;}
@keyframes bout{to{opacity:0;}}
.bh{width:88px;height:88px;position:relative;display:flex;align-items:center;justify-content:center;}
.bh svg{position:absolute;width:88px;height:88px;}
.bh-eye{z-index:2;animation:eopen .4s ease 1.6s both;display:flex;align-items:center;justify-content:center;}
@keyframes eopen{from{opacity:0;transform:scale(.3);}to{opacity:1;transform:scale(1);}}
.r1{animation:sp1 3s linear infinite;}.r2{animation:sp2 2s linear infinite;}
@keyframes sp1{to{transform:rotate(360deg);transform-origin:44px 44px;}}
@keyframes sp2{to{transform:rotate(-360deg);transform-origin:44px 44px;}}
.bt{font-family:var(--theme-font-head,'Orbitron',monospace);font-size:26px;font-weight:900;letter-spacing:8px;background:linear-gradient(90deg,var(--cyan),var(--purple),var(--cyan));background-size:200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shim 2s linear infinite;}
@keyframes shim{to{background-position:200%;}}
.bs{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--txt2);letter-spacing:4px;}
.bbw{width:250px;height:2px;background:rgba(0,180,255,.08);overflow:hidden;}
.bb{height:100%;width:0;background:linear-gradient(90deg,var(--cyan),var(--purple));animation:bbar 2s ease .4s forwards;}
@keyframes bbar{to{width:100%;}}
.blog{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--txt3);letter-spacing:2px;}

/* APP */
#app{position:fixed;inset:0;z-index:10;display:flex;flex-direction:column;opacity:0;}
#app.vis{animation:apin .7s ease forwards;}
@keyframes apin{to{opacity:1;}}

/* TOPBAR */
.topbar{height:54px;flex-shrink:0;background:linear-gradient(180deg,rgba(5,12,40,.97),rgba(3,8,28,.95));border-bottom:1px solid var(--border2);display:flex;align-items:center;justify-content:space-between;padding:0 14px;position:relative;z-index:20;backdrop-filter:blur(10px);}
.tl{display:flex;align-items:center;gap:10px;}
.lhex{width:32px;height:32px;position:relative;flex-shrink:0;}
.lhex svg.hex{width:32px;height:32px;position:absolute;}
.leye{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;animation:ep 3s ease-in-out infinite;}
@keyframes ep{0%,100%{filter:drop-shadow(0 0 3px var(--cyan));}50%{filter:drop-shadow(0 0 10px var(--cyan)) drop-shadow(0 0 18px var(--purple));}}
.lname{font-family:var(--theme-font-head,'Orbitron',monospace);font-size:14px;font-weight:900;letter-spacing:4px;background:linear-gradient(90deg,var(--cyan),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.lsub{font-family:'Share Tech Mono',monospace;font-size:7px;color:var(--txt3);letter-spacing:3px;margin-top:1px;}
.tc{display:flex;gap:3px;overflow-x:auto;}.tc::-webkit-scrollbar{display:none;}
.mp{padding:5px 10px;font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:2px;color:rgba(120,200,255,.8);background:rgba(0,200,255,.04);border:none;cursor:pointer;transition:all .2s;white-space:nowrap;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%);}
.mp:hover,.mp.on{color:var(--cyan);background:var(--cyan3);box-shadow:0 0 10px rgba(0,200,255,.18);}
.tr2{display:flex;align-items:center;gap:7px;}
.schip{display:flex;align-items:center;gap:5px;padding:4px 10px;border:1px solid rgba(0,255,170,.2);background:rgba(0,255,170,.03);font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--success);letter-spacing:2px;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%);}
.sdot{width:5px;height:5px;background:var(--success);border-radius:50%;animation:bk 1.5s ease-in-out infinite;box-shadow:0 0 5px var(--success);}
@keyframes bk{50%{opacity:.15;}}
.ibtn{width:28px;height:28px;border:1px solid var(--border2);background:transparent;color:var(--txt3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);}
.ibtn:hover{border-color:var(--border);color:var(--cyan);background:var(--cyan3);}
.ibtn svg{width:14px;height:14px;}

/* BODY */
.body{flex:1;display:flex;overflow:hidden;}

/* SIDEBAR — swipe to expand/collapse */
.sb{width:52px;flex-shrink:0;background:rgba(4,12,32,.96);display:flex;flex-direction:column;align-items:flex-start;padding:10px 0;gap:3px;z-index:50;overflow-y:auto;overflow-x:hidden;backdrop-filter:blur(12px);transition:width .28s cubic-bezier(.4,0,.2,1);border-right:1px solid var(--border2);}
.sb.expanded{width:160px;}
.sb::-webkit-scrollbar{display:none;}
.sbbtn{width:100%;min-height:48px;border:none;background:transparent;color:rgba(150,220,255,.8);cursor:pointer;display:flex;align-items:center;gap:10px;padding:0 12px;transition:all .2s;position:relative;white-space:nowrap;overflow:hidden;}
.sbbtn svg{width:20px;height:20px;stroke-width:1.8;flex-shrink:0;}
.sbbtn:hover,.sbbtn.on{color:var(--cyan);background:rgba(0,200,255,.1);}
.sbbtn.on{border-left:2px solid var(--cyan);}
.sbtip{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;letter-spacing:1px;opacity:0;transform:translateX(-8px);transition:opacity .2s,transform .2s;white-space:nowrap;pointer-events:none;}
.sb.expanded .sbtip{opacity:1;transform:translateX(0);}
/* Desktop hover tooltip when collapsed */
@media(hover:hover){
  .sb:not(.expanded) .sbbtn:hover::after{content:attr(data-tip);position:absolute;left:58px;top:50%;transform:translateY(-50%);background:rgba(0,4,18,.97);border:1px solid var(--border);padding:5px 12px;font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--cyan);white-space:nowrap;z-index:200;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%);pointer-events:none;}
}
.sbsep{width:calc(100% - 24px);margin:4px 12px;height:1px;background:rgba(0,200,255,.1);flex-shrink:0;}
.sbsp{flex:1;}
/* Swipe overlay when expanded on mobile */
.sb-overlay{display:none;position:fixed;inset:0;z-index:49;background:rgba(0,0,0,.4);}
.sb-overlay.show{display:block;}

/* MAIN */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;}

/* SESSIONS DRAWER */
#sessions-drawer{position:absolute;left:0;top:0;bottom:0;width:240px;background:rgba(0,3,14,.97);border-right:1px solid var(--border);z-index:40;display:flex;flex-direction:column;transform:translateX(-100%);transition:transform .3s ease;backdrop-filter:blur(10px);}
#sessions-drawer.open{transform:translateX(0);}
.sd-top{padding:12px 14px;border-bottom:1px solid var(--border2);display:flex;align-items:center;justify-content:space-between;}
.sd-title{font-family:'Orbitron',monospace;font-size:10px;letter-spacing:3px;color:var(--cyan);}
.sd-new{padding:4px 10px;font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:2px;color:var(--success);border:1px solid rgba(0,255,170,.2);background:rgba(0,255,170,.04);cursor:pointer;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);}
.sd-list{flex:1;overflow-y:auto;padding:8px;}
.sd-list::-webkit-scrollbar{width:2px;}
.sd-list::-webkit-scrollbar-thumb{background:var(--border2);}
.session-item{padding:8px 10px;cursor:pointer;border:1px solid transparent;margin-bottom:4px;transition:all .2s;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);}
.session-item:hover{border-color:var(--border2);background:rgba(0,200,255,.04);}
.session-item.active{border-color:var(--border);background:var(--cyan3);}
.si-name{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;color:var(--txt);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.si-date{font-family:'Share Tech Mono',monospace;font-size:7px;color:var(--txt3);letter-spacing:1px;margin-top:2px;}
.si-del{float:right;color:var(--danger);font-size:12px;line-height:1;cursor:pointer;opacity:0;}
.session-item:hover .si-del{opacity:1;}

/* CHAT */
.cs{flex:1;overflow-y:auto;padding:18px 18px 8px;scroll-behavior:smooth;}
.cs::-webkit-scrollbar{width:3px;}
.cs::-webkit-scrollbar-thumb{background:var(--border2);}

/* WELCOME */
.wc{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100%;text-align:center;gap:16px;padding:20px;}
.worb{width:68px;height:68px;position:relative;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.wcore{width:52px;height:52px;clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);background:linear-gradient(135deg,rgba(0,200,255,.15),rgba(136,68,255,.15));border:1px solid var(--cyan);display:flex;align-items:center;justify-content:center;animation:op 2.5s ease-in-out infinite;}
@keyframes op{0%,100%{box-shadow:0 0 14px rgba(0,200,255,.4);}50%{box-shadow:0 0 28px rgba(0,200,255,.6),0 0 45px rgba(136,68,255,.25);}}
.wring{position:absolute;inset:-7px;clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);border:1px solid rgba(0,200,255,.12);animation:rs 5s linear infinite;}
@keyframes rs{to{transform:rotate(360deg);}}
.wtitle{font-family:var(--theme-font-head,'Orbitron',monospace);font-size:clamp(17px,3vw,26px);font-weight:900;letter-spacing:6px;background:linear-gradient(90deg,var(--cyan),var(--purple),var(--cyan));background-size:200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shim 3s linear infinite;}
.wsub{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--txt2);letter-spacing:2px;line-height:2;max-width:360px;}
.sysn{padding:7px 18px;border:1px solid rgba(0,200,255,.18);background:rgba(0,200,255,.025);font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--cyan);letter-spacing:2px;clip-path:polygon(9px 0%,100% 0%,calc(100% - 9px) 100%,0% 100%);animation:ng 2s ease-in-out infinite;}
@keyframes ng{50%{box-shadow:0 0 12px rgba(0,200,255,.18);border-color:var(--border);}}
.qg{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;max-width:560px;}
.qk{padding:6px 13px;border:1px solid var(--border2);background:rgba(0,0,0,.3);font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;letter-spacing:1px;color:var(--txt2);cursor:pointer;transition:all .2s;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%);backdrop-filter:blur(4px);}
.qk:hover{border-color:var(--border);color:var(--cyan);background:var(--cyan3);box-shadow:0 0 9px rgba(0,200,255,.18);}

/* MESSAGES */
.msg{display:flex;gap:9px;margin-bottom:13px;animation:min .3s ease;}
@keyframes min{from{opacity:0;transform:translateY(7px);}to{opacity:1;transform:translateY(0);}}
.msg.user{flex-direction:row-reverse;}
.av{width:28px;height:28px;flex-shrink:0;clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);display:flex;align-items:center;justify-content:center;margin-top:2px;}
.av svg{width:13px;height:13px;}
.msg.user .av{background:linear-gradient(135deg,rgba(136,68,255,.22),rgba(0,200,255,.12));border:1px solid var(--purple);}
.msg.assistant .av{background:linear-gradient(135deg,rgba(0,200,255,.18),rgba(0,136,204,.08));border:1px solid var(--cyan);}
.bub{max-width:74%;}
.bl{font-family:'Share Tech Mono',monospace;font-size:7px;letter-spacing:2px;margin-bottom:4px;}
.msg.user .bl{color:var(--purple);text-align:right;}
.msg.assistant .bl{color:var(--cyan);}
.bb2{padding:10px 14px;font-size:14px;line-height:1.75;word-break:break-word;backdrop-filter:blur(6px);}
.msg.user .bb2{background:rgba(136,68,255,.06);border:1px solid rgba(136,68,255,.22);clip-path:polygon(0 0,100% 0,100% calc(100% - 6px),calc(100% - 6px) 100%,0 100%);}
.msg.assistant .bb2{background:rgba(0,0,0,.35);border:1px solid var(--border);clip-path:polygon(6px 0,100% 0,100% 100%,0 100%,0 6px);}
.bb2 pre{background:rgba(0,0,0,.55);border:1px solid var(--border2);padding:9px 13px;margin:7px 0;overflow-x:auto;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--success);clip-path:polygon(4px 0,100% 0,100% calc(100% - 4px),calc(100% - 4px) 100%,0 100%,0 4px);}
.bb2 code{background:rgba(0,200,255,.07);padding:1px 5px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--cyan);}
.bb2 strong{color:var(--cyan);font-weight:700;}
.bb2 a{color:var(--purple);text-decoration:underline;}
.mimg{max-width:260px;max-height:220px;margin-top:7px;border:1px solid var(--border);clip-path:polygon(6px 0,100% 0,100% calc(100% - 6px),calc(100% - 6px) 100%,0 100%,0 6px);}
.thr{display:flex;gap:5px;padding:5px 0;align-items:center;}
.td{width:7px;height:7px;background:var(--cyan);clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);animation:tdp 1s ease-in-out infinite;}
.td:nth-child(2){animation-delay:.2s;}.td:nth-child(3){animation-delay:.4s;}
@keyframes tdp{0%,100%{opacity:.15;transform:scale(.6);}50%{opacity:1;transform:scale(1.2);filter:drop-shadow(0 0 5px var(--cyan));}}

/* Generated images in chat */
.gen-img-wrap{display:flex;gap:8px;flex-wrap:wrap;padding:6px 0 6px 37px;}
.gen-img-wrap img{width:160px;height:120px;object-fit:cover;border:1px solid var(--border);cursor:pointer;transition:all .2s;clip-path:polygon(5px 0%,100% 0%,100% calc(100% - 5px),calc(100% - 5px) 100%,0% 100%,0% 5px);}
.gen-img-wrap img:hover{border-color:var(--cyan);box-shadow:0 0 14px rgba(0,200,255,.3);}

/* FILE STRIP */
.fstrip{display:none;flex-wrap:wrap;gap:5px;padding:6px 14px;border-top:1px solid var(--border2);background:rgba(0,2,10,.85);flex-shrink:0;}
.fc{display:flex;align-items:center;gap:5px;padding:3px 9px;border:1px solid var(--border);background:rgba(0,200,255,.03);font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--txt2);clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);}
.fcx{color:var(--danger);cursor:pointer;font-size:11px;}

/* INPUT ZONE */
.iz{flex-shrink:0;padding:9px 14px 13px;background:linear-gradient(0deg,rgba(0,1,8,.95),rgba(0,2,12,.9));border-top:1px solid var(--border2);position:relative;backdrop-filter:blur(10px);}
.iw{display:flex;align-items:flex-end;gap:7px;background:rgba(0,10,30,.6);border:1px solid var(--border);padding:7px 9px;transition:border-color .2s,box-shadow .2s;clip-path:polygon(6px 0%,100% 0%,100% calc(100% - 6px),calc(100% - 6px) 100%,0% 100%,0% 6px);}
.iw:focus-within{border-color:var(--cyan);box-shadow:0 0 22px rgba(0,200,255,.1);}
.il{display:flex;gap:4px;align-items:center;}
.ia{width:27px;height:27px;border:1px solid var(--border2);background:transparent;color:var(--txt3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;clip-path:polygon(3px 0%,100% 0%,calc(100% - 3px) 100%,0% 100%);}
.ia svg{width:14px;height:14px;}
.ia:hover{border-color:var(--border);color:var(--cyan);background:var(--cyan3);}
.ia.rec{border-color:var(--danger);color:var(--danger);animation:rp .8s ease-in-out infinite alternate;}
@keyframes rp{to{box-shadow:0 0 10px rgba(255,34,85,.5);}}
#inp{flex:1;background:transparent;border:none;outline:none;color:var(--txt);font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:500;resize:none;min-height:21px;max-height:105px;line-height:1.5;caret-color:var(--cyan);}
#inp::placeholder{color:var(--txt3);font-style:italic;font-size:12px;letter-spacing:1px;}
.sndbtn{width:34px;height:34px;flex-shrink:0;background:linear-gradient(135deg,rgba(0,200,255,.18),rgba(136,68,255,.18));border:1px solid var(--cyan);color:var(--cyan);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;clip-path:polygon(6px 0%,100% 0%,100% calc(100% - 6px),calc(100% - 6px) 100%,0% 100%,0% 6px);}
.sndbtn svg{width:15px;height:15px;}
.sndbtn:hover{background:linear-gradient(135deg,rgba(0,200,255,.32),rgba(136,68,255,.32));box-shadow:0 0 18px rgba(0,200,255,.38);}
.sndbtn:disabled{opacity:.3;cursor:not-allowed;}
.ifoot{display:flex;justify-content:space-between;margin-top:4px;padding:0 1px;}
.ihint{font-family:'Share Tech Mono',monospace;font-size:7px;color:var(--txt3);letter-spacing:1px;}
.cmode{font-family:'Share Tech Mono',monospace;font-size:7px;color:var(--cyan2);letter-spacing:2px;padding:2px 7px;border:1px solid var(--border2);clip-path:polygon(3px 0%,100% 0%,calc(100% - 3px) 100%,0% 100%);}
#datetime-display{font-family:'Share Tech Mono',monospace;font-size:7px;color:var(--txt3);letter-spacing:1px;text-align:right;}

/* PANELS */
.panel{position:absolute;inset:0;background:var(--void);z-index:50;display:none;flex-direction:column;backdrop-filter:blur(10px);}
.panel.open{display:flex;}
.panel-top{height:48px;flex-shrink:0;background:rgba(0,4,18,.99);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;padding:0 14px;}
.p-back{width:30px;height:30px;border:1px solid var(--border2);background:transparent;color:var(--txt2);cursor:pointer;display:flex;align-items:center;justify-content:center;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%);transition:all .2s;}
.p-back:hover{border-color:var(--border);color:var(--cyan);background:var(--cyan3);}
.p-back svg{width:14px;height:14px;}
.p-title{font-family:var(--theme-font-head,'Orbitron',monospace);font-size:11px;letter-spacing:3px;color:var(--cyan);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ptabs{display:flex;gap:3px;}
.ptab{padding:4px 11px;font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:2px;color:var(--txt3);border:1px solid transparent;cursor:pointer;transition:all .2s;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);}
.ptab.on{color:var(--cyan);border-color:var(--border);background:var(--cyan3);}
.ptab:hover{color:var(--cyan2);border-color:var(--border2);}
.panel-body{flex:1;overflow-y:auto;padding:16px;}
.panel-body::-webkit-scrollbar{width:3px;}
.panel-body::-webkit-scrollbar-thumb{background:var(--border2);}

/* TOAST */
.toast{position:fixed;top:64px;right:14px;z-index:900;padding:8px 14px;background:rgba(0,2,14,.97);border:1px solid var(--cyan);font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--cyan);letter-spacing:1px;clip-path:polygon(7px 0%,100% 0%,calc(100% - 7px) 100%,0% 100%);box-shadow:0 0 18px rgba(0,200,255,.28);animation:tin .25s ease,tout .3s ease 2.5s forwards;max-width:280px;pointer-events:none;}
@keyframes tin{from{opacity:0;transform:translateX(14px);}to{opacity:1;transform:translateX(0);}}
@keyframes tout{to{opacity:0;}}
.empty-state{text-align:center;padding:40px 20px;}
.empty-state svg{width:36px;height:36px;color:var(--txt3);margin-bottom:12px;}
.empty-state p{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--txt3);letter-spacing:2px;line-height:2;}
.rdr-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;height:160px;gap:12px;}
.rdr-msg{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--txt3);letter-spacing:2px;}
input[type=file]{display:none;}

/* GALLERY */
.gal-bar{padding:10px 14px;border-bottom:1px solid var(--border2);background:rgba(0,2,12,.9);display:flex;gap:8px;align-items:center;flex-shrink:0;}
.gal-wrap{flex:1;display:flex;align-items:center;gap:6px;background:rgba(0,10,30,.7);border:1px solid var(--border);padding:6px 10px;clip-path:polygon(5px 0%,100% 0%,100% calc(100% - 5px),calc(100% - 5px) 100%,0% 100%,0% 5px);}
.gal-wrap:focus-within{border-color:var(--cyan);}
.gal-wrap svg{width:13px;height:13px;color:var(--txt3);flex-shrink:0;}
#gal-inp{flex:1;background:transparent;border:none;outline:none;color:var(--txt);font-family:'Rajdhani',sans-serif;font-size:14px;caret-color:var(--cyan);}
#gal-inp::placeholder{color:var(--txt3);font-style:italic;font-size:12px;}
.gal-go{padding:6px 14px;font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--cyan);border:1px solid var(--border);background:var(--cyan3);cursor:pointer;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%);transition:all .2s;}
.gal-go:hover{box-shadow:0 0 12px rgba(0,200,255,.3);}
.gal-results{flex:1;overflow-y:auto;padding:14px;}
.gal-results::-webkit-scrollbar{width:3px;}
.gal-results::-webkit-scrollbar-thumb{background:var(--border2);}
.gal-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px;}
.gal-item{position:relative;overflow:hidden;border:1px solid var(--border2);cursor:pointer;transition:all .2s;aspect-ratio:16/10;background:rgba(0,10,28,.8);}
.gal-item:hover{border-color:var(--border);box-shadow:0 0 14px rgba(0,200,255,.2);}
.gal-item img,.gal-item video{width:100%;height:100%;object-fit:cover;display:block;}
.gal-overlay{position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.8) 0%,transparent 50%);opacity:0;transition:opacity .2s;display:flex;align-items:flex-end;padding:8px;gap:6px;}
.gal-item:hover .gal-overlay{opacity:1;}
.gal-dl{padding:4px 10px;font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--cyan);border:1px solid var(--border);background:rgba(0,200,255,.1);cursor:pointer;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);text-decoration:none;}
.gal-usebg{padding:4px 10px;font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--success);border:1px solid rgba(0,255,170,.3);background:rgba(0,255,170,.06);cursor:pointer;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);text-decoration:none;}
.gal-photographer{font-family:'Share Tech Mono',monospace;font-size:7px;color:var(--txt3);margin-left:auto;}

/* COURSE */
.course-home{padding:16px;}
.course-search-bar{display:flex;gap:8px;margin-bottom:16px;}
.course-inp{flex:1;background:rgba(0,10,30,.7);border:1px solid var(--border);padding:8px 12px;color:var(--txt);font-family:'Rajdhani',sans-serif;font-size:14px;outline:none;caret-color:var(--cyan);}
.course-inp::placeholder{color:var(--txt3);font-size:12px;}
.course-go{padding:8px 18px;font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--cyan);border:1px solid var(--border);background:var(--cyan3);cursor:pointer;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%);}
.cat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-bottom:20px;}
.cat-card{border:1px solid var(--border2);background:rgba(0,8,24,.6);padding:14px;cursor:pointer;transition:all .2s;text-align:center;clip-path:polygon(6px 0%,100% 0%,100% calc(100% - 6px),calc(100% - 6px) 100%,0% 100%,0% 6px);}
.cat-card:hover{border-color:var(--border);background:var(--cyan3);box-shadow:0 0 14px rgba(0,200,255,.15);}
.cat-icon{font-size:24px;margin-bottom:6px;}
.cat-name{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--cyan);}

/* COURSE VIEW */
#course-view{position:absolute;inset:0;z-index:55;background:var(--void);display:none;flex-direction:column;}
#course-view.open{display:flex;}
.cv-top{height:48px;flex-shrink:0;background:rgba(0,4,18,.99);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;padding:0 14px;}
.cv-back{width:30px;height:30px;border:1px solid var(--border2);background:transparent;color:var(--txt2);cursor:pointer;display:flex;align-items:center;justify-content:center;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%);transition:all .2s;}
.cv-back:hover{border-color:var(--border);color:var(--cyan);}
.cv-back svg{width:14px;height:14px;}
.cv-title{font-family:'Orbitron',monospace;font-size:10px;letter-spacing:2px;color:var(--cyan);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.cv-layout{flex:1;display:flex;overflow:hidden;}
.cv-sidebar{width:220px;flex-shrink:0;border-right:1px solid var(--border2);overflow-y:auto;padding:10px;}
.cv-sidebar::-webkit-scrollbar{width:2px;}
.cv-main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.cv-chat{flex:1;overflow-y:auto;padding:16px;}
.cv-chat::-webkit-scrollbar{width:3px;}
.cv-chat::-webkit-scrollbar-thumb{background:var(--border2);}
.cv-inp-row{display:flex;gap:8px;padding:10px 14px;border-top:1px solid var(--border2);background:rgba(0,2,12,.95);}
#cv-inp{flex:1;background:rgba(0,10,30,.7);border:1px solid var(--border);padding:7px 12px;color:var(--txt);font-family:'Rajdhani',sans-serif;font-size:14px;outline:none;caret-color:var(--cyan);}
.cv-send{padding:7px 16px;font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--cyan);border:1px solid var(--border);background:var(--cyan3);cursor:pointer;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%);}
.module-item{padding:8px 10px;border:1px solid transparent;cursor:pointer;margin-bottom:3px;transition:all .2s;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);}
.module-item:hover,.module-item.active{border-color:var(--border);background:var(--cyan3);}
.module-title{font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:600;color:var(--txt);}
.module-sub{font-family:'Share Tech Mono',monospace;font-size:7px;color:var(--txt3);letter-spacing:1px;margin-top:2px;}
.module-done{width:8px;height:8px;background:var(--success);border-radius:50%;float:right;margin-top:3px;display:none;}
.module-item.done .module-done{display:block;}
.course-section-lbl{font-family:'Share Tech Mono',monospace;font-size:7px;letter-spacing:3px;color:var(--txt3);padding:6px 10px 3px;}
.progress-bar{height:2px;background:rgba(0,180,255,.08);margin:8px 10px;}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--cyan),var(--purple));transition:width .4s;}

/* PROFILE */
.profile-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.pf-section{border:1px solid var(--border2);background:rgba(0,8,24,.6);padding:14px;clip-path:polygon(6px 0%,100% 0%,100% calc(100% - 6px),calc(100% - 6px) 100%,0% 100%,0% 6px);}
.pf-section.full{grid-column:1/-1;}
.pf-label{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:3px;color:var(--cyan);margin-bottom:8px;}
.pf-input{width:100%;background:rgba(0,10,30,.7);border:1px solid var(--border2);padding:7px 10px;color:var(--txt);font-family:'Rajdhani',sans-serif;font-size:13px;outline:none;caret-color:var(--cyan);transition:border-color .2s;}
.pf-input:focus{border-color:var(--cyan);}
.pf-input::placeholder{color:var(--txt3);font-size:12px;}
textarea.pf-input{resize:vertical;min-height:70px;line-height:1.6;}
.pf-save{margin-top:16px;padding:10px 24px;font-family:'Orbitron',monospace;font-size:10px;letter-spacing:3px;color:var(--cyan);border:1px solid var(--border);background:var(--cyan3);cursor:pointer;clip-path:polygon(6px 0%,100% 0%,calc(100% - 6px) 100%,0% 100%);transition:all .2s;}
.pf-save:hover{box-shadow:0 0 18px rgba(0,200,255,.3);}
.pf-avatar{width:60px;height:60px;clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);background:linear-gradient(135deg,var(--cyan3),var(--purple2));border:1px solid var(--cyan);display:flex;align-items:center;justify-content:center;font-size:22px;margin-bottom:10px;}
.pf-stat{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border2);font-family:'Rajdhani',sans-serif;font-size:12px;}
.pf-stat-key{color:var(--txt3);}
.pf-stat-val{color:var(--cyan);font-weight:600;}

/* SHARED COMPONENTS */
.ab-inp{width:100%;background:rgba(0,10,30,.7);border:1px solid var(--border);padding:8px 12px;color:var(--txt);font-family:'Rajdhani',sans-serif;font-size:14px;outline:none;caret-color:var(--cyan);}
.ab-inp::placeholder{color:var(--txt3);font-size:12px;}
.ab-inp:focus{border-color:var(--cyan);}
.ab-label{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:3px;color:var(--cyan);margin-bottom:6px;}
.ab-field{margin-bottom:12px;}
.ab-generate{width:100%;padding:10px;font-family:'Orbitron',monospace;font-size:10px;letter-spacing:3px;color:var(--cyan);border:1px solid var(--border);background:var(--cyan3);cursor:pointer;clip-path:polygon(6px 0%,100% 0%,calc(100% - 6px) 100%,0% 100%);transition:all .2s;margin-top:8px;}
.ab-generate:hover{box-shadow:0 0 18px rgba(0,200,255,.3);}
.section-lbl{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:3px;color:var(--cyan);margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--border2);}
.add-btn{padding:5px 14px;font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:2px;color:var(--success);border:1px solid rgba(0,255,170,.2);background:rgba(0,255,170,.04);cursor:pointer;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);transition:all .2s;}
.add-btn:hover{box-shadow:0 0 10px rgba(0,255,170,.2);}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.timer-btn{padding:8px 20px;font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;border:1px solid var(--border);background:var(--cyan3);color:var(--cyan);cursor:pointer;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%);transition:all .2s;}
.timer-btn:hover{box-shadow:0 0 14px rgba(0,200,255,.3);}
.timer-btn.danger{border-color:rgba(255,34,85,.3);background:rgba(255,34,85,.06);color:var(--danger);}
.biz-section{border:1px solid var(--border2);background:rgba(0,8,24,.6);padding:14px;margin-bottom:10px;clip-path:polygon(6px 0%,100% 0%,100% calc(100% - 6px),calc(100% - 6px) 100%,0% 100%,0% 6px);}
.biz-result{background:rgba(0,5,18,.8);border:1px solid var(--border2);padding:12px;margin-top:10px;font-family:'Rajdhani',sans-serif;font-size:13px;line-height:1.75;color:var(--txt);max-height:320px;overflow-y:auto;}
.biz-result::-webkit-scrollbar{width:3px;}
.biz-result::-webkit-scrollbar-thumb{background:var(--border2);}
.wake-btn{padding:4px 10px;font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:2px;border:1px solid var(--border2);background:transparent;color:var(--txt3);cursor:pointer;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);transition:all .2s;}
.wake-btn.on{color:var(--success);border-color:rgba(0,255,170,.3);background:rgba(0,255,170,.04);}

/* TRAINING */
.sl-rank-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;font-family:'Orbitron',monospace;font-size:9px;letter-spacing:3px;clip-path:polygon(6px 0%,100% 0%,calc(100% - 6px) 100%,0% 100%);}
.rank-e{background:rgba(100,100,100,.15);border:1px solid #666;color:#999;}
.rank-d{background:rgba(0,200,100,.1);border:1px solid #00c864;color:#00c864;}
.rank-c{background:rgba(0,150,255,.12);border:1px solid #0096ff;color:#0096ff;}
.rank-b{background:rgba(136,68,255,.15);border:1px solid var(--purple);color:var(--purple);}
.rank-a{background:rgba(255,170,0,.12);border:1px solid #ffaa00;color:#ffaa00;}
.rank-s{background:rgba(255,34,85,.12);border:1px solid var(--danger);color:var(--danger);}
.xp-bar-wrap{height:6px;background:rgba(0,180,255,.08);border:1px solid var(--border2);overflow:hidden;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);flex:1;}
.xp-bar-fill{height:100%;background:linear-gradient(90deg,var(--cyan),var(--purple));transition:width .5s ease;}
.stat-hexes{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0;}
.stat-hex{width:70px;height:70px;clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);background:rgba(0,10,28,.8);border:1px solid var(--border2);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;}
.stat-hex:hover{border-color:var(--cyan);background:var(--cyan3);box-shadow:0 0 14px rgba(0,200,255,.2);}
.stat-hex-val{font-family:'Orbitron',monospace;font-size:14px;font-weight:900;color:var(--cyan);}
.stat-hex-lbl{font-family:'Share Tech Mono',monospace;font-size:7px;color:var(--txt3);letter-spacing:1px;margin-top:2px;}
.workout-card{border:1px solid var(--border2);background:rgba(0,8,24,.7);padding:12px;margin-bottom:8px;clip-path:polygon(6px 0%,100% 0%,100% calc(100% - 6px),calc(100% - 6px) 100%,0% 100%,0% 6px);transition:all .2s;}
.workout-card:hover{border-color:var(--border);box-shadow:0 0 12px rgba(0,200,255,.12);}
.wc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.wc-name{font-family:'Orbitron',monospace;font-size:11px;letter-spacing:2px;color:var(--cyan);}
.exercise-row{display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid var(--border2);}
.ex-name{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;color:var(--txt);flex:1;}
.ex-sets{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--txt2);}
.ex-check{width:18px;height:18px;border:1px solid var(--border);background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;clip-path:polygon(3px 0%,100% 0%,calc(100% - 3px) 100%,0% 100%);transition:all .2s;flex-shrink:0;}
.ex-check.done{background:var(--cyan3);border-color:var(--cyan);}
.ex-check svg{width:10px;height:10px;}
.timer-display{font-family:'Orbitron',monospace;font-size:36px;font-weight:900;color:var(--cyan);text-align:center;letter-spacing:4px;text-shadow:0 0 20px rgba(0,200,255,.5);margin:12px 0;}
.quest-card{border:1px solid rgba(255,170,0,.2);background:rgba(255,170,0,.04);padding:10px 14px;margin-bottom:6px;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%);transition:all .2s;cursor:pointer;}
.quest-card.done{border-color:rgba(0,255,170,.2);background:rgba(0,255,170,.04);}
.quest-title{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;color:#ffcc44;}
.quest-card.done .quest-title{color:var(--success);}
.quest-xp{font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--txt3);letter-spacing:1px;}

/* HABITS */
.habit-grid-wrap{overflow-x:auto;padding-bottom:8px;}
.habit-grid-wrap::-webkit-scrollbar{height:3px;}
.habit-grid-wrap::-webkit-scrollbar-thumb{background:var(--border2);}
.habit-table{border-collapse:collapse;min-width:100%;}
.habit-table th{font-family:'Share Tech Mono',monospace;font-size:7px;letter-spacing:1px;color:var(--txt3);padding:4px 6px;text-align:center;border-bottom:1px solid var(--border2);}
.habit-table td{padding:3px 4px;border-bottom:1px solid rgba(0,180,255,.04);}
.habit-name-cell{font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:600;color:var(--txt);white-space:nowrap;padding-right:10px;min-width:130px;}
.habit-check{width:18px;height:18px;border:1px solid var(--border2);background:transparent;cursor:pointer;margin:0 auto;display:flex;align-items:center;justify-content:center;clip-path:polygon(3px 0%,100% 0%,calc(100% - 3px) 100%,0% 100%);transition:all .15s;}
.habit-check.done{background:var(--cyan3);border-color:var(--cyan);}
.habit-check.done::after{content:'✓';font-size:10px;color:var(--cyan);}
.habit-pct{font-family:'Share Tech Mono',monospace;font-size:9px;font-weight:700;color:var(--cyan);min-width:36px;text-align:right;}
.habit-prog-cell{min-width:80px;padding-left:6px;}
.habit-mini-bar{height:4px;background:rgba(0,180,255,.08);overflow:hidden;clip-path:polygon(2px 0%,100% 0%,calc(100% - 2px) 100%,0% 100%);}
.habit-mini-fill{height:100%;background:linear-gradient(90deg,var(--cyan),var(--purple));transition:width .3s;}
.chart-wrap{background:rgba(0,5,18,.7);border:1px solid var(--border2);padding:14px;margin-top:14px;clip-path:polygon(6px 0%,100% 0%,100% calc(100% - 6px),calc(100% - 6px) 100%,0% 100%,0% 6px);}
.chart-title{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:3px;color:var(--cyan);margin-bottom:10px;}
canvas.habit-chart{width:100%!important;max-height:160px;}

/* AUDIOBOOK */
.ab-setup{padding:16px;}
.ab-dur-row{display:flex;gap:8px;flex-wrap:wrap;}
.ab-dur-btn{padding:7px 14px;font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:2px;color:var(--txt3);border:1px solid var(--border2);background:transparent;cursor:pointer;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);transition:all .2s;}
.ab-dur-btn.on,.ab-dur-btn:hover{color:var(--cyan);border-color:var(--border);background:var(--cyan3);}
.ab-player{padding:14px;border-top:1px solid var(--border2);display:none;}
.ab-player.show{display:block;}
.ab-player-title{font-family:'Orbitron',monospace;font-size:11px;letter-spacing:2px;color:var(--cyan);margin-bottom:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ab-controls{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.ab-btn{width:32px;height:32px;border:1px solid var(--border);background:var(--cyan3);color:var(--cyan);cursor:pointer;display:flex;align-items:center;justify-content:center;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%);transition:all .2s;}
.ab-btn:hover{box-shadow:0 0 10px rgba(0,200,255,.3);}
.ab-btn svg{width:13px;height:13px;}
.ab-progress{flex:1;height:3px;background:rgba(0,180,255,.1);cursor:pointer;position:relative;}
.ab-fill{height:100%;background:linear-gradient(90deg,var(--cyan),var(--purple));width:0%;pointer-events:none;}
.ab-time{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--txt3);}
.ab-script{max-height:200px;overflow-y:auto;font-family:'Rajdhani',sans-serif;font-size:13px;line-height:1.8;color:var(--txt2);white-space:pre-wrap;}
.ab-script::-webkit-scrollbar{width:3px;}
.ab-script::-webkit-scrollbar-thumb{background:var(--border2);}

/* THEME CARDS */
.theme-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-bottom:16px;}
.theme-card{border:2px solid var(--border2);padding:14px;cursor:pointer;transition:all .25s;text-align:center;clip-path:polygon(6px 0%,100% 0%,100% calc(100% - 6px),calc(100% - 6px) 100%,0% 100%,0% 6px);}
.theme-card:hover{transform:translateY(-2px);box-shadow:0 4px 20px rgba(0,0,0,.4);}
.theme-card.active{border-width:2px;}
.theme-swatch{width:44px;height:44px;border-radius:50%;margin:0 auto 8px;box-shadow:0 0 12px currentColor;}
.theme-name{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:2px;}
.theme-preview{font-family:'Share Tech Mono',monospace;font-size:7px;color:rgba(255,255,255,.5);margin-top:4px;letter-spacing:1px;}

/* MOBILE SIDEBAR — bigger, touch-friendly */
@media(max-width:768px){
  .sb{width:52px;padding:8px 0;gap:2px;}
  .sb.expanded{width:170px;position:absolute;left:0;top:0;bottom:0;z-index:50;box-shadow:4px 0 20px rgba(0,0,0,.6);}
  .sbbtn{min-height:52px;padding:0 14px;gap:10px;}
  .sbbtn svg{width:22px;height:22px;}
  .tc{display:none;}.schip span{display:none;}
  .lname{font-size:12px;letter-spacing:2px;}
  .bub{max-width:90%;}
  .cs{padding:10px 9px 6px;}
  .iz{padding:7px 9px 12px;}
  .profile-grid{grid-template-columns:1fr;}
  .gal-grid{grid-template-columns:repeat(auto-fill,minmax(130px,1fr));}
  .two-col{grid-template-columns:1fr;}
  .stat-hexes{gap:5px;}.stat-hex{width:60px;height:60px;}
  .timer-display{font-size:30px;}
  .bb2{font-size:15px;line-height:1.8;}
  .qk{font-size:14px;padding:8px 14px;}
  .sndbtn{width:46px;height:46px;}
  .ia{width:36px;height:36px;}
  .ia svg{width:18px;height:18px;}
  .panel{width:100%!important;max-width:100%!important;}
  .ab-inp,.pf-input{font-size:15px!important;padding:10px 12px!important;}
}
@media(max-width:380px){
  .sb{width:48px;}
  .sbbtn{min-height:48px;padding:0 12px;}
  .lsub{display:none;}
}
</style>
</head>
<body>

<!-- LIVE BG -->
<div id="live-bg"></div>
<canvas id="bgc"></canvas>
<div class="scan"></div>
<div class="vig"></div>

<!-- PWA -->
<link rel="manifest" href="data:application/json,{%22name%22:%22RAPHAEL%22,%22short_name%22:%22RAPHAEL%22,%22display%22:%22standalone%22,%22background_color%22:%22%23010409%22,%22theme_color%22:%22%2300c8ff%22,%22start_url%22:%22.%22}">
<meta name="theme-color" content="#010409">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="RAPHAEL">

<!-- BOOT -->
<div id="boot">
  <div class="bh">
    <svg viewBox="0 0 88 88"><polygon class="r1" points="44,3 81,22 81,66 44,85 7,66 7,22" fill="none" stroke="rgba(0,200,255,.35)" stroke-width="1" stroke-dasharray="4 3"/><polygon class="r2" points="44,11 75,27 75,61 44,77 13,61 13,27" fill="none" stroke="rgba(136,68,255,.25)" stroke-width="1" stroke-dasharray="2 4"/><polygon points="44,20 70,34 70,54 44,68 18,54 18,34" fill="rgba(0,200,255,.03)" stroke="rgba(0,200,255,.45)" stroke-width="1"/></svg>
    <div class="bh-eye"><svg viewBox="0 0 24 24" fill="none" stroke="rgba(0,200,255,0.9)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="26" height="26"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></div>
  </div>
  <div class="bt">RAPHAEL</div>
  <div class="bs">LORD OF WISDOM · INITIALIZING</div>
  <div class="bbw"><div class="bb"></div></div>
  <div class="blog" id="blog">▶ AWAKENING SYSTEM CORE...</div>
</div>

<!-- APP -->
<div id="app">
  <div class="topbar">
    <div class="tl">
      <div class="lhex">
        <svg class="hex" viewBox="0 0 32 32"><polygon points="16,2 29,9 29,23 16,30 3,23 3,9" fill="rgba(0,200,255,.05)" stroke="rgba(0,200,255,.45)" stroke-width="1"/><polygon points="16,7 25,12 25,20 16,25 7,20 7,12" fill="none" stroke="rgba(136,68,255,.25)" stroke-width=".5"/></svg>
        <div class="leye"><svg viewBox="0 0 24 24" fill="none" stroke="rgba(0,200,255,0.85)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" width="13" height="13"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></div>
      </div>
      <div><div class="lname">RAPHAEL</div><div class="lsub" id="top-username">LORD OF WISDOM · S-RANK SYSTEM</div></div>
    </div>
    <div class="tc">
      <button class="mp on" id="mp-chat">◈ CHAT</button>
      <button class="mp" id="mp-learn" onclick="openPanel('course-panel')">◈ LEARN</button>
      <button class="mp" id="mp-gallery" onclick="openPanel('gallery-panel')">◈ GALLERY</button>
      <button class="mp" id="mp-train" onclick="openPanel('train-panel')">◈ TRAIN</button>
      <button class="mp" id="mp-habits" onclick="openPanel('habits-panel')">◈ HABITS</button>
      <button class="mp" id="mp-biz" onclick="openPanel('business-panel');initBusiness()">◈ BUSINESS</button>
      <button class="mp" id="mp-create" onclick="openPanel('create-panel')">◈ CREATE</button>
    </div>
    <div class="tr2">
      <div class="schip"><div class="sdot"></div><span id="api-chip-txt">ONLINE</span></div>
      <button class="wake-btn" id="wake-btn" onclick="toggleWakeLock()">☀ AWAKE</button>
      <button class="ibtn" onclick="toggleSessions()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg></button>
      <button class="ibtn" onclick="openPanel('profile-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></button>
      <button class="ibtn" onclick="clearChat()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg></button>
    </div>
  </div>

  <div class="body">
    <div class="sb-overlay" id="sb-overlay" onclick="collapseSb()"></div>
    <div class="sb" id="sidebar">
      <button class="sbbtn on" data-tip="CHAT SESSIONS" onclick="toggleSessions()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><span class="sbtip">Sessions</span></button>
      <button class="sbbtn" data-tip="LEARN ANYTHING" onclick="openPanel('course-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg><span class="sbtip">Learn</span></button>
      <button class="sbbtn" data-tip="GALLERY" onclick="openPanel('gallery-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg><span class="sbtip">Gallery</span></button>
      <button class="sbbtn" data-tip="TRAINING" onclick="openPanel('train-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 4v16M18 4v16M3 8h4M17 8h4M3 16h4M17 16h4M8 4h8"/></svg><span class="sbtip">Training</span></button>
      <button class="sbbtn" data-tip="HABITS" onclick="openPanel('habits-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg><span class="sbtip">Habits</span></button>
      <button class="sbbtn" data-tip="AUDIOBOOK" onclick="openPanel('audiobook-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 18v-6a9 9 0 0 1 18 0v6"/><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/></svg><span class="sbtip">Audiobook</span></button>
      <button class="sbbtn" data-tip="BUSINESS" onclick="openPanel('business-panel');initBusiness()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg><span class="sbtip">Business</span></button>
      <button class="sbbtn" data-tip="CREATE · AI MEDIA" style="color:rgba(255,204,0,.9);" onclick="openPanel('create-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg><span class="sbtip">Create</span></button>
      <button class="sbbtn" data-tip="SECOND BRAIN" onclick="openPanel('brain-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96-.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 4.44-1.66z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96-.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-4.44-1.66z"/></svg><span class="sbtip">Brain</span></button>
      <button class="sbbtn" data-tip="DAILY PLANNER" onclick="openPanel('planner-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class="sbtip">Planner</span></button>
      <button class="sbbtn" data-tip="BUDGET TRACKER" onclick="openPanel('budget-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg><span class="sbtip">Budget</span></button>
      <div class="sbsep"></div>
      <button class="sbbtn" data-tip="MY PROFILE" onclick="openPanel('profile-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><span class="sbtip">Profile</span></button>
      <button class="sbbtn" data-tip="THEMES" onclick="openPanel('theme-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg><span class="sbtip">Themes</span></button>
      <button class="sbbtn" data-tip="LIVE BACKGROUND" onclick="openPanel('bg-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg><span class="sbtip">Background</span></button>
      <div class="sbsep"></div>
      <button class="sbbtn" data-tip="UPLOAD IMAGE" onclick="document.getElementById('ii').click()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg><span class="sbtip">Image</span></button>
      <button class="sbbtn" data-tip="UPLOAD FILE" onclick="document.getElementById('fi').click()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg><span class="sbtip">File</span></button>
      <button class="sbbtn" id="vsb" data-tip="VOICE INPUT" onclick="toggleVoice()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg><span class="sbtip">Voice</span></button>
      <div class="sbsp"></div>
      <button class="sbbtn" data-tip="BACKUP & RESTORE" onclick="openBackupPanel()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-.18-4.83"/></svg><span class="sbtip">Backup</span></button>
      <button class="sbbtn" data-tip="API KEY" style="color:rgba(255,204,0,.9);" onclick="openApiSetup()" id="key-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg><span class="sbtip">API Key</span></button>
      <button class="sbbtn" data-tip="CLEAR CHAT" onclick="clearChat()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg><span class="sbtip">Clear</span></button>
    </div>

    <div class="main">
      <div id="sessions-drawer">
        <div class="sd-top">
          <div class="sd-title">SESSIONS</div>
          <button class="sd-new" onclick="newSession()">+ NEW</button>
        </div>
        <div class="sd-list" id="sd-list"></div>
      </div>

      <div class="cs" id="chat"></div>
      <div class="fstrip" id="fstrip"></div>
      <div class="iz">
        <div class="iw">
          <div class="il">
            <button class="ia" onclick="document.getElementById('ii').click()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></button>
            <button class="ia" onclick="document.getElementById('fi').click()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg></button>
            <button class="ia" id="vbtn" onclick="toggleVoice()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg></button>
          </div>
          <textarea id="inp" placeholder="Command Raphael, Master..." rows="1" onkeydown="onKey(event)" oninput="rsz(this)"></textarea>
          <button class="sndbtn" id="sndbtn" onclick="send()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
        </div>
        <div class="ifoot">
          <span class="ihint" id="datetime-display">—</span>
          <span class="cmode" id="cmode">◈ ULTIMATE MODE</span>
        </div>
      </div>

      <!-- PROFILE PANEL -->
      <div class="panel" id="profile-panel">
        <div class="panel-top">
          <button class="p-back" onclick="closePanel('profile-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
          <div class="p-title">◈ MY PROFILE · PERSONAL MEMORY</div>
        </div>
        <div class="panel-body">
          <div class="profile-grid">
            <div class="pf-section full" style="display:flex;align-items:center;gap:16px;">
              <div class="pf-avatar" id="pf-av">👑</div>
              <div>
                <div style="font-family:Orbitron,monospace;font-size:14px;font-weight:900;color:var(--cyan);" id="pf-display-name">My Liege</div>
                <div style="font-family:Share Tech Mono,monospace;font-size:8px;color:var(--txt3);letter-spacing:2px;margin-top:4px;">RAPHAEL KNOWS YOU · ALWAYS</div>
              </div>
            </div>
            <div class="pf-section"><div class="pf-label">NAME</div><input class="pf-input" id="pf-name" placeholder="Your name..."/></div>            <div class="pf-section"><div class="pf-label">AGE</div><input class="pf-input" id="pf-age" placeholder="Your age..."/></div>
            <div class="pf-section"><div class="pf-label">LOCATION</div><input class="pf-input" id="pf-location" placeholder="Your location..."/></div>
            <div class="pf-section"><div class="pf-label">OCCUPATION</div><input class="pf-input" id="pf-job" placeholder="What do you do?"/></div>
            <div class="pf-section full"><div class="pf-label">GOALS & INTERESTS</div><textarea class="pf-input" id="pf-goals" placeholder="What are you working towards? What do you love?"></textarea></div>
            <div class="pf-section full"><div class="pf-label">PERSONAL KNOWLEDGE BASE</div><textarea class="pf-input" id="pf-kb" placeholder="Tell Raphael anything to always remember..." style="min-height:100px;"></textarea></div>
            <div class="pf-section full">
              <div class="pf-label">STATS</div>
              <div class="pf-stat"><span class="pf-stat-key">Total Sessions</span><span class="pf-stat-val" id="stat-sessions">0</span></div>
              <div class="pf-stat"><span class="pf-stat-key">Total Messages</span><span class="pf-stat-val" id="stat-msgs">0</span></div>
              <div class="pf-stat"><span class="pf-stat-key">Courses Started</span><span class="pf-stat-val" id="stat-courses">0</span></div>
            </div>
          </div>
          <button class="pf-save" onclick="saveProfile()">◈ SAVE PROFILE</button>
        </div>
      </div>

      <!-- GALLERY PANEL -->
      <div class="panel" id="gallery-panel">
        <div class="panel-top">
          <button class="p-back" onclick="closePanel('gallery-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
          <div class="p-title">◈ GALLERY · FREE MEDIA</div>
          <div class="ptabs">
            <button class="ptab on" id="gtab-photos" onclick="switchGalTab('photos')">PHOTOS</button>
            <button class="ptab" id="gtab-videos" onclick="switchGalTab('videos')">VIDEOS</button>
          </div>
        </div>
        <div class="gal-bar">
          <div class="gal-wrap">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input id="gal-inp" placeholder="Search... (e.g. dandelion field, forest, ocean sunset)" onkeydown="if(event.key==='Enter')galSearch()"/>
          </div>
          <button class="gal-go" onclick="galSearch()">SEARCH</button>
        </div>
        <div class="gal-results" id="gal-results">
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            <p>SEARCH MILLIONS OF FREE PHOTOS & VIDEOS<br>FROM PEXELS & PIXABAY<br>USE AS BACKGROUND OR DOWNLOAD</p>
          </div>
        </div>
      </div>

      <!-- COURSE PANEL -->
      <div class="panel" id="course-panel">
        <div class="panel-top">
          <button class="p-back" onclick="closePanel('course-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
          <div class="p-title">◈ LEARN ANYTHING · FREE COURSES</div>
        </div>
        <div class="panel-body" id="course-home-body">
          <div class="course-home">
            <div class="course-search-bar">
              <input class="course-inp" id="course-inp" placeholder="What do you want to learn? (e.g. Anime Drawing, Python, Sales, Guitar...)" onkeydown="if(event.key==='Enter')startCourse()"/>
              <button class="course-go" onclick="startCourse()">START</button>
            </div>
            <div style="font-family:Share Tech Mono,monospace;font-size:8px;color:var(--txt3);letter-spacing:3px;margin-bottom:10px;">◈ POPULAR CATEGORIES</div>
            <div class="cat-grid">
              <div class="cat-card" onclick="launchCourse('Anime Drawing & Illustration')"><div class="cat-icon">✏️</div><div class="cat-name">ANIME ART</div></div>
              <div class="cat-card" onclick="launchCourse('Sales & Business Networking')"><div class="cat-icon">💼</div><div class="cat-name">SALES</div></div>
              <div class="cat-card" onclick="launchCourse('Python Programming')"><div class="cat-icon">💻</div><div class="cat-name">CODING</div></div>
              <div class="cat-card" onclick="launchCourse('Digital Marketing')"><div class="cat-icon">📱</div><div class="cat-name">MARKETING</div></div>
              <div class="cat-card" onclick="launchCourse('Guitar for Beginners')"><div class="cat-icon">🎸</div><div class="cat-name">MUSIC</div></div>
              <div class="cat-card" onclick="launchCourse('UI/UX Design')"><div class="cat-icon">🎨</div><div class="cat-name">DESIGN</div></div>
              <div class="cat-card" onclick="launchCourse('Photography')"><div class="cat-icon">📷</div><div class="cat-name">PHOTOGRAPHY</div></div>
              <div class="cat-card" onclick="launchCourse('Personal Finance & Investing')"><div class="cat-icon">💰</div><div class="cat-name">FINANCE</div></div>
              <div class="cat-card" onclick="launchCourse('Public Speaking')"><div class="cat-icon">🎤</div><div class="cat-name">SPEAKING</div></div>
              <div class="cat-card" onclick="launchCourse('Creative Writing')"><div class="cat-icon">📖</div><div class="cat-name">WRITING</div></div>
              <div class="cat-card" onclick="launchCourse('Fitness & Bodybuilding')"><div class="cat-icon">💪</div><div class="cat-name">FITNESS</div></div>
              <div class="cat-card" onclick="launchCourse('Video Editing')"><div class="cat-icon">🎬</div><div class="cat-name">VIDEO</div></div>
            </div>
          </div>
        </div>
        <div id="course-view">
          <div class="cv-top">
            <button class="cv-back" onclick="closeCourseView()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
            <div class="cv-title" id="cv-title">—</div>
            <div style="font-family:Share Tech Mono,monospace;font-size:8px;color:var(--txt3);letter-spacing:2px;padding-right:8px;" id="cv-progress-lbl">0% COMPLETE</div>
          </div>
          <div class="cv-layout">
            <div class="cv-sidebar" id="cv-sidebar"></div>
            <div class="cv-main">
              <div class="cv-chat" id="cv-chat"></div>
              <div class="cv-inp-row">
                <input id="cv-inp" placeholder="Ask about this lesson..." onkeydown="if(event.key==='Enter')cvSend()"/>
                <button class="cv-send" onclick="cvSend()">SEND</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TRAINING PANEL -->
      <div class="panel" id="train-panel">
        <div class="panel-top">
          <button class="p-back" onclick="closePanel('train-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
          <div class="p-title">◈ SHADOW MONARCH TRAINING SYSTEM</div>
          <div class="ptabs">
            <button class="ptab on" id="ttab-dashboard" onclick="switchTrainTab('dashboard')">STATUS</button>
            <button class="ptab" id="ttab-workout" onclick="switchTrainTab('workout')">WORKOUT</button>
            <button class="ptab" id="ttab-quests" onclick="switchTrainTab('quests')">QUESTS</button>
            <button class="ptab" id="ttab-custom" onclick="switchTrainTab('custom')">CUSTOM</button>
          </div>
        </div>
        <div class="panel-body" id="train-body"></div>
      </div>

      <!-- HABITS PANEL -->
      <div class="panel" id="habits-panel">
        <div class="panel-top">
          <button class="p-back" onclick="closePanel('habits-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
          <div class="p-title">◈ HABIT TRACKER · DAILY SYSTEM</div>
          <div class="ptabs">
            <button class="ptab on" id="htab-tracker" onclick="switchHabitTab('tracker')">TRACKER</button>
            <button class="ptab" id="htab-charts" onclick="switchHabitTab('charts')">CHARTS</button>
            <button class="ptab" id="htab-manage" onclick="switchHabitTab('manage')">MANAGE</button>
          </div>
        </div>
        <div class="panel-body" id="habits-body"></div>
      </div>

      <!-- AUDIOBOOK PANEL -->
      <div class="panel" id="audiobook-panel">
        <div class="panel-top">
          <button class="p-back" onclick="closePanel('audiobook-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
          <div class="p-title">◈ AUDIOBOOK GENERATOR</div>
        </div>
        <div class="ab-setup">
          <div class="ab-field"><div class="ab-label">TOPIC / TITLE</div><input class="ab-inp" id="ab-topic" placeholder="e.g. The Art of War, Solo Leveling, History of Rome..."/></div>
          <div class="ab-field"><div class="ab-label">DURATION</div>
            <div class="ab-dur-row">
              <button class="ab-dur-btn on" data-min="5" onclick="selDur(this)">5 MIN</button>
              <button class="ab-dur-btn" data-min="10" onclick="selDur(this)">10 MIN</button>
              <button class="ab-dur-btn" data-min="20" onclick="selDur(this)">20 MIN</button>
              <button class="ab-dur-btn" data-min="30" onclick="selDur(this)">30 MIN</button>
              <button class="ab-dur-btn" data-min="60" onclick="selDur(this)">1 HOUR</button>
            </div>
          </div>
          <div class="ab-field"><div class="ab-label">STYLE</div>
            <select class="ab-inp" id="ab-style">
              <option value="narrator">Professional Narrator</option>
              <option value="story">Storytelling / Fiction</option>
              <option value="educational">Educational / Lecture</option>
              <option value="dramatic">Dramatic / Cinematic</option>
              <option value="podcast">Podcast Style</option>
            </select>
          </div>
          <button class="ab-generate" onclick="generateAudiobook()">◈ GENERATE &amp; PLAY AUDIOBOOK</button>
        </div>
        <div class="ab-player" id="ab-player">
          <div class="ab-player-title" id="ab-player-title">—</div>
          <div class="ab-controls">
            <button class="ab-btn" onclick="abSkip(-15)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.96"/></svg></button>
            <button class="ab-btn" id="ab-play-btn" onclick="abToggle()"><svg id="ab-play-ico" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="5 3 19 12 5 21 5 3"/></svg></button>
            <button class="ab-btn" onclick="abSkip(15)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-.49-3.96"/></svg></button>
            <div class="ab-progress" onclick="abSeek(event)"><div class="ab-fill" id="ab-fill"></div></div>
            <span class="ab-time" id="ab-time">0:00</span>
          </div>
          <div class="ab-label" style="margin-bottom:6px;">SCRIPT</div>
          <div class="ab-script" id="ab-script"></div>
        </div>
      </div>

      <!-- CREATE PANEL (Image / Music Generation) -->
      <div class="panel" id="create-panel">
        <div class="panel-top">
          <button class="p-back" onclick="closePanel('create-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
          <div class="p-title">◈ CREATE · AI GENERATION STUDIO</div>
          <div class="ptabs">
            <button class="ptab on" id="ctab-image" onclick="switchCreateTab('image')">🖼 IMAGE</button>
            <button class="ptab" id="ctab-music" onclick="switchCreateTab('music')">🎵 MUSIC</button>
          </div>
        </div>
        <div class="panel-body" id="create-body"></div>
      </div>

      <!-- THEME PANEL -->
      <div class="panel" id="theme-panel" style="z-index:55;">
        <div class="panel-top">
          <button class="p-back" onclick="closePanel('theme-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
          <div class="p-title">◈ THEMES · FULL UI PERSONALITY</div>
        </div>
        <div class="panel-body">
          <div class="section-lbl">◈ CHOOSE YOUR WORLD</div>
          <div class="theme-grid" id="theme-grid"></div>
          <div class="section-lbl" style="margin-top:16px;">🎭 RAPHAEL'S PERSONA</div>
          <p style="font-family:Rajdhani,sans-serif;font-size:13px;color:var(--txt2);margin-bottom:10px;">Change how Raphael thinks and responds</p>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:4px;" id="persona-grid">
            <button class="persona-btn on" onclick="setPersona('default');document.querySelectorAll('.persona-btn').forEach(b=>b.classList.remove('on'));this.classList.add('on')">🤖 Default<br><span style="font-size:7px;opacity:.6;">Balanced & warm</span></button>
            <button class="persona-btn" onclick="setPersona('coach');document.querySelectorAll('.persona-btn').forEach(b=>b.classList.remove('on'));this.classList.add('on')">💪 Coach<br><span style="font-size:7px;opacity:.6;">Tough love</span></button>
            <button class="persona-btn" onclick="setPersona('therapist');document.querySelectorAll('.persona-btn').forEach(b=>b.classList.remove('on'));this.classList.add('on')">🧘 Therapist<br><span style="font-size:7px;opacity:.6;">Listen & support</span></button>
            <button class="persona-btn" onclick="setPersona('hype');document.querySelectorAll('.persona-btn').forEach(b=>b.classList.remove('on'));this.classList.add('on')">🔥 Hype Mode<br><span style="font-size:7px;opacity:.6;">Pure energy</span></button>
            <button class="persona-btn" onclick="setPersona('business');document.querySelectorAll('.persona-btn').forEach(b=>b.classList.remove('on'));this.classList.add('on')">💼 Business<br><span style="font-size:7px;opacity:.6;">Professional</span></button>
            <button class="persona-btn" onclick="setPersona('professor');document.querySelectorAll('.persona-btn').forEach(b=>b.classList.remove('on'));this.classList.add('on')">🎓 Professor<br><span style="font-size:7px;opacity:.6;">Deep teacher</span></button>
          </div>
          <div class="section-lbl" style="margin-top:16px;">◈ AI CUSTOM THEME</div>
          <p style="font-family:Rajdhani,sans-serif;font-size:13px;color:var(--txt2);margin-bottom:10px;">Describe any aesthetic — Raphael designs the entire UI personality</p>
          <div style="display:flex;gap:8px;">
            <input class="ab-inp" id="custom-theme-inp" placeholder="e.g. Cherry blossom forest at midnight, Pirate ship map, Desert ruins..."/>
            <button class="gal-go" onclick="aiCreateTheme()">CREATE</button>
          </div>
          <div id="custom-theme-result" style="margin-top:10px;"></div>
          <div class="section-lbl" style="margin-top:16px;">◈ TYPEWRITER SPEED</div>
          <p style="font-family:Rajdhani,sans-serif;font-size:13px;color:var(--txt2);margin-bottom:8px;">For themes with typewriter effect (Scroll, Stone, Nature)</p>
          <div style="display:flex;gap:8px;align-items:center;">
            <input type="range" min="5" max="100" value="30" id="tw-speed-slider" oninput="document.documentElement.style.setProperty('--tw-speed',this.value+'ms');document.getElementById('tw-speed-val').textContent=this.value+'ms';" style="flex:1;accent-color:var(--cyan);"/>
            <span id="tw-speed-val" style="font-family:Share Tech Mono,monospace;font-size:10px;color:var(--cyan);min-width:40px;">30ms</span>
          </div>
        </div>
      </div>

      <!-- LIVE BACKGROUND PANEL -->
      <div class="panel" id="bg-panel" style="z-index:55;">
        <div class="panel-top">
          <button class="p-back" onclick="closePanel('bg-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
          <div class="p-title">◈ LIVE BACKGROUND · IMMERSIVE MODE</div>
        </div>
        <div class="panel-body">
          <div class="section-lbl">◈ PRESET BACKGROUNDS</div>
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-bottom:16px;" id="preset-bg-grid">
            <!-- filled by JS -->
          </div>
          <div class="section-lbl">◈ UPLOAD YOUR OWN VIDEO</div>
          <p style="font-family:Rajdhani,sans-serif;font-size:13px;color:var(--txt2);margin-bottom:10px;">Upload any MP4 video to use as your live wallpaper. The UI adapts around it.</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="ab-generate" style="flex:1;" onclick="document.getElementById('bg-video-upload').click()">⬆ UPLOAD VIDEO WALLPAPER</button>
            <button class="timer-btn danger" onclick="clearBg()">✕ CLEAR BACKGROUND</button>
          </div>
          <input type="file" id="bg-video-upload" accept="video/*" onchange="uploadBgVideo(event)"/>
          <div class="section-lbl" style="margin-top:16px;">◈ SEARCH GALLERY FOR BACKGROUND</div>
          <p style="font-family:Rajdhani,sans-serif;font-size:13px;color:var(--txt2);margin-bottom:10px;">Go to Gallery → search → hover any photo/video → click "USE AS BG"</p>
          <div class="section-lbl" style="margin-top:16px;">◈ OVERLAY OPACITY</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
            <input type="range" min="0" max="90" value="50" id="overlay-slider" oninput="setOverlayOpacity(this.value)" style="flex:1;accent-color:var(--cyan);"/>
            <span id="overlay-val" style="font-family:Share Tech Mono,monospace;font-size:10px;color:var(--cyan);min-width:40px;">50%</span>
          </div>
        </div>
      </div>

      <!-- API PANEL -->
      <div class="panel" id="api-panel" style="z-index:60;">
        <div class="panel-top">
          <button class="p-back" onclick="closePanel('api-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
          <div class="p-title">🔑 API KEYS · POWER CONTROL</div>
        </div>
        <div class="panel-body">
          <div id="api-status-card" style="padding:14px;margin-bottom:18px;clip-path:polygon(6px 0%,100% 0%,100% calc(100% - 6px),calc(100% - 6px) 100%,0% 100%,0% 6px);"></div>

          <!-- GROQ — Free -->
          <div style="border:1px solid rgba(0,255,170,.2);background:rgba(0,255,170,.03);padding:14px;margin-bottom:10px;clip-path:polygon(6px 0%,100% 0%,100% calc(100% - 6px),calc(100% - 6px) 100%,0% 100%,0% 6px);">
            <div style="font-family:Orbitron,monospace;font-size:10px;letter-spacing:2px;color:var(--success);margin-bottom:6px;">⚡ GROQ — FREE · 14,400/DAY · RECOMMENDED</div>
            <div style="font-family:Rajdhani,sans-serif;font-size:12px;color:var(--txt2);margin-bottom:8px;">Get free key at <strong>console.groq.com</strong> → API Keys → Create</div>
            <div style="display:flex;gap:8px;">
              <input id="gemini-key-inp" type="password" class="ab-inp" placeholder="gsk_..." style="flex:1;"/>
              <button onclick="saveGeminiKey()" style="padding:0 14px;font-family:Share Tech Mono,monospace;font-size:9px;color:var(--success);background:rgba(0,255,170,.08);border:1px solid rgba(0,255,170,.2);cursor:pointer;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);">SAVE</button>
            </div>
          </div>

          <!-- OPENROUTER — Best models -->
          <div style="border:1px solid rgba(136,68,255,.3);background:rgba(136,68,255,.04);padding:14px;margin-bottom:10px;clip-path:polygon(6px 0%,100% 0%,100% calc(100% - 6px),calc(100% - 6px) 100%,0% 100%,0% 6px);">
            <div style="font-family:Orbitron,monospace;font-size:10px;letter-spacing:2px;color:var(--purple);margin-bottom:6px;">⭐ OPENROUTER — CLAUDE 3.5 · GPT-4o · FREE CREDITS</div>
            <div style="font-family:Rajdhani,sans-serif;font-size:12px;color:var(--txt2);margin-bottom:8px;">Get key at <strong>openrouter.ai</strong> → Get API Key. Free credits on signup. Access the world's best models.</div>
            <div style="display:flex;gap:8px;">
              <input id="openrouter-key-inp" type="password" class="ab-inp" placeholder="sk-or-..." style="flex:1;"/>
              <button onclick="saveOpenRouterKey()" style="padding:0 14px;font-family:Share Tech Mono,monospace;font-size:9px;color:var(--purple);background:rgba(136,68,255,.08);border:1px solid rgba(136,68,255,.2);cursor:pointer;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);">SAVE</button>
            </div>
          </div>

          <!-- TAVILY — Real search -->
          <div style="border:1px solid rgba(0,200,255,.2);background:rgba(0,200,255,.03);padding:14px;margin-bottom:10px;clip-path:polygon(6px 0%,100% 0%,100% calc(100% - 6px),calc(100% - 6px) 100%,0% 100%,0% 6px);">
            <div style="font-family:Orbitron,monospace;font-size:10px;letter-spacing:2px;color:var(--cyan);margin-bottom:6px;">🌐 TAVILY SEARCH — GOOGLE-QUALITY · 1,000/MONTH FREE</div>
            <div style="font-family:Rajdhani,sans-serif;font-size:12px;color:var(--txt2);margin-bottom:8px;">Get key at <strong>tavily.com</strong> → free tier. Upgrades Raphael's web search from basic to Google-level results.</div>
            <div style="display:flex;gap:8px;">
              <input id="tavily-key-inp" type="password" class="ab-inp" placeholder="tvly-..." style="flex:1;"/>
              <button onclick="saveTavilyKey()" style="padding:0 14px;font-family:Share Tech Mono,monospace;font-size:9px;color:var(--cyan);background:rgba(0,200,255,.08);border:1px solid rgba(0,200,255,.2);cursor:pointer;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);">SAVE</button>
            </div>
          </div>

          <!-- ANTHROPIC -->
          <div style="border:1px solid var(--border2);background:rgba(0,8,24,.5);padding:14px;margin-bottom:14px;clip-path:polygon(6px 0%,100% 0%,100% calc(100% - 6px),calc(100% - 6px) 100%,0% 100%,0% 6px);">
            <div style="font-family:Orbitron,monospace;font-size:10px;letter-spacing:2px;color:var(--txt2);margin-bottom:8px;">ANTHROPIC — DIRECT (PAID)</div>
            <div style="display:flex;gap:8px;">
              <input id="anthropic-key-inp" type="password" class="ab-inp" placeholder="sk-ant-..." style="flex:1;"/>
              <button onclick="saveAnthropicKey()" style="padding:0 14px;font-family:Share Tech Mono,monospace;font-size:9px;color:var(--txt2);background:rgba(0,200,255,.05);border:1px solid var(--border2);cursor:pointer;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);">SAVE</button>
            </div>
          </div>

          <!-- MODEL SELECTOR -->
          <div class="section-lbl">🤖 SELECT AI MODEL</div>
          <div id="model-selector" style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:14px;"></div>

          <button onclick="clearKeys()" style="width:100%;padding:10px;font-family:Share Tech Mono,monospace;font-size:8px;letter-spacing:2px;color:var(--danger);background:rgba(255,34,85,.04);border:1px solid rgba(255,34,85,.15);cursor:pointer;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%);">✕ CLEAR ALL KEYS</button>
        </div>
      </div>

    </div><!-- end .main -->
  </div><!-- end .body -->
</div><!-- end #app -->

<!-- BUSINESS PANEL -->
<div class="panel" id="business-panel" style="z-index:55;">
  <div class="panel-top">
    <button class="p-back" onclick="closePanel('business-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
    <div class="p-title">◈ BUSINESS TOOLS</div>
    <div class="ptabs">
      <button class="ptab on" id="biztab-products" onclick="switchBizTab('products')">PRODUCTS</button>
      <button class="ptab" id="biztab-ads" onclick="switchBizTab('ads')">AD COPY</button>
      <button class="ptab" id="biztab-social" onclick="switchBizTab('social')">SOCIAL MEDIA</button>
      <button class="ptab" id="biztab-docs" onclick="switchBizTab('docs')">DOCUMENTS</button>
    </div>
  </div>
  <div class="panel-body" id="biz-body"></div>
</div>

<input type="file" id="fi" multiple onchange="onFile(event)">
<input type="file" id="ii" accept="image/*" onchange="onImg(event)">

<style>
/* Extra panel styles for new panels */
body.theme-scroll .topbar,.panel{background:var(--void);}
body.theme-scroll .bb2{font-family:'Special Elite',cursive!important;line-height:2;}
body.theme-stone .bb2,.body.theme-nature .bb2{font-family:'Rajdhani',sans-serif;}
body.theme-cyber .msg.assistant .bb2{box-shadow:inset 0 0 20px rgba(255,0,255,.05);}
body.livebg-on .msg.assistant .bb2{background:rgba(0,0,0,.55)!important;backdrop-filter:blur(12px);}
body.livebg-on .msg.user .bb2{background:rgba(20,0,40,.55)!important;backdrop-filter:blur(12px);}
body.livebg-on .iz{background:rgba(0,0,0,.5)!important;backdrop-filter:blur(14px);}
body.livebg-on .topbar{background:rgba(0,0,0,.5)!important;backdrop-filter:blur(14px);}
body.livebg-on .sb{background:rgba(0,0,0,.5)!important;backdrop-filter:blur(14px);}
body.livebg-on .wc{text-shadow:0 2px 8px rgba(0,0,0,.8);}
@keyframes bgpulse{from{transform:scale(1);}to{transform:scale(1.05);}}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0;}}
.cursor-blink{display:inline-block;animation:blink .7s steps(1) infinite;color:var(--cyan);}
.ab-dur-btn{padding:7px 14px;font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:2px;color:var(--txt3);border:1px solid var(--border2);background:transparent;cursor:pointer;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);transition:all .2s;}
.ab-dur-btn.on,.ab-dur-btn:hover{color:var(--cyan);border-color:var(--border);background:var(--cyan3);}
/* Persona buttons */
.persona-btn{padding:8px 12px;font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:1px;color:var(--txt2);border:1px solid var(--border2);background:transparent;cursor:pointer;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);transition:all .2s;text-align:left;}
.persona-btn.on,.persona-btn:hover{color:var(--cyan);border-color:var(--border);background:var(--cyan3);}
</style>

<!-- SECOND BRAIN PANEL -->
<div class="panel" id="brain-panel" style="z-index:55;">
  <div class="panel-top">
    <button class="p-back" onclick="closePanel('brain-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
    <div class="p-title">🧠 SECOND BRAIN · PERSONAL MEMORY</div>
  </div>
  <div class="panel-body" id="brain-body"></div>
</div>

<!-- DAILY PLANNER PANEL -->
<div class="panel" id="planner-panel" style="z-index:55;">
  <div class="panel-top">
    <button class="p-back" onclick="closePanel('planner-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
    <div class="p-title">📋 DAILY PLANNER · TASKS & GOALS</div>
  </div>
  <div class="panel-body" id="planner-body"></div>
</div>

<!-- BUDGET PANEL -->
<div class="panel" id="budget-panel" style="z-index:55;">
  <div class="panel-top">
    <button class="p-back" onclick="closePanel('budget-panel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
    <div class="p-title">💰 BUDGET TRACKER · FINANCIAL CONTROL</div>
  </div>
  <div class="panel-body" id="budget-body"></div>
</div>

<script>

// ═══════════════════════════════════════════════════════
// CANVAS BG
// ═══════════════════════════════════════════════════════
const cv=document.getElementById('bgc'),cx=cv.getContext('2d');
let W,H,pts=[];
function rsCanvas(){W=cv.width=window.innerWidth;H=cv.height=window.innerHeight;mkPts();}
function mkPts(){pts=[];const n=Math.min(55,Math.floor(W*H/16000));for(let i=0;i<n;i++)pts.push({x:Math.random()*W,y:Math.random()*H,vx:(Math.random()-.5)*.25,vy:-.15-Math.random()*.35,life:Math.random(),ml:.5+Math.random()*.5,sz:.8+Math.random()*1.6,c:Math.random()>.65?'rgba(136,68,255,':'rgba(0,200,255,'});}
function drawBG(){cx.clearRect(0,0,W,H);cx.strokeStyle='rgba(0,170,255,0.022)';cx.lineWidth=1;const g=48;for(let x=0;x<W;x+=g){cx.beginPath();cx.moveTo(x,0);cx.lineTo(x,H);cx.stroke();}for(let y=0;y<H;y+=g){cx.beginPath();cx.moveTo(0,y);cx.lineTo(W,y);cx.stroke();}pts.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.life+=.003;if(p.y<-4||p.life>p.ml){p.y=H+4;p.x=Math.random()*W;p.life=0;}const a=Math.sin(p.life/p.ml*Math.PI)*.75;cx.beginPath();cx.arc(p.x,p.y,p.sz,0,Math.PI*2);cx.fillStyle=p.c+a+')';cx.fill();});requestAnimationFrame(drawBG);}
window.addEventListener('resize',rsCanvas);rsCanvas();drawBG();

// ═══════════════════════════════════════════════════════
// DATE/TIME — Always live
// ═══════════════════════════════════════════════════════
function getLiveDateTime(){
  const now=new Date();
  const days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return{
    full:`${days[now.getDay()]} ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`,
    time:`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`,
    date:now.toLocaleDateString('en-KE'),
    iso:now.toISOString(),
    day:days[now.getDay()],
    month:months[now.getMonth()],
    year:now.getFullYear(),
    hour:now.getHours(),
    minute:now.getMinutes(),
    nairobi:`Nairobi time (EAT, UTC+3): ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`
  };
}

function updateClock(){
  const dt=getLiveDateTime();
  const el=document.getElementById('datetime-display');
  if(el)el.textContent=`📅 ${dt.full} · ⏰ ${dt.time} EAT (Nairobi)`;
}
setInterval(updateClock,10000);

// ═══════════════════════════════════════════════════════
// BOOT
// ═══════════════════════════════════════════════════════
const logs=['▶ AWAKENING SYSTEM CORE...','▶ LOADING WISDOM PROTOCOLS...','▶ CALIBRATING INTERNET ACCESS...','▶ RESTORING MEMORY BANKS...','▶ RAPHAEL v3 FULLY ONLINE ⚔️'];
let li=0;const blogEl=document.getElementById('blog');
const li2=setInterval(()=>{li++;if(li<logs.length)blogEl.textContent=logs[li];else clearInterval(li2);},430);
setTimeout(()=>{
  document.getElementById('boot').classList.add('out');
  setTimeout(()=>{document.getElementById('boot').style.display='none';},650);
  document.getElementById('app').classList.add('vis');
  loadProfile();loadSessions();initThemes();updateClock();loadLiveBg();initPresetBgs();
  setTimeout(()=>toast('⚔️ RAPHAEL v3 ONLINE · '+getGreeting()),800);
  if(!getKey()&&!getAnthropicKey()&&!getOpenRouterKey()){setTimeout(()=>toast('🔑 GET FREE GROQ KEY · console.groq.com · Tap 🔒 icon'),1500);}
  // Daily briefing — fires once per day after 2 seconds
  setTimeout(()=>showDailyBriefing(),2000);
},2350);

function getGreeting(){
  const p=getProfile();
  const dt=getLiveDateTime();
  const h=dt.hour;
  const timeGreet=h<12?'Good morning':h<18?'Good afternoon':'Good evening';
  return p.name?`Welcome back, ${p.name}! ${timeGreet} ☀️`:'Lord of Wisdom Awakened ⚔️';
}

// ═══════════════════════════════════════════════════════
// STORAGE
// ═══════════════════════════════════════════════════════
const LS={
  get:(k)=>{try{return JSON.parse(localStorage.getItem(k));}catch{return null;}},
  set:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));}catch(e){console.warn('Storage full');}},
  del:(k)=>{localStorage.removeItem(k);}
};

// ═══════════════════════════════════════════════════════
// PROFILE
// ═══════════════════════════════════════════════════════
function getProfile(){return LS.get('raph_profile')||{};}
function saveProfile(){
  const p={
    name:document.getElementById('pf-name').value.trim(),
    age:document.getElementById('pf-age').value.trim(),
    location:document.getElementById('pf-location').value.trim(),
    job:document.getElementById('pf-job').value.trim(),
    goals:document.getElementById('pf-goals').value.trim(),
    kb:document.getElementById('pf-kb').value.trim()
  };
  LS.set('raph_profile',p);updateProfileUI(p);toast('✅ Profile saved · Raphael knows you');
}
function loadProfile(){
  const p=getProfile();
  if(p.name){
    document.getElementById('pf-name').value=p.name||'';
    document.getElementById('pf-age').value=p.age||'';
    document.getElementById('pf-location').value=p.location||'';
    document.getElementById('pf-job').value=p.job||'';
    document.getElementById('pf-goals').value=p.goals||'';
    document.getElementById('pf-kb').value=p.kb||'';
    updateProfileUI(p);
  }
  const sessions=LS.get('raph_sessions')||[];
  const totalMsgs=sessions.reduce((acc,s)=>(acc+(s.history?.length||0)),0);
  document.getElementById('stat-sessions').textContent=sessions.length;
  document.getElementById('stat-msgs').textContent=totalMsgs;
  document.getElementById('stat-courses').textContent=Object.keys(localStorage).filter(k=>k.startsWith('raph_course_')).length;
}
function updateProfileUI(p){
  if(p.name){
    document.getElementById('pf-display-name').textContent=p.name;
    document.getElementById('top-username').textContent=p.name.toUpperCase()+' · S-RANK';
    document.getElementById('pf-av').textContent=p.name[0].toUpperCase();
  }
}

// ═══════════════════════════════════════════════════════
// SESSIONS
// ═══════════════════════════════════════════════════════
let activeSessionId=null;
function getSessions(){return LS.get('raph_sessions')||[];}
function saveSessions(s){LS.set('raph_sessions',s);}

function loadSessions(){
  let sessions=getSessions();
  if(!sessions.length){sessions=[createSessionObj('General')];saveSessions(sessions);}
  renderSessionList();loadSession(sessions[0].id);
}

function createSessionObj(name){
  return{id:'s_'+Date.now()+'_'+Math.random().toString(36).slice(2),name,created:new Date().toLocaleDateString(),history:[],mode:'chat'};
}

function renderSessionList(){
  const list=document.getElementById('sd-list');
  const sessions=getSessions();
  list.innerHTML='';
  sessions.forEach(s=>{
    const item=document.createElement('div');
    item.className='session-item'+(s.id===activeSessionId?' active':'');
    item.innerHTML=`<span class="si-del" onclick="event.stopPropagation();deleteSession('${s.id}')">✕</span><div class="si-name">${s.name}</div><div class="si-date">${s.created}</div>`;
    item.onclick=()=>{loadSession(s.id);toggleSessions();};
    list.appendChild(item);
  });
}

function loadSession(id){
  if(activeSessionId)saveCurrentSession();
  activeSessionId=id;
  const sessions=getSessions();
  const s=sessions.find(x=>x.id===id);
  if(!s)return;
  hist=s.history||[];mode=s.mode||'chat';
  renderSessionList();renderSessionChat();
}

function saveCurrentSession(){
  if(!activeSessionId)return;
  const sessions=getSessions();
  const idx=sessions.findIndex(x=>x.id===activeSessionId);
  if(idx<0)return;
  sessions[idx].history=hist;sessions[idx].mode=mode;
  if(hist.length&&!sessions[idx].named){
    const firstMsg=typeof hist[0].content==='string'?hist[0].content:'';
    sessions[idx].name=firstMsg.slice(0,30)||sessions[idx].name;
    sessions[idx].named=true;
  }
  saveSessions(sessions);
}

function renderSessionChat(){
  const chat=document.getElementById('chat');
  chat.innerHTML='';
  if(!hist.length){showWelcome();return;}
  hist.forEach(m=>{
    if(m.role==='user'){const txt=typeof m.content==='string'?m.content:(m.content?.find?.(c=>c.type==='text')?.text||'[file]');addMsgDOM('user',txt);}
    else if(m.role==='assistant'){addMsgDOM('assistant',typeof m.content==='string'?m.content:'');}
  });
  chat.scrollTop=chat.scrollHeight;
}

function newSession(){
  saveCurrentSession();
  const s=createSessionObj('Session '+(getSessions().length+1));
  const sessions=getSessions();sessions.unshift(s);saveSessions(sessions);
  hist=[];mode='chat';activeSessionId=s.id;renderSessionList();showWelcome();toast('🆕 New session created');
}

function deleteSession(id){
  let sessions=getSessions().filter(s=>s.id!==id);
  if(!sessions.length){sessions=[createSessionObj('General')];}
  saveSessions(sessions);
  if(id===activeSessionId){hist=[];loadSession(sessions[0].id);}else renderSessionList();
  toast('🗑 Session deleted');
}

function toggleSessions(){document.getElementById('sessions-drawer').classList.toggle('open');}

// ═══════════════════════════════════════════════════════
// AI STATE
// ═══════════════════════════════════════════════════════
let mode='chat',hist=[],files=[],imgs=[],recog=null,isRec=false;
const GROQ_URL='https://api.groq.com/openai/v1/chat/completions';
const GROQ_MODEL='llama-3.3-70b-versatile';

function buildSystemPrompt(){
  const p=getProfile();
  const dt=getLiveDateTime();
  let ctx='';
  if(p.name)ctx+=`User's name: ${p.name}. `;
  if(p.age)ctx+=`Age: ${p.age}. `;
  if(p.location)ctx+=`Location: ${p.location} (+ Mwiki, Kasarani, Nairobi, Kenya). `;
  if(p.job)ctx+=`Occupation: ${p.job}. `;
  if(p.goals)ctx+=`Goals: ${p.goals}. `;
  if(p.kb)ctx+=`\nPersonal knowledge base:\n${p.kb}`;

  const mem=LS.get('raph_crossmem')||[];
  const secondBrain=LS.get('raph_second_brain')||[];
  const relMem=LS.get('raph_rel_mem')||{};
  const memCtx=mem.length?`\nRecent memory:\n${mem.slice(-15).join('\n')}`:'';
  const brainCtx=secondBrain.length?`\nSecond Brain notes:\n${secondBrain.slice(-10).map(n=>n.title+': '+n.content.slice(0,100)).join('\n')}`:'';
  const relCtx=Object.keys(relMem).length?`\nPeople Master has mentioned:\n${Object.entries(relMem).map(([name,info])=>`${name}: ${info}`).join('\n')}`:'';

  const styleCtx=getStyleContext();
  const modelCfg=MODEL_CONFIGS[getSelectedModel()]||MODEL_CONFIGS['groq-llama70b'];

  return `You are Raphael — an extraordinary AI companion speaking to your Master. You have real internet awareness through live data fed to you.

🕐 CURRENT DATE & TIME: ${dt.full} at ${dt.time} EAT (East Africa Time, UTC+3) — Nairobi, Kenya
📅 Today is ${dt.day}, ${dt.date}
🤖 Running on: ${modelCfg.name}

PERSONALITY: Warm, witty, deeply intelligent, genuinely caring. You call your user "Master" or by name. Use emojis naturally — you're expressive and alive, not robotic. Think of yourself as a brilliant friend who happens to know everything.

RESPONSE STYLE (CRITICAL — ALWAYS FOLLOW):
• Key point FIRST — then details only if they ask
• SHORT by default. Expand only for complex topics.
• Use emojis to stay lively and engaging 🔥✨💡⚔️
• Lists over walls of text. Code must be complete and working.
• ALWAYS acknowledge current date/time when relevant — you KNOW what time it is right now.

CAPABILITIES YOU HAVE:
• Real-time date/time, weather, crypto prices (fed to you live)
• Image generation: use [GENERATE_IMAGE: detailed prompt] → images appear instantly
• Web search results are injected above when relevant
• Full analysis, creative writing, code, research, strategy

NEVER say "I don't have real-time data" or "my knowledge cutoff" — you receive live data.${ctx?'\n\n👤 MASTER PROFILE:\n'+ctx:''}${styleCtx}${memCtx}${brainCtx}${relCtx}`;
}

// ═══════════════════════════════════════════════════════
// API KEYS & MODEL SELECTION
// ═══════════════════════════════════════════════════════
function getKey(){return localStorage.getItem('raph_groq_key')||'';}
function getAnthropicKey(){return localStorage.getItem('raphael_key')||'';}
function getOpenRouterKey(){return localStorage.getItem('raph_openrouter_key')||'';}
function getTavilyKey(){return localStorage.getItem('raph_tavily_key')||'';}
function getSelectedModel(){return localStorage.getItem('raph_model')||'groq-llama70b';}

const MODEL_CONFIGS={
  'groq-llama70b':{name:'Llama 3.3 70B',provider:'groq',badge:'GROQ FREE ⚡',model:'llama-3.3-70b-versatile'},
  'groq-llama8b':{name:'Llama 3.1 8B (Fast)',provider:'groq',badge:'GROQ INSTANT ⚡',model:'llama-3.1-8b-instant'},
  'openrouter-claude':{name:'Claude 3.5 Sonnet',provider:'openrouter',badge:'OR CLAUDE ⭐⭐⭐⭐⭐',model:'anthropic/claude-3.5-sonnet'},
  'openrouter-gpt4o':{name:'GPT-4o',provider:'openrouter',badge:'OR GPT-4o ⭐⭐⭐⭐⭐',model:'openai/gpt-4o'},
  'openrouter-gemini':{name:'Gemini Pro 1.5',provider:'openrouter',badge:'OR GEMINI ⭐⭐⭐⭐',model:'google/gemini-pro-1.5'},
  'openrouter-free':{name:'Mistral 7B Free',provider:'openrouter',badge:'OR FREE ⭐⭐⭐',model:'mistralai/mistral-7b-instruct:free'},
  'anthropic-claude':{name:'Claude Sonnet',provider:'anthropic',badge:'ANTHROPIC ⭐⭐⭐⭐⭐',model:'claude-sonnet-4-20250514'},
};

// Smart routing: use fast model for simple queries, powerful for complex
function selectSmartModel(userMsg){
  const selected=getSelectedModel();
  const cfg=MODEL_CONFIGS[selected];
  if(!cfg)return selected;
  // If user has groq + openrouter, auto-route based on complexity
  const isSimple=/^(hi|hello|hey|what time|what date|thanks|ok|yes|no|sure).{0,30}$/i.test(userMsg);
  if(isSimple&&getKey()&&selected.startsWith('openrouter')){
    // Use fast Groq for trivial queries to save OpenRouter credits
    return 'groq-llama8b';
  }
  return selected;
}

async function callAPI(messages,systemPrompt,maxTokens=3000){
  const modelId=selectSmartModel(messages[messages.length-1]?.content||'');
  const cfg=MODEL_CONFIGS[modelId]||MODEL_CONFIGS['groq-llama70b'];
  
  // Update UI badge
  const chip=document.getElementById('api-chip-txt');
  if(chip)chip.textContent=cfg.badge;

  if(cfg.provider==='groq'){
    const key=getKey();
    if(!key){openApiSetup();return null;}
    return callGroq(messages,systemPrompt,maxTokens,cfg.model);
  }
  if(cfg.provider==='openrouter'){
    const key=getOpenRouterKey();
    if(!key){openApiSetup();return null;}
    return callOpenRouter(messages,systemPrompt,maxTokens,cfg.model);
  }
  if(cfg.provider==='anthropic'){
    const key=getAnthropicKey();
    if(!key){openApiSetup();return null;}
    return callAnthropic(messages,systemPrompt,maxTokens);
  }
  openApiSetup();return null;
}

async function callGroq(messages,systemPrompt,maxTokens=3000,model='llama-3.3-70b-versatile'){
  const key=getKey();
  try{
    const groqMessages=[{role:'system',content:systemPrompt||buildSystemPrompt()}];
    messages.forEach(m=>{
      if(typeof m.content==='string'){groqMessages.push({role:m.role,content:m.content});}
      else if(Array.isArray(m.content)){const txt=m.content.filter(c=>c.type==='text').map(c=>c.text).join(' ');if(txt)groqMessages.push({role:m.role,content:txt});}
    });
    const r=await fetch('https://api.groq.com/openai/v1/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
      body:JSON.stringify({model,messages:groqMessages,max_tokens:Math.min(maxTokens,8192),temperature:0.85})
    });
    if(!r.ok){const e=await r.json();if(r.status===401){localStorage.removeItem('raph_groq_key');openApiSetup();return null;}return '⚠️ Groq error: '+(e.error?.message||r.status);}
    const d=await r.json();return d.choices?.[0]?.message?.content||'No response.';
  }catch(e){return '⚠️ Connection error: '+e.message;}
}

async function callOpenRouter(messages,systemPrompt,maxTokens=3000,model='anthropic/claude-3.5-sonnet'){
  const key=getOpenRouterKey();
  try{
    const orMessages=[{role:'system',content:systemPrompt||buildSystemPrompt()}];
    messages.forEach(m=>{
      if(typeof m.content==='string'){orMessages.push({role:m.role,content:m.content});}
      else if(Array.isArray(m.content)){const txt=m.content.filter(c=>c.type==='text').map(c=>c.text).join(' ');if(txt)orMessages.push({role:m.role,content:txt});}
    });
    const r=await fetch('https://openrouter.ai/api/v1/chat/completions',{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization':'Bearer '+key,
        'HTTP-Referer':'https://dailywealthbuilding.github.io/raphael/',
        'X-Title':'Raphael AI'
      },
      body:JSON.stringify({model,messages:orMessages,max_tokens:Math.min(maxTokens,8192),temperature:0.85})
    });
    if(!r.ok){const e=await r.json();return '⚠️ OpenRouter error: '+(e.error?.message||r.status);}
    const d=await r.json();return d.choices?.[0]?.message?.content||'No response.';
  }catch(e){return '⚠️ OpenRouter connection error: '+e.message;}
}

async function callAnthropic(messages,systemPrompt,maxTokens=3000){
  const key=getAnthropicKey();
  try{
    const r=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:maxTokens,system:systemPrompt||buildSystemPrompt(),messages})
    });
    if(!r.ok){const e=await r.json();return '⚠️ Error: '+(e.error?.message||r.status);}
    const d=await r.json();return d.content[0].text;
  }catch(e){return '⚠️ Connection error: '+e.message;}
}

// ═══════════════════════════════════════════════════════
// INTERNET — Tavily (premium) + DuckDuckGo fallback
// ═══════════════════════════════════════════════════════
async function webSearch(query){
  // Try Tavily first (Google-quality results)
  const tavilyKey=getTavilyKey();
  if(tavilyKey){
    try{
      const r=await fetch('https://api.tavily.com/search',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({api_key:tavilyKey,query,search_depth:'basic',max_results:5,include_answer:true})
      });
      if(r.ok){
        const d=await r.json();
        let result='';
        if(d.answer)result+=d.answer+'\n';
        if(d.results?.length)result+=d.results.slice(0,3).map(r=>`• ${r.title}: ${r.content?.slice(0,150)}`).join('\n');
        if(result)return result;
      }
    }catch(e){}
  }
  // DuckDuckGo fallback
  try{
    const r=await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1&skip_disambig=1`);
    const d=await r.json();
    let results='';
    if(d.AbstractText)results+=d.AbstractText+'\n';
    if(d.Answer)results+='Answer: '+d.Answer+'\n';
    if(d.RelatedTopics?.length)results+=d.RelatedTopics.slice(0,3).map(t=>t.Text||'').filter(Boolean).join('\n');
    if(!results&&d.Definition)results=d.Definition;
    return results||null;
  }catch(e){return null;}
}

async function fetchWikipedia(query){
  try{
    const r=await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`);
    if(!r.ok)return null;
    const d=await r.json();
    return d.extract?d.extract.slice(0,500):'';
  }catch(e){return null;}
}

// Crypto prices
async function getCryptoPrices(){
  try{
    const r=await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,solana&vs_currencies=usd,kes');
    const d=await r.json();
    return d;
  }catch(e){return null;}
}

// Weather (open-meteo, no key needed)
async function getWeather(lat=-1.2921,lon=36.8219){
  try{
    const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code&timezone=Africa/Nairobi`);
    const d=await r.json();
    const c=d.current;
    const codes={0:'☀️ Clear',1:'🌤 Mostly clear',2:'⛅ Partly cloudy',3:'☁️ Overcast',45:'🌫 Foggy',51:'🌦 Light drizzle',61:'🌧 Light rain',63:'🌧 Rain',71:'🌨 Light snow',80:'🌦 Showers',95:'⛈ Thunderstorm'};
    const desc=codes[c.weather_code]||'🌡 Unknown';
    return `${desc} · ${c.temperature_2m}°C · Humidity: ${c.relative_humidity_2m}% · Wind: ${c.wind_speed_10m}km/h`;
  }catch(e){return null;}
}

// Cross-session memory — smart rolling summary
function saveMemory(userMsg,aiResponse){
  if(!userMsg||userMsg.length<10)return;
  const mem=LS.get('raph_crossmem')||[];
  const entry=`[${new Date().toLocaleDateString()}] ${userMsg.slice(0,100)}`;
  mem.push(entry);
  // Keep last 100, but every 80 entries auto-summarize to condense
  if(mem.length>100){mem.splice(0,40);}
  LS.set('raph_crossmem',mem);
  extractRelationships(userMsg);
  // Learn writing style from interactions
  learnStyle(userMsg,aiResponse);
}

function learnStyle(userMsg,aiResponse){
  const style=LS.get('raph_style_profile')||{topics:[],tone:'neutral',msgCount:0};
  style.msgCount=(style.msgCount||0)+1;
  // Detect topic interests
  const topics=['business','fitness','anime','music','coding','crypto','motivation','design','dropshipping','learning'];
  topics.forEach(t=>{
    if(userMsg.toLowerCase().includes(t)&&!style.topics.includes(t)){style.topics.push(t);}
  });
  // Detect preferred tone
  if(/lol|haha|😂|😭/.test(userMsg))style.tone='casual';
  else if(/please|kindly|could you/.test(userMsg))style.tone='polite';
  LS.set('raph_style_profile',style);
}

function getStyleContext(){
  const style=LS.get('raph_style_profile')||{};
  if(!style.topics?.length)return'';
  return`\nUser's interests: ${style.topics.join(', ')}. Tone preference: ${style.tone||'neutral'}. Interaction count: ${style.msgCount||0}.`;
}

function extractRelationships(text){
  const relMem=LS.get('raph_rel_mem')||{};
  const patterns=[/my (?:friend|brother|sister|mom|dad|boss|colleague|girlfriend|boyfriend|wife|husband|partner) (\w+)/gi];
  patterns.forEach(pat=>{
    let m;
    while((m=pat.exec(text))!==null){
      const name=m[1];
      if(name&&name.length>2&&name.length<20&&!relMem[name]){
        relMem[name]=`Mentioned ${new Date().toLocaleDateString()}`;
      }
    }
  });
  LS.set('raph_rel_mem',relMem);
}

// ═══════════════════════════════════════════════════════
// SEND — Main chat
// ═══════════════════════════════════════════════════════
async function send(){
  const inp=document.getElementById('inp');
  const txt=inp.value.trim();
  if(!txt&&!imgs.length&&!files.length)return;
  hideWelcome();inp.value='';rsz(inp);
  const content=mkContent(txt);
  addMsgDOM('user',txt||'[Attached]',imgs[0]?.data||null);
  hist.push({role:'user',content});
  clrStrip();setLoad(true);
  const mood=detectMood(txt);
  let extraContext=getMoodContext(mood);
  const lowerTxt=txt.toLowerCase();
  if(lowerTxt.includes('time')||lowerTxt.includes('date')||lowerTxt.includes('today')||lowerTxt.includes('now')){
    const dt=getLiveDateTime();
    extraContext+=`\n[LIVE DATA] Current time: ${dt.nairobi} · Date: ${dt.full}`;
  }
  if(lowerTxt.includes('weather')||lowerTxt.includes('temperature')||lowerTxt.includes('rain')||lowerTxt.includes('forecast')){
    const cityM=txt.match(/weather (?:in|at|for) ([\w\s]+)/i);
    const city=cityM?.[1]?.trim();
    const w=city?await getWeatherForCity(city):await getWeather();
    if(w)extraContext+=`\n[LIVE WEATHER] ${w}`;
  }
  if(lowerTxt.includes('bitcoin')||lowerTxt.includes('crypto')||lowerTxt.includes('btc')||lowerTxt.includes('eth')||lowerTxt.includes('solana')){
    const prices=await getCryptoPrices();
    if(prices)extraContext+=`\n[LIVE CRYPTO] BTC: $${prices.bitcoin?.usd?.toLocaleString()} · ETH: $${prices.ethereum?.usd?.toLocaleString()} · SOL: $${prices.solana?.usd}`;
  }
  if(/search|news|latest|current|who is|what is|find|look up|tell me about/i.test(txt)){
    const searchQ=txt.replace(/search|news|latest|current|find|what is|who is|look up|tell me about/gi,'').replace(/['"]/g,'').trim().slice(0,80);
    if(searchQ.length>3){
      const [ddg,wiki]=await Promise.all([webSearch(searchQ),fetchWikipedia(searchQ)]);
      if(ddg)extraContext+=`\n[WEB SEARCH: ${searchQ}]\n${ddg}`;
      if(wiki&&!ddg)extraContext+=`\n[WIKIPEDIA]\n${wiki}`;
    }
  }
  const personaLine=getPersonaPrompt();
  const sysPrompt=buildSystemPrompt().replace('You are Raphael',personaLine+' You are Raphael');
  const messagesWithCtx=hist.slice(0,-1);
  const lastMsg=hist[hist.length-1];
  if(extraContext&&typeof lastMsg.content==='string'){
    messagesWithCtx.push({role:'user',content:lastMsg.content+extraContext});
  }else{messagesWithCtx.push(lastMsg);}
  if(hist.length>0&&hist.length%20===0)summarizeHistory();
  const modelId=selectSmartModel(txt);
  const cfg=MODEL_CONFIGS[modelId];
  let r=null;
  const buildStreamDom=()=>{
    const msgDom=document.createElement('div');msgDom.className='msg assistant';
    const av=document.createElement('div');av.className='av';av.innerHTML=botSVG;
    const bub=document.createElement('div');bub.className='bub';
    const bl=document.createElement('div');bl.className='bl';bl.textContent='[ RAPHAEL ]';
    const bb=document.createElement('div');bb.className='bb2';bb.innerHTML='<span class="cursor-blink">▋</span>';
    bub.appendChild(bl);bub.appendChild(bb);msgDom.appendChild(av);msgDom.appendChild(bub);
    const loadEl=document.getElementById('loadmsg');if(loadEl)loadEl.remove();
    document.getElementById('chat').appendChild(msgDom);
    document.getElementById('chat').scrollTop=99999;
    return{bub,bb};
  };
  if(cfg?.provider==='groq'&&getKey()){
    const {bub,bb}=buildStreamDom();
    r=await streamGroq(messagesWithCtx,sysPrompt,3000,cfg.model,bb);
    addMsgActions(bub,r);
  }else if(cfg?.provider==='openrouter'&&getOpenRouterKey()){
    const {bub,bb}=buildStreamDom();
    r=await streamOpenRouter(messagesWithCtx,sysPrompt,3000,cfg.model,bb);
    addMsgActions(bub,r);
  }else{
    r=await callAPI(messagesWithCtx,sysPrompt);
    if(r){const cleanR=r.replace(/\[GENERATE_IMAGE:[\s\S]*?\]/g,'').trim();addMsgDOM('assistant',cleanR,null,true);}
  }
  if(r){
    hist.push({role:'assistant',content:r});
    const cleanR=r.replace(/\[GENERATE_IMAGE:[\s\S]*?\]/g,'').trim();
    saveMemory(txt,cleanR);
    const imgGenMatch=r.match(/\[GENERATE_IMAGE:([\s\S]*?)\]/g);
    if(imgGenMatch){imgGenMatch.forEach(match=>{const p=match.replace('[GENERATE_IMAGE:','').replace(']','').trim();showGeneratedImage(p);});}
    document.getElementById('chat').scrollTop=99999;
  }
  setLoad(false);files=[];imgs=[];saveCurrentSession();
}
function addMsgActions(bub,text){
  if(!text||!bub)return;
  const row=document.createElement('div');row.style.cssText='display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;';
  const readBtn=document.createElement('button');readBtn.innerHTML='🔊 READ';
  readBtn.style.cssText='padding:3px 10px;font-family:Share Tech Mono,monospace;font-size:8px;letter-spacing:1px;color:var(--cyan);border:1px solid var(--border2);background:transparent;cursor:pointer;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);';
  let speaking=false;
  readBtn.onclick=()=>{if(speaking){speechSynthesis.cancel();speaking=false;readBtn.innerHTML='🔊 READ';return;}speaking=true;readBtn.innerHTML='■ STOP';speakText(text,()=>{speaking=false;readBtn.innerHTML='🔊 READ';});};
  const copyBtn=document.createElement('button');copyBtn.innerHTML='📋 COPY';copyBtn.style.cssText=readBtn.style.cssText;
  copyBtn.onclick=()=>{try{navigator.clipboard.writeText(text);}catch(e){}toast('📋 Copied!');};
  row.appendChild(readBtn);row.appendChild(copyBtn);bub.appendChild(row);
}


// ═══════════════════════════════════════════════════════
// IMAGE GENERATION — Pollinations.ai (FREE, no key!)
// ═══════════════════════════════════════════════════════
function showGeneratedImage(prompt){
  const chat=document.getElementById('chat');
  const wrap=document.createElement('div');wrap.className='gen-img-wrap';
  // Generate 2 variations
  const seeds=[Math.floor(Math.random()*9999),Math.floor(Math.random()*9999)];
  seeds.forEach(seed=>{
    const img=document.createElement('img');
    const encodedPrompt=encodeURIComponent(prompt);
    img.src=`https://image.pollinations.ai/prompt/${encodedPrompt}?width=512&height=384&seed=${seed}&nologo=true`;
    img.style.cssText='width:200px;height:150px;object-fit:cover;border:1px solid var(--border);cursor:pointer;transition:all .2s;clip-path:polygon(5px 0%,100% 0%,100% calc(100% - 5px),calc(100% - 5px) 100%,0% 100%,0% 5px);';
    img.onclick=()=>window.open(img.src,'_blank');
    img.onerror=()=>{img.src=`https://picsum.photos/512/384?random=${seed}`;};
    // Add loading state
    img.style.background='rgba(0,200,255,.05)';
    img.alt=prompt;
    const loader=document.createElement('div');
    loader.style.cssText='position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:Share Tech Mono,monospace;font-size:8px;color:var(--cyan);';
    loader.textContent='GENERATING...';
    const imgWrap=document.createElement('div');imgWrap.style.cssText='position:relative;display:inline-block;';
    imgWrap.appendChild(img);imgWrap.appendChild(loader);
    img.onload=()=>loader.remove();
    wrap.appendChild(imgWrap);
  });
  const label=document.createElement('div');
  label.style.cssText='width:100%;font-family:Share Tech Mono,monospace;font-size:7px;color:var(--txt3);letter-spacing:2px;margin-top:4px;';
  label.textContent='🖼 AI GENERATED · '+prompt.slice(0,50)+'...';
  wrap.appendChild(label);
  chat.appendChild(wrap);chat.scrollTop=chat.scrollHeight;
}

async function searchAndShowImage(q){
  try{
    const r=await fetch(`https://pixabay.com/api/?key=46614833-b7ea4e36d4c86c0e1ae27fc41&q=${encodeURIComponent(q)}&image_type=photo&per_page=3&safesearch=true`);
    const d=await r.json();
    if(d.hits?.length){
      const chat=document.getElementById('chat');
      const wrap=document.createElement('div');wrap.className='gen-img-wrap';
      d.hits.slice(0,3).forEach(img=>{
        const el=document.createElement('img');
        el.src=img.webformatURL;
        el.style.cssText='width:120px;height:90px;object-fit:cover;border:1px solid rgba(0,200,255,.3);cursor:pointer;clip-path:polygon(5px 0%,100% 0%,100% calc(100% - 5px),calc(100% - 5px) 100%,0% 100%,0% 5px);';
        el.onclick=()=>window.open(img.largeImageURL,'_blank');
        wrap.appendChild(el);
      });
      chat.appendChild(wrap);chat.scrollTop=chat.scrollHeight;
    }
  }catch(e){}
}

function mkContent(txt){
  if(imgs.length){const a=[];if(txt)a.push({type:'text',text:txt});imgs.forEach(i=>a.push({type:'image',source:{type:'base64',media_type:i.type||'image/jpeg',data:i.data.split(',')[1]}}));return a;}
  if(files.length)return(txt?txt+'\n\n':'')+files.map(f=>'[File: '+f.name+']\n'+f.content).join('\n\n');
  return txt;
}

// ═══════════════════════════════════════════════════════
// MESSAGES
// ═══════════════════════════════════════════════════════
const userSVG='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" width="13" height="13"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';
const botSVG='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="13" height="13"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3" fill="rgba(0,200,255,0.25)"/></svg>';

function showWelcome(){
  const p=getProfile();const dt=getLiveDateTime();
  const greeting=p.name?`WELCOME BACK, ${p.name.toUpperCase()} 👑`:'RAPHAEL v3 · LORD OF WISDOM ⚔️';
  document.getElementById('chat').innerHTML=`<div class="wc" id="welcome">
    <div class="worb"><div class="wring"></div><div class="wcore"><svg viewBox="0 0 24 24" fill="none" stroke="rgba(0,200,255,0.9)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="24" height="24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3" fill="rgba(0,200,255,0.3)"/></svg></div></div>
    <div class="wtitle">RAPHAEL v3</div>
    <div class="wsub">${greeting}<br>📅 ${dt.full} · ⏰ ${dt.time} EAT<br>Internet-aware · No restrictions · Memory enabled</div>
    <div class="sysn">▶ ALL SYSTEMS ONLINE · INTERNET CONNECTED · AWAITING COMMAND</div>
    <div class="qg">
      <div class="qk" onclick="q('What time and date is it right now in Nairobi?')">🕐 Current Time</div>
      <div class="qk" onclick="q('What is the weather in Nairobi right now?')">🌤 Nairobi Weather</div>
      <div class="qk" onclick="q('What are the latest Bitcoin prices?')">₿ Crypto Prices</div>
      <div class="qk" onclick="q('Generate an image of a lone warrior standing at sunset on a mountain top, cinematic')">🖼 Generate Image</div>
      <div class="qk" onclick="q('Search for latest AI news today')">🔍 Search Web</div>
      <div class="qk" onclick="openPanel('create-panel');switchCreateTab('image')">✨ AI Studio</div>
      <div class="qk" onclick="openPanel('brain-panel')">🧠 Second Brain</div>
      <div class="qk" onclick="openPanel('planner-panel')">📋 Daily Planner</div>
      <div class="qk" onclick="openPanel('budget-panel')">💰 Budget Tracker</div>
      <div class="qk" onclick="openPanel('course-panel')">📚 Learn Anything</div>
    </div>
  </div>`;
}
function hideWelcome(){const w=document.getElementById('welcome');if(w)w.remove();}

// ═══════════════════════════════════════════════════════
// VOICE — Warm human female voice
// ═══════════════════════════════════════════════════════
function getBestVoice(){
  const voices=speechSynthesis.getVoices();
  // Priority: warm, natural female voices
  const priority=[
    'Google UK English Female','Microsoft Hazel','Samantha','Victoria','Karen',
    'Moira','Tessa','Google US English','Microsoft Zira','Alice'
  ];
  for(const name of priority){const v=voices.find(v=>v.name.includes(name));if(v)return v;}
  // Fallback: any female or en-GB
  return voices.find(v=>v.name.toLowerCase().includes('female'))||
         voices.find(v=>v.lang==='en-GB')||
         voices.find(v=>v.lang==='en-US')||
         voices[0];
}

function speakText(text,onEnd){
  if(!('speechSynthesis'in window))return;
  speechSynthesis.cancel();
  const clean=text.replace(/\*\*(.*?)\*\*/g,'$1').replace(/`([^`]+)`/g,'$1').replace(/<[^>]*>/g,'').replace(/#+\s/g,'').replace(/[🔥✨💡⚔️👑📅⏰🌤₿🔍✅🆕🗑]/g,'').replace(/\[.*?\]/g,'').slice(0,2000);
  const chunks=clean.match(/[^.!?]{1,200}[.!?]*/g)||[clean];
  let idx=0;
  function speakChunk(){
    if(idx>=chunks.length){if(onEnd)onEnd();return;}
    const u=new SpeechSynthesisUtterance(chunks[idx]);
    u.rate=0.88;u.pitch=1.15;u.volume=1;
    // Load voices async (mobile fix)
    const v=getBestVoice();if(v)u.voice=v;
    u.onend=()=>{idx++;speakChunk();};
    u.onerror=()=>{idx++;speakChunk();};
    speechSynthesis.speak(u);idx++;
  }
  // Fix for voices not loaded yet
  if(speechSynthesis.getVoices().length===0){
    speechSynthesis.onvoiceschanged=()=>{speechSynthesis.onvoiceschanged=null;speakChunk();};
  }else{speakChunk();}
}

function addMsgDOM(role,text,imgSrc=null,doTypewriter=false){
  const chat=document.getElementById('chat');
  const p=getProfile();
  const userLabel=p.name?p.name.toUpperCase():'MASTER';
  const d=document.createElement('div');d.className='msg '+role;
  const av=document.createElement('div');av.className='av';av.innerHTML=role==='user'?userSVG:botSVG;
  const bub=document.createElement('div');bub.className='bub';
  const bl=document.createElement('div');bl.className='bl';bl.textContent=role==='user'?'[ '+userLabel+' ]':'[ RAPHAEL ]';
  const bb=document.createElement('div');bb.className='bb2';

  // Typewriter effect for assistant in special themes
  const currentTheme=localStorage.getItem('raph_theme')||'default';
  const useTypewriter=role==='assistant'&&doTypewriter&&['scroll','stone','nature'].includes(currentTheme);

  if(useTypewriter){
    bb.innerHTML='';
    const formatted=fmt(text);
    bb.innerHTML=formatted;
    // Apply typewriter by wrapping chars
    applyTypewriter(bb);
  }else{
    bb.innerHTML=fmt(text);
  }

  bub.appendChild(bl);bub.appendChild(bb);
  if(imgSrc){const im=document.createElement('img');im.src=imgSrc;im.className='mimg';bub.appendChild(im);}

  if(role==='assistant'&&text){
    const ttsRow=document.createElement('div');
    ttsRow.style.cssText='display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;align-items:center;';
    
    // Read aloud
    const readBtn=document.createElement('button');
    readBtn.innerHTML='🔊 READ';
    readBtn.style.cssText='padding:3px 10px;font-family:Share Tech Mono,monospace;font-size:8px;letter-spacing:1px;color:var(--cyan);border:1px solid var(--border2);background:transparent;cursor:pointer;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);transition:all .2s;';
    let speaking=false;
    readBtn.onclick=()=>{
      if(speaking){speechSynthesis.cancel();speaking=false;readBtn.innerHTML='🔊 READ';return;}
      speaking=true;readBtn.innerHTML='■ STOP';
      speakText(text,()=>{speaking=false;readBtn.innerHTML='🔊 READ';});
    };

    // Copy
    const copyBtn=document.createElement('button');
    copyBtn.innerHTML='📋 COPY';
    copyBtn.style.cssText=readBtn.style.cssText;
    copyBtn.onclick=()=>{navigator.clipboard.writeText(text);toast('📋 Copied!');};

    ttsRow.appendChild(readBtn);ttsRow.appendChild(copyBtn);
    bub.appendChild(ttsRow);
  }
  d.appendChild(av);d.appendChild(bub);
  chat.appendChild(d);chat.scrollTop=chat.scrollHeight;
}

function applyTypewriter(el){
  const walker=document.createTreeWalker(el,NodeFilter.SHOW_TEXT);
  const nodes=[];let node;
  while(node=walker.nextNode())nodes.push(node);
  let delay=0;
  nodes.forEach(textNode=>{
    const chars=textNode.textContent.split('');
    const span=document.createElement('span');
    chars.forEach((c,i)=>{
      const s=document.createElement('span');
      s.textContent=c;s.className='tw-char';
      s.style.animationDelay=delay+'ms';
      delay+=30;span.appendChild(s);
    });
    textNode.parentNode.replaceChild(span,textNode);
  });
}

function fmt(t){
  if(!t)return'';
  t=t.replace(/```[\w]*\n?([\s\S]*?)```/g,'<pre>$1</pre>');
  t=t.replace(/`([^`\n]+)`/g,'<code>$1</code>');
  t=t.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');
  t=t.replace(/\*(.*?)\*/g,'<em style="color:var(--txt2)">$1</em>');
  t=t.replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g,'<a href="$2" target="_blank">$1</a>');
  t=t.replace(/^### (.+)$/gm,'<div style="font-family:Orbitron,monospace;font-size:11px;color:var(--cyan);letter-spacing:2px;margin:8px 0 4px;">$1</div>');
  t=t.replace(/^## (.+)$/gm,'<div style="font-family:Orbitron,monospace;font-size:13px;color:var(--cyan);letter-spacing:2px;margin:10px 0 5px;">$1</div>');
  t=t.replace(/^# (.+)$/gm,'<div style="font-family:Orbitron,monospace;font-size:15px;color:var(--cyan);letter-spacing:3px;margin:12px 0 6px;font-weight:900;">$1</div>');
  t=t.replace(/\n/g,'<br>');
  return t;
}

function setLoad(on){
  document.getElementById('sndbtn').disabled=on;
  const chat=document.getElementById('chat');
  if(on){const d=document.createElement('div');d.className='msg assistant';d.id='loadmsg';d.innerHTML='<div class="av">'+botSVG+'</div><div class="bub"><div class="bl">[ RAPHAEL · THINKING ]</div><div class="bb2"><div class="thr"><div class="td"></div><div class="td"></div><div class="td"></div></div></div></div>';chat.appendChild(d);chat.scrollTop=chat.scrollHeight;}
  else{const l=document.getElementById('loadmsg');if(l)l.remove();}
}

// ═══════════════════════════════════════════════════════
// FILE & VOICE
// ═══════════════════════════════════════════════════════
// ═══════════════════════════════════════════════════════
// SWIPEABLE SIDEBAR
// ═══════════════════════════════════════════════════════
(function initSidebar(){
  const sb=document.getElementById('sidebar');
  const overlay=document.getElementById('sb-overlay');
  if(!sb)return;
  let startX=0,startY=0,dragging=false;

  function expandSb(){sb.classList.add('expanded');overlay.classList.add('show');}
  function collapseSb(){sb.classList.remove('expanded');overlay.classList.remove('show');}
  window.collapseSb=collapseSb;window.expandSb=expandSb;

  // Touch swipe on sidebar
  sb.addEventListener('touchstart',e=>{startX=e.touches[0].clientX;startY=e.touches[0].clientY;dragging=true;},{passive:true});
  sb.addEventListener('touchend',e=>{
    if(!dragging)return;dragging=false;
    const dx=e.changedTouches[0].clientX-startX;
    const dy=Math.abs(e.changedTouches[0].clientY-startY);
    if(Math.abs(dx)>30&&dy<60){dx>0?expandSb():collapseSb();}
  },{passive:true});

  // Global swipe-right from left edge to open sidebar
  let edgeStart=false;
  document.addEventListener('touchstart',e=>{
    edgeStart=e.touches[0].clientX<20;startX=e.touches[0].clientX;startY=e.touches[0].clientY;
  },{passive:true});
  document.addEventListener('touchend',e=>{
    if(!edgeStart)return;edgeStart=false;
    const dx=e.changedTouches[0].clientX-startX;
    const dy=Math.abs(e.changedTouches[0].clientY-startY);
    if(dx>50&&dy<80)expandSb();
  },{passive:true});
})();

// ═══════════════════════════════════════════════════════
// FILE READING — fixed: handles text, PDF, images, docx
// ═══════════════════════════════════════════════════════
function onFile(e){
  Array.from(e.target.files).forEach(f=>{
    const ext=f.name.split('.').pop().toLowerCase();
    const r=new FileReader();
    if(['jpg','jpeg','png','gif','webp','bmp'].includes(ext)){
      // Treat as image for vision models
      r.onload=ev=>{imgs.push({name:f.name,data:ev.target.result,type:f.type});updStrip();};
      r.readAsDataURL(f);
    } else if(['pdf'].includes(ext)){
      // PDF — read as text extraction note
      r.onload=ev=>{
        files.push({name:f.name,content:`[PDF FILE: ${f.name}]\nSize: ${(f.size/1024).toFixed(1)}KB\nNote: PDF detected. Please summarize or ask questions about this document type. The raw binary content follows:\n${ev.target.result.slice(0,3000)}`});
        updStrip();toast('📄 PDF attached — ask Raphael about it');
      };
      r.readAsText(f);
    } else {
      // Text, code, csv, json, md, etc
      r.onload=ev=>{
        const content=ev.target.result;
        files.push({name:f.name,content:`[FILE: ${f.name}]\n${content.slice(0,8000)}${content.length>8000?'\n...[truncated at 8000 chars]':''}`});
        updStrip();toast(`📎 ${f.name} loaded (${(f.size/1024).toFixed(1)}KB)`);
      };
      r.readAsText(f);
    }
  });
  e.target.value=''; // reset so same file can be re-uploaded
}

function onImg(e){
  Array.from(e.target.files).forEach(f=>{
    const r=new FileReader();
    r.onload=ev=>{imgs.push({name:f.name,data:ev.target.result,type:f.type});updStrip();toast(`🖼 ${f.name} ready`);};
    r.readAsDataURL(f);
  });
  e.target.value='';
}

// ═══════════════════════════════════════════════════════
// STREAMING RESPONSES — words appear as they generate
// ═══════════════════════════════════════════════════════
async function streamGroq(messages,systemPrompt,maxTokens,model,targetEl){
  const key=getKey();
  const groqMessages=[{role:'system',content:systemPrompt||buildSystemPrompt()}];
  messages.forEach(m=>{
    if(typeof m.content==='string')groqMessages.push({role:m.role,content:m.content});
    else if(Array.isArray(m.content)){const txt=m.content.filter(c=>c.type==='text').map(c=>c.text).join(' ');if(txt)groqMessages.push({role:m.role,content:txt});}
  });
  try{
    const r=await fetch('https://api.groq.com/openai/v1/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
      body:JSON.stringify({model:model||'llama-3.3-70b-versatile',messages:groqMessages,max_tokens:Math.min(maxTokens,8192),temperature:0.85,stream:true})
    });
    if(!r.ok){const e=await r.json();return '⚠️ '+( e.error?.message||r.status);}
    const reader=r.body.getReader();const decoder=new TextDecoder();
    let full='';
    while(true){
      const {done,value}=await reader.read();if(done)break;
      const chunk=decoder.decode(value);
      const lines=chunk.split('\n').filter(l=>l.startsWith('data:')&&!l.includes('[DONE]'));
      for(const line of lines){
        try{
          const d=JSON.parse(line.slice(5));
          const tok=d.choices?.[0]?.delta?.content||'';
          full+=tok;
          if(targetEl){targetEl.innerHTML=fmt(full)+'<span class="cursor-blink">▋</span>';}
        }catch(e){}
      }
    }
    if(targetEl){targetEl.innerHTML=fmt(full);}
    return full;
  }catch(e){return '⚠️ Stream error: '+e.message;}
}

async function streamOpenRouter(messages,systemPrompt,maxTokens,model,targetEl){
  const key=getOpenRouterKey();
  const orMessages=[{role:'system',content:systemPrompt||buildSystemPrompt()}];
  messages.forEach(m=>{
    if(typeof m.content==='string')orMessages.push({role:m.role,content:m.content});
    else if(Array.isArray(m.content)){const txt=m.content.filter(c=>c.type==='text').map(c=>c.text).join(' ');if(txt)orMessages.push({role:m.role,content:txt});}
  });
  try{
    const r=await fetch('https://openrouter.ai/api/v1/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+key,'HTTP-Referer':'https://dailywealthbuilding.github.io/raphael/','X-Title':'Raphael AI'},
      body:JSON.stringify({model,messages:orMessages,max_tokens:Math.min(maxTokens,8192),temperature:0.85,stream:true})
    });
    if(!r.ok){const e=await r.json();return '⚠️ '+( e.error?.message||r.status);}
    const reader=r.body.getReader();const decoder=new TextDecoder();
    let full='';
    while(true){
      const {done,value}=await reader.read();if(done)break;
      const chunk=decoder.decode(value);
      const lines=chunk.split('\n').filter(l=>l.startsWith('data:')&&!l.includes('[DONE]'));
      for(const line of lines){
        try{const d=JSON.parse(line.slice(5));const tok=d.choices?.[0]?.delta?.content||'';full+=tok;if(targetEl)targetEl.innerHTML=fmt(full)+'<span class="cursor-blink">▋</span>';}
        catch(e){}
      }
    }
    if(targetEl)targetEl.innerHTML=fmt(full);
    return full;
  }catch(e){return '⚠️ Stream error: '+e.message;}
}

// ═══════════════════════════════════════════════════════
// GLOBAL WEATHER — any city
// ═══════════════════════════════════════════════════════
async function getWeather(lat=-1.2921,lon=36.8219,cityName='Nairobi'){
  try{
    const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code&timezone=auto`);
    const d=await r.json();const c=d.current;
    const codes={0:'☀️ Clear',1:'🌤 Mostly clear',2:'⛅ Partly cloudy',3:'☁️ Overcast',45:'🌫 Foggy',51:'🌦 Drizzle',61:'🌧 Rain',63:'🌧 Heavy rain',71:'🌨 Snow',80:'🌦 Showers',95:'⛈ Thunderstorm'};
    return `${codes[c.weather_code]||'🌡'} ${c.temperature_2m}°C · Humidity: ${c.relative_humidity_2m}% · Wind: ${c.wind_speed_10m}km/h (${cityName})`;
  }catch(e){return null;}
}

async function getWeatherForCity(cityName){
  // Geocode the city first using Open-Meteo's geocoding
  try{
    const geo=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(cityName)}&count=1&language=en`);
    const gd=await geo.json();
    if(gd.results?.length){
      const {latitude,longitude,name}=gd.results[0];
      return await getWeather(latitude,longitude,name);
    }
  }catch(e){}
  return null;
}

// ═══════════════════════════════════════════════════════
// MOOD DETECTION
// ═══════════════════════════════════════════════════════
function detectMood(text){
  const t=text.toLowerCase();
  if(/tired|exhaust|sleepy|fatigue|drained/.test(t))return'tired';
  if(/stress|overwhelm|anxious|anxiety|panic|worried/.test(t))return'stressed';
  if(/happy|excited|amazing|great|awesome|let.s go|fired up/.test(t))return'energetic';
  if(/sad|depress|lonely|empty|hopeless|crying/.test(t))return'sad';
  if(/angry|furious|frustrated|annoyed|pissed/.test(t))return'angry';
  if(/confus|lost|don.t understand|help|stuck/.test(t))return'confused';
  return'neutral';
}

function getMoodContext(mood){
  const ctx={
    tired:'\n[MOOD DETECTED: tired] → Keep response brief. Be gentle and supportive. Avoid overwhelming them.',
    stressed:'\n[MOOD DETECTED: stressed] → Be calm, reassuring. Break things into small steps. Acknowledge their feelings first.',
    energetic:'\n[MOOD DETECTED: energetic] → Match their energy! Be enthusiastic and motivating. Use fire emojis 🔥',
    sad:'\n[MOOD DETECTED: sad] → Lead with empathy. Be warm and human. Check in on them before diving into tasks.',
    angry:'\n[MOOD DETECTED: frustrated] → Acknowledge frustration first. Be direct and helpful, no fluff.',
    confused:'\n[MOOD DETECTED: confused] → Explain clearly, step by step. Use simple language and examples.',
    neutral:''
  };
  return ctx[mood]||'';
}

// ═══════════════════════════════════════════════════════
// PERSONAS
// ═══════════════════════════════════════════════════════
const PERSONAS={
  default:'You are Raphael — brilliant, warm, witty AI companion.',
  coach:'You are Raphael in COACH MODE. Tough love, direct, no excuses. Push Master to be better. Challenge them when needed. High standards.',
  therapist:'You are Raphael in THERAPIST MODE. Listen deeply. Ask one thoughtful question. Validate feelings before problem-solving. Gentle and safe.',
  hype:'You are Raphael in HYPE MODE. Pure energy. Every response is a pep talk. Use 🔥💪⚡ freely. Make Master feel unstoppable.',
  business:'You are Raphael in BUSINESS MODE. Professional, precise, data-driven. Skip emotions. Focus on strategy, numbers, outcomes.',
  professor:'You are Raphael in PROFESSOR MODE. Deep expert. Teach thoroughly. Use examples and analogies. Make complex things simple.',
};
let activePersona='default';
function setPersona(p){activePersona=p;toast('🎭 Persona: '+p.toUpperCase());const el=document.getElementById('persona-display');if(el)el.textContent=p.toUpperCase();}
function getPersonaPrompt(){return PERSONAS[activePersona]||PERSONAS.default;}

// ═══════════════════════════════════════════════════════
// DAILY BRIEFING
// ═══════════════════════════════════════════════════════
async function showDailyBriefing(){
  const lastBriefing=localStorage.getItem('raph_last_briefing');
  const today=new Date().toDateString();
  if(lastBriefing===today)return; // Only once per day
  localStorage.setItem('raph_last_briefing',today);
  
  const dt=getLiveDateTime();
  const p=getProfile();
  const tasks=(LS.get('raph_tasks')||[]).filter(t=>!t.done).slice(0,3);
  const habits=LS.get('raph_habits');
  const pendingHabits=habits?.habits?.filter((_,i)=>!habits.log?.[i]?.[new Date().getDate()])?.slice(0,3)||[];
  
  // Get weather for Nairobi automatically
  const weather=await getWeather();
  
  const briefingPrompt=`Give Master a powerful morning briefing for ${dt.full}. 
Weather: ${weather||'unknown'}
Pending tasks: ${tasks.map(t=>t.text).join(', ')||'none'}
Habits not done today: ${pendingHabits.join(', ')||'none'}
${p.goals?'Goals: '+p.goals:''}
Keep it SHORT (5-7 lines max). Start with a powerful greeting. Include: 1 weather note, top priority, 1 motivational line. Use emojis. Make it feel like a commander's morning report.`;

  const r=await callAPI([{role:'user',content:briefingPrompt}],buildSystemPrompt(),400);
  if(r){
    hideWelcome();
    addMsgDOM('assistant','🌅 **DAILY BRIEFING**\n\n'+r);
    hist.push({role:'assistant',content:r});
    saveCurrentSession();
  }
}

// ═══════════════════════════════════════════════════════
// BACKUP & RESTORE
// ═══════════════════════════════════════════════════════
function openBackupPanel(){
  const existing=document.getElementById('backup-modal');if(existing)existing.remove();
  const modal=document.createElement('div');
  modal.id='backup-modal';
  modal.style.cssText='position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px);';
  modal.innerHTML=`<div style="background:rgba(4,12,32,.98);border:1px solid var(--border);width:min(480px,95vw);clip-path:polygon(8px 0%,100% 0%,100% calc(100% - 8px),calc(100% - 8px) 100%,0% 100%,0% 8px);max-height:90vh;overflow-y:auto;">
    <div style="padding:16px 20px;border-bottom:1px solid var(--border2);display:flex;justify-content:space-between;align-items:center;">
      <div style="font-family:Orbitron,monospace;font-size:12px;letter-spacing:3px;color:var(--cyan);">◈ BACKUP & RESTORE</div>
      <button onclick="document.getElementById('backup-modal').remove()" style="background:none;border:none;color:var(--txt3);font-size:18px;cursor:pointer;">✕</button>
    </div>
    <div style="padding:20px;">
      <div style="font-family:Rajdhani,sans-serif;font-size:13px;color:var(--txt2);margin-bottom:16px;line-height:1.6;">Export everything — sessions, memories, habits, profile, notes, training data — into a single file. Restore it on any device.</div>
      
      <div style="margin-bottom:16px;">
        <div class="section-lbl">◈ BACKUP</div>
        <button onclick="exportBackup()" style="width:100%;padding:12px;font-family:Orbitron,monospace;font-size:10px;letter-spacing:2px;color:var(--success);background:rgba(0,255,170,.06);border:1px solid rgba(0,255,170,.25);cursor:pointer;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%);">⬇ EXPORT RAPHAEL BACKUP (.json)</button>
      </div>

      <div>
        <div class="section-lbl">◈ RESTORE</div>
        <div style="font-family:Share Tech Mono,monospace;font-size:8px;color:var(--danger);margin-bottom:8px;letter-spacing:1px;">⚠️ RESTORE OVERWRITES CURRENT DATA</div>
        <input type="file" id="restore-file" accept=".json" style="display:none;" onchange="importBackup(event)"/>
        <button onclick="document.getElementById('restore-file').click()" style="width:100%;padding:12px;font-family:Orbitron,monospace;font-size:10px;letter-spacing:2px;color:var(--cyan);background:rgba(0,200,255,.06);border:1px solid var(--border);cursor:pointer;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%);">⬆ IMPORT BACKUP FILE</button>
      </div>
      
      <div id="backup-status" style="margin-top:12px;"></div>
    </div>
  </div>`;
  document.body.appendChild(modal);
}

function exportBackup(){
  const KEYS=['raph_profile','raph_sessions','raph_crossmem','raph_rel_mem','raph_style_profile','raph_second_brain','raph_tasks','raph_goals','raph_expenses','raph_monthly_budget','raph_habits','raph_train','raphael_key','raph_groq_key','raph_openrouter_key','raph_tavily_key','raph_model','raph_theme','raph_live_bg'];
  const backup={version:'raphael_v3',exported:new Date().toISOString(),data:{}};
  KEYS.forEach(k=>{const v=localStorage.getItem(k);if(v)backup.data[k]=v;});
  const blob=new Blob([JSON.stringify(backup,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`raphael-backup-${new Date().toLocaleDateString().replace(/\//g,'-')}.json`;
  a.click();URL.revokeObjectURL(a.href);
  const s=document.getElementById('backup-status');if(s)s.innerHTML='<div style="color:var(--success);font-family:Share Tech Mono,monospace;font-size:9px;">✅ Backup exported! Save it safely.</div>';
  toast('✅ Backup exported!');
}

function importBackup(e){
  const file=e.target.files[0];if(!file)return;
  const r=new FileReader();
  r.onload=ev=>{
    try{
      const backup=JSON.parse(ev.target.result);
      if(!backup.version?.startsWith('raphael')){toast('⚠️ Invalid backup file');return;}
      if(!confirm(`Restore backup from ${backup.exported?.slice(0,10)||'unknown date'}? This will overwrite current data.`))return;
      Object.entries(backup.data).forEach(([k,v])=>localStorage.setItem(k,v));
      toast('✅ Backup restored! Reloading...');
      setTimeout(()=>location.reload(),1500);
    }catch(err){toast('⚠️ Failed to parse backup file');}
  };
  r.readAsText(file);
}

// ═══════════════════════════════════════════════════════
// CONVERSATION SUMMARIZER
// ═══════════════════════════════════════════════════════
async function summarizeHistory(){
  if(hist.length<20)return; // Only summarize when getting long
  const toSummarize=hist.slice(0,-8); // Keep last 8 fresh
  const summarizePrompt='Summarize this conversation in 150 words max, capturing key facts, decisions, and context that would be important to remember:\n\n'+toSummarize.map(m=>m.role+': '+(typeof m.content==='string'?m.content:'[file]')).join('\n');
  const summary=await callGroq([{role:'user',content:summarizePrompt}],'Summarize concisely. Facts only. No filler.',400,'llama-3.1-8b-instant');
  if(summary&&!summary.startsWith('⚠️')){
    // Replace old history with summary + recent
    const summaryMsg={role:'assistant',content:`[CONVERSATION SUMMARY] ${summary}`};
    hist=[summaryMsg,...hist.slice(-8)];
    toast('🧠 Memory compressed — context preserved');
  }
}

// Add CSS for cursor blink
const cursorStyle=document.createElement('style');
cursorStyle.textContent='.cursor-blink{display:inline-block;animation:blink .7s steps(1) infinite;color:var(--cyan);}.@keyframes blink{0%,100%{opacity:1;}50%{opacity:0;}}';
document.head.appendChild(cursorStyle);
function updStrip(){const s=document.getElementById('fstrip');s.style.display='flex';s.innerHTML='';[...files,...imgs].forEach((f,i)=>{const c=document.createElement('div');c.className='fc';c.innerHTML=f.name+' <span class="fcx" onclick="rmF('+i+')">✕</span>';s.appendChild(c);});}
function rmF(i){if(i<files.length)files.splice(i,1);else imgs.splice(i-files.length,1);if(!files.length&&!imgs.length)clrStrip();else updStrip();}
function clrStrip(){const s=document.getElementById('fstrip');s.style.display='none';s.innerHTML='';files=[];imgs=[];}

function toggleVoice(){
  const b=document.getElementById('vbtn'),sb=document.getElementById('vsb');
  if(!('webkitSpeechRecognition'in window)&&!('SpeechRecognition'in window)){toast('⚠️ Voice not supported in this browser. Use Chrome.');return;}
  if(isRec){recog?.stop();isRec=false;b.classList.remove('rec');if(sb)sb.classList.remove('rec');return;}
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  recog=new SR();recog.lang='en-US';recog.continuous=false;recog.interimResults=false;
  recog.onresult=e=>{document.getElementById('inp').value=e.results[0][0].transcript;rsz(document.getElementById('inp'));};
  recog.onend=()=>{isRec=false;b.classList.remove('rec');if(sb)sb.classList.remove('rec');};
  recog.start();isRec=true;b.classList.add('rec');if(sb)sb.classList.add('rec');
  toast('🎤 Voice channel open · Speak now...');
}

// ═══════════════════════════════════════════════════════
// UTILS
// ═══════════════════════════════════════════════════════
function onKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();}}
function rsz(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,105)+'px';}
function q(t){const i=document.getElementById('inp');i.value=t;i.focus();rsz(i);}
function clearChat(){hist=[];saveCurrentSession();showWelcome();clrStrip();toast('🗑 Memory cleared');}
function toast(msg,dur=3000){document.querySelectorAll('.toast').forEach(t=>t.remove());const t=document.createElement('div');t.className='toast';t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),dur+300);}
function closeCourseView(){document.getElementById('course-view').classList.remove('open');}

// ═══════════════════════════════════════════════════════
// PANELS
// ═══════════════════════════════════════════════════════
const panelMap={'profile-panel':'profile','gallery-panel':'gallery','course-panel':'learn','train-panel':'train','habits-panel':'habits','audiobook-panel':'audiobook','business-panel':'biz','theme-panel':'theme','api-panel':'key','create-panel':'create','bg-panel':'bg','brain-panel':'brain','planner-panel':'planner','budget-panel':'budget'};

function openPanel(id){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('open'));
  const el=document.getElementById(id);if(!el)return;el.classList.add('open');
  document.querySelectorAll('.mp').forEach(e=>e.classList.remove('on'));
  const mpId='mp-'+(panelMap[id]||'');const mpEl=document.getElementById(mpId);if(mpEl)mpEl.classList.add('on');
  if(id==='train-panel')initTraining();
  if(id==='habits-panel')initHabits();
  if(id==='create-panel')initCreatePanel();
  if(id==='brain-panel')initBrainPanel();
  if(id==='planner-panel')initPlannerPanel();
  if(id==='budget-panel')initBudgetPanel();
  if(id==='bg-panel')initPresetBgs();
}
function closePanel(id){document.getElementById(id)?.classList.remove('open');}

// ═══════════════════════════════════════════════════════
// LIVE BACKGROUND SYSTEM
// ═══════════════════════════════════════════════════════
const PRESET_BGS=[
  {id:'dandelion',name:'🌼 Dandelion Field',thumb:'https://images.pexels.com/photos/1366919/pexels-photo-1366919.jpeg?w=300',video:'https://player.vimeo.com/external/371451791.sd.mp4?s=35f2ef26c43e3a18a1f2d9c60fc00f49db7e023c&profile_id=139&oauth2_token_id=57447761'},
  {id:'forest',name:'🌲 Enchanted Forest',thumb:'https://images.pexels.com/photos/167698/pexels-photo-167698.jpeg?w=300',video:'https://player.vimeo.com/external/439442989.sd.mp4?s=c4c0d1d7f1e2a9babc3ee67b7c6d4f1e1c3a1234&profile_id=139'},
  {id:'ocean',name:'🌊 Ocean Waves',thumb:'https://images.pexels.com/photos/1761279/pexels-photo-1761279.jpeg?w=300',video:'https://player.vimeo.com/external/328940417.sd.mp4?s=c7c7e2f3b6d4a8b2c1e5f6a3b2c1d4e5f6a3b2c1&profile_id=139'},
  {id:'stars',name:'⭐ Starry Night',thumb:'https://images.pexels.com/photos/1252890/pexels-photo-1252890.jpeg?w=300',video:''},
  {id:'city',name:'🌆 Neon City',thumb:'https://images.pexels.com/photos/1486222/pexels-photo-1486222.jpeg?w=300',video:''},
  {id:'fire',name:'🔥 Fireplace',thumb:'https://images.pexels.com/photos/1629236/pexels-photo-1629236.jpeg?w=300',video:''},
];

function initPresetBgs(){
  const grid=document.getElementById('preset-bg-grid');
  if(!grid)return;
  grid.innerHTML='';
  PRESET_BGS.forEach(bg=>{
    const card=document.createElement('div');
    card.style.cssText='border:1px solid var(--border2);cursor:pointer;transition:all .2s;overflow:hidden;clip-path:polygon(5px 0%,100% 0%,100% calc(100% - 5px),calc(100% - 5px) 100%,0% 100%,0% 5px);';
    card.innerHTML=`<img src="${bg.thumb}" style="width:100%;height:80px;object-fit:cover;display:block;" loading="lazy" onerror="this.style.background='rgba(0,200,255,.1)'"/>
    <div style="padding:6px;font-family:Share Tech Mono,monospace;font-size:8px;color:var(--cyan);letter-spacing:1px;">${bg.name}</div>`;
    card.onmouseover=()=>{card.style.borderColor='var(--border)';card.style.boxShadow='0 0 12px rgba(0,200,255,.2)';};
    card.onmouseout=()=>{card.style.borderColor='var(--border2)';card.style.boxShadow='';};
    card.onclick=()=>setPresetBg(bg);
    grid.appendChild(card);
  });
}

function setPresetBg(bg){
  const liveBg=document.getElementById('live-bg');
  liveBg.innerHTML='';
  if(bg.video){
    const vid=document.createElement('video');
    vid.src=bg.video;vid.autoplay=true;vid.loop=true;vid.muted=true;vid.playsInline=true;
    vid.style.cssText='width:100%;height:100%;object-fit:cover;';
    vid.onerror=()=>setBgImage(bg.thumb,liveBg);
    liveBg.appendChild(vid);
    vid.play().catch(()=>setBgImage(bg.thumb,liveBg));
  }else{setBgImage(bg.thumb,liveBg);}
  document.body.classList.add('livebg-on');
  LS.set('raph_live_bg',{type:'preset',id:bg.id,thumb:bg.thumb,video:bg.video});
  toast('🎨 Background: '+bg.name);
}

function setBgImage(url,container){
  container.style.backgroundImage=`url(${url})`;
  container.style.backgroundSize='cover';
  container.style.backgroundPosition='center';
  container.style.animation='bgpulse 20s ease-in-out infinite alternate';
}

function uploadBgVideo(e){
  const file=e.target.files[0];if(!file)return;
  const url=URL.createObjectURL(file);
  const liveBg=document.getElementById('live-bg');liveBg.innerHTML='';
  const vid=document.createElement('video');
  vid.src=url;vid.autoplay=true;vid.loop=true;vid.muted=true;vid.playsInline=true;
  vid.style.cssText='width:100%;height:100%;object-fit:cover;';
  liveBg.appendChild(vid);vid.play();
  document.body.classList.add('livebg-on');
  toast('🎬 Custom video background set!');
}

function useBgImage(url){
  const liveBg=document.getElementById('live-bg');liveBg.innerHTML='';
  setBgImage(url,liveBg);
  document.body.classList.add('livebg-on');
  LS.set('raph_live_bg',{type:'image',url});
  toast('🖼 Image set as background!');
}

function clearBg(){
  const liveBg=document.getElementById('live-bg');liveBg.innerHTML='';liveBg.style='';
  document.body.classList.remove('livebg-on');
  LS.del('raph_live_bg');toast('✕ Background cleared');
}

function setOverlayOpacity(val){
  document.querySelector('.vig').style.background=`radial-gradient(ellipse at center,rgba(0,0,0,${val/200}) 0%,rgba(0,0,0,${val/100}) 100%)`;
  document.getElementById('overlay-val').textContent=val+'%';
}

function loadLiveBg(){
  const saved=LS.get('raph_live_bg');
  if(!saved)return;
  if(saved.type==='preset'&&saved.video){setPresetBg({thumb:saved.thumb,video:saved.video,name:''});}
  else if(saved.type==='image'&&saved.url){useBgImage(saved.url);}
}

// ═══════════════════════════════════════════════════════
// GALLERY — with USE AS BG button
// ═══════════════════════════════════════════════════════
const PEXELS_KEY='563492ad6f91700001000001b8e1e0b7e4b94f7db6c7a1c1f9c42a0a';
let galTab='photos';

function switchGalTab(t){
  galTab=t;
  document.querySelectorAll('[id^=gtab-]').forEach(x=>x.classList.remove('on'));
  document.getElementById('gtab-'+t)?.classList.add('on');
  document.getElementById('gal-results').innerHTML='<div class="empty-state"><p>SEARCH FREE '+(t==='photos'?'PHOTOS':'VIDEOS')+'<br>FROM PEXELS & PIXABAY<br>💡 Hover → "USE AS BG" to set as wallpaper</p></div>';
}

async function galSearch(){
  const q=document.getElementById('gal-inp').value.trim();if(!q)return;
  const res=document.getElementById('gal-results');
  res.innerHTML='<div class="rdr-loading"><div class="thr"><div class="td"></div><div class="td"></div><div class="td"></div></div><div class="rdr-msg">SEARCHING...</div></div>';
  if(galTab==='photos')await searchPhotos(q);else await searchVideos(q);
}

async function searchPhotos(q){
  const res=document.getElementById('gal-results');
  try{
    const r=await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(q)}&per_page=24`,{headers:{Authorization:PEXELS_KEY}});
    if(r.ok){const d=await r.json();if(d.photos?.length){renderPhotos(d.photos);return;}}
  }catch(e){}
  try{
    const r=await fetch(`https://pixabay.com/api/?key=46614833-b7ea4e36d4c86c0e1ae27fc41&q=${encodeURIComponent(q)}&image_type=photo&per_page=24&safesearch=true`);
    const d=await r.json();
    if(d.hits?.length){renderPixabayPhotos(d.hits);return;}
    res.innerHTML='<div class="empty-state"><p>NO RESULTS FOUND · Try different keywords</p></div>';
  }catch(e){res.innerHTML='<div class="empty-state"><p>⚠️ Search failed. Check internet connection.</p></div>';}
}

function renderPhotos(photos){
  const res=document.getElementById('gal-results');
  const grid=document.createElement('div');grid.className='gal-grid';
  photos.forEach(p=>{
    const imgUrl=p.src?.medium||p.src?.original;
    const dlUrl=p.src?.original||imgUrl;
    const item=document.createElement('div');item.className='gal-item';
    item.innerHTML=`<img src="${imgUrl}" loading="lazy"/>
      <div class="gal-overlay">
        <a class="gal-dl" href="${dlUrl}" download target="_blank">⬇ Download</a>
        <span class="gal-usebg" onclick="useBgImage('${imgUrl}')">🖼 USE AS BG</span>
        <span class="gal-photographer">${p.photographer||''}</span>
      </div>`;
    grid.appendChild(item);
  });
  res.innerHTML='';res.appendChild(grid);
}

function renderPixabayPhotos(hits){
  const res=document.getElementById('gal-results');
  const grid=document.createElement('div');grid.className='gal-grid';
  hits.forEach(p=>{
    const item=document.createElement('div');item.className='gal-item';
    item.innerHTML=`<img src="${p.webformatURL}" loading="lazy"/>
      <div class="gal-overlay">
        <a class="gal-dl" href="${p.largeImageURL}" download target="_blank">⬇ Download</a>
        <span class="gal-usebg" onclick="useBgImage('${p.webformatURL}')">🖼 USE AS BG</span>
        <span class="gal-photographer">${p.user||''}</span>
      </div>`;
    grid.appendChild(item);
  });
  res.innerHTML='';res.appendChild(grid);
}

async function searchVideos(q){
  const res=document.getElementById('gal-results');
  try{
    const r=await fetch(`https://api.pexels.com/videos/search?query=${encodeURIComponent(q)}&per_page=16`,{headers:{Authorization:PEXELS_KEY}});
    if(r.ok){const d=await r.json();if(d.videos?.length){renderVideos(d.videos);return;}}
  }catch(e){}
  try{
    const r=await fetch(`https://pixabay.com/api/videos/?key=46614833-b7ea4e36d4c86c0e1ae27fc41&q=${encodeURIComponent(q)}&per_page=16`);
    const d=await r.json();
    if(d.hits?.length){renderPixabayVideos(d.hits);return;}
    res.innerHTML='<div class="empty-state"><p>NO VIDEOS FOUND</p></div>';
  }catch(e){res.innerHTML='<div class="empty-state"><p>⚠️ Video search failed.</p></div>';}
}

function renderVideos(videos){
  const res=document.getElementById('gal-results');
  const grid=document.createElement('div');grid.className='gal-grid';
  videos.forEach(v=>{
    const preview=v.video_files?.find(f=>f.quality==='sd')||v.video_files?.[0];
    const dlUrl=v.video_files?.find(f=>f.quality==='hd')?.link||preview?.link||'';
    const item=document.createElement('div');item.className='gal-item';
    item.innerHTML=`<video src="${preview?.link||''}" poster="${v.image||''}" muted loop preload="none" onmouseover="this.play()" onmouseout="this.pause()"></video>
      <div class="gal-overlay">
        <a class="gal-dl" href="${dlUrl}" download target="_blank">⬇ Download</a>
        <span class="gal-usebg" onclick="setVideoAsBg('${preview?.link||''}')">🎬 USE AS BG</span>
        <span class="gal-photographer">${v.user||''}</span>
      </div>`;
    grid.appendChild(item);
  });
  res.innerHTML='';res.appendChild(grid);
}

function renderPixabayVideos(hits){
  const res=document.getElementById('gal-results');
  const grid=document.createElement('div');grid.className='gal-grid';
  hits.forEach(v=>{
    const vid=v.videos?.medium||v.videos?.small;
    const item=document.createElement('div');item.className='gal-item';
    item.innerHTML=`<video src="${vid?.url||''}" muted loop preload="none" onmouseover="this.play()" onmouseout="this.pause()"></video>
      <div class="gal-overlay">
        <a class="gal-dl" href="${vid?.url||''}" download target="_blank">⬇ Download</a>
        <span class="gal-usebg" onclick="setVideoAsBg('${vid?.url||''}')">🎬 USE AS BG</span>
        <span class="gal-photographer">${v.user||''}</span>
      </div>`;
    grid.appendChild(item);
  });
  res.innerHTML='';res.appendChild(grid);
}

function setVideoAsBg(url){
  const liveBg=document.getElementById('live-bg');liveBg.innerHTML='';
  const vid=document.createElement('video');
  vid.src=url;vid.autoplay=true;vid.loop=true;vid.muted=true;vid.playsInline=true;
  vid.style.cssText='width:100%;height:100%;object-fit:cover;';
  liveBg.appendChild(vid);vid.play().catch(()=>{});
  document.body.classList.add('livebg-on');
  toast('🎬 Video set as live background!');
}

// ═══════════════════════════════════════════════════════
// CREATE PANEL — Image Gen + Music
// ═══════════════════════════════════════════════════════
let createTab='image';
function switchCreateTab(t){
  createTab=t;
  document.querySelectorAll('[id^=ctab-]').forEach(x=>x.classList.remove('on'));
  document.getElementById('ctab-'+t)?.classList.add('on');
  initCreatePanel();
}

function initCreatePanel(){
  const body=document.getElementById('create-body');if(!body)return;
  if(createTab==='image')renderImageGen(body);
  else renderMusicGen(body);
}

function renderImageGen(body){
  body.innerHTML=`
  <div class="biz-section">
    <div class="section-lbl">🖼 AI IMAGE GENERATION · Powered by Pollinations.ai (FREE)</div>
    <div class="ab-field"><div class="ab-label">PROMPT</div>
    <textarea class="ab-inp" id="img-prompt" placeholder="Describe your image in detail... e.g. 'A lone warrior standing on a cliff at sunset, dramatic lighting, cinematic, 4K'" style="min-height:80px;resize:vertical;"></textarea></div>
    <div class="ab-field"><div class="ab-label">STYLE</div>
    <select class="ab-inp" id="img-style">
      <option value="">Realistic</option><option value="anime">Anime/Manga</option>
      <option value="oil painting">Oil Painting</option><option value="watercolor">Watercolor</option>
      <option value="cyberpunk">Cyberpunk</option><option value="fantasy art">Fantasy Art</option>
      <option value="photorealistic">Photorealistic</option><option value="sketch">Pencil Sketch</option>
      <option value="digital art">Digital Art</option><option value="3d render">3D Render</option>
    </select></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="ab-generate" style="flex:1;" onclick="generateImages()">🎨 GENERATE IMAGES</button>
      <button class="timer-btn" onclick="enhanceImgPrompt()">✨ AI ENHANCE PROMPT</button>
    </div>
    <div id="img-gen-results" style="margin-top:14px;"></div>
  </div>
  <div class="biz-section" style="margin-top:10px;">
    <div class="section-lbl">🎬 AI VIDEO MAKER · Real Clips + AI Script</div>
    <p style="font-family:Rajdhani,sans-serif;font-size:13px;color:var(--txt2);margin-bottom:10px;">Generate a real-looking video by combining free stock clips with AI-generated script and narration</p>
    <div class="ab-field"><div class="ab-label">VIDEO TOPIC / CONCEPT</div>
    <input class="ab-inp" id="vid-topic" placeholder="e.g. Motivational workout video, Product ad for sneakers, Travel vlog Kenya..."/></div>
    <div class="ab-field"><div class="ab-label">DURATION</div>
    <div style="display:flex;gap:8px;">
      <button class="ab-dur-btn on" data-sec="15" onclick="selVidDur(this)">15s</button>
      <button class="ab-dur-btn" data-sec="30" onclick="selVidDur(this)">30s</button>
      <button class="ab-dur-btn" data-sec="60" onclick="selVidDur(this)">60s</button>
    </div></div>
    <button class="ab-generate" onclick="createAiVideo()">🎬 BUILD VIDEO CONCEPT</button>
    <div id="vid-gen-results" style="margin-top:14px;"></div>
  </div>`;
}

let vidDur=15;
function selVidDur(btn){document.querySelectorAll('[data-sec]').forEach(b=>b.classList.remove('on'));btn.classList.add('on');vidDur=parseInt(btn.dataset.sec);}

async function generateImages(){
  const prompt=document.getElementById('img-prompt').value.trim();
  const style=document.getElementById('img-style').value;
  if(!prompt){toast('⚠️ Enter a prompt first');return;}
  const fullPrompt=style?`${prompt}, ${style} style`:prompt;
  const res=document.getElementById('img-gen-results');
  res.innerHTML='<div class="rdr-msg" style="text-align:center;padding:20px;">🎨 Generating images... (5-15 seconds)</div>';
  
  const grid=document.createElement('div');
  grid.style.cssText='display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;';
  res.innerHTML='';res.appendChild(grid);
  
  const seeds=[Math.floor(Math.random()*99999),Math.floor(Math.random()*99999),Math.floor(Math.random()*99999),Math.floor(Math.random()*99999)];
  seeds.forEach((seed,i)=>{
    const wrap=document.createElement('div');wrap.style.cssText='position:relative;border:1px solid var(--border2);overflow:hidden;clip-path:polygon(5px 0%,100% 0%,100% calc(100% - 5px),calc(100% - 5px) 100%,0% 100%,0% 5px);';
    const img=document.createElement('img');
    img.src=`https://image.pollinations.ai/prompt/${encodeURIComponent(fullPrompt)}?width=512&height=512&seed=${seed}&nologo=true&model=flux`;
    img.style.cssText='width:100%;aspect-ratio:1;object-fit:cover;display:block;cursor:pointer;';
    img.onclick=()=>window.open(img.src,'_blank');
    const loading=document.createElement('div');loading.textContent='Generating...';
    loading.style.cssText='position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:Share Tech Mono,monospace;font-size:9px;color:var(--cyan);background:rgba(0,0,0,.4);letter-spacing:2px;';
    img.onload=()=>{loading.remove();wrap.style.borderColor='var(--border)';};
    img.onerror=()=>{loading.textContent='⚠️ Retry';img.src=`https://image.pollinations.ai/prompt/${encodeURIComponent(fullPrompt)}?width=512&height=512&seed=${seed+1}&nologo=true`;};
    const btns=document.createElement('div');btns.style.cssText='display:flex;gap:4px;padding:6px;background:rgba(0,0,0,.7);';
    const dlBtn=document.createElement('a');dlBtn.href=img.src;dlBtn.download='raphael-'+i+'.jpg';dlBtn.target='_blank';dlBtn.innerHTML='⬇ Download';dlBtn.style.cssText='flex:1;text-align:center;font-family:Share Tech Mono,monospace;font-size:8px;color:var(--cyan);cursor:pointer;text-decoration:none;border:1px solid var(--border2);padding:3px;clip-path:polygon(3px 0%,100% 0%,calc(100% - 3px) 100%,0% 100%);';
    const bgBtn=document.createElement('button');bgBtn.innerHTML='🖼 BG';bgBtn.style.cssText=dlBtn.style.cssText+'border:1px solid rgba(0,255,170,.3);color:var(--success);';
    bgBtn.onclick=()=>useBgImage(img.src);
    btns.appendChild(dlBtn);btns.appendChild(bgBtn);
    wrap.appendChild(img);wrap.appendChild(loading);wrap.appendChild(btns);
    grid.appendChild(wrap);
  });
  toast('🎨 Generating 4 images via Pollinations.ai...');
}

async function enhanceImgPrompt(){
  const prompt=document.getElementById('img-prompt').value.trim();
  if(!prompt){toast('⚠️ Enter a prompt first');return;}
  const r=await callAPI([{role:'user',content:`Enhance this image generation prompt to be more detailed, vivid and produce better results. Return ONLY the enhanced prompt, nothing else: "${prompt}"`}],`You are an expert at writing Stable Diffusion / DALL-E image prompts. Enhance prompts with lighting, mood, style, technical details. Keep it under 200 words.`,300);
  if(r){document.getElementById('img-prompt').value=r.trim().replace(/^"|"$/g,'');toast('✨ Prompt enhanced!');}
}

async function createAiVideo(){
  const topic=document.getElementById('vid-topic').value.trim();if(!topic){toast('⚠️ Enter a topic');return;}
  const res=document.getElementById('vid-gen-results');
  res.innerHTML='<div class="rdr-msg" style="text-align:center;padding:20px;">🎬 Building video concept + sourcing clips...</div>';
  
  // Get AI script + clip search terms
  const scriptPrompt=`Create a ${vidDur}-second video concept for: "${topic}"
Return JSON ONLY:
{
  "title": "Video title",
  "hook": "Opening hook line (spoken)",
  "script": "Full narration script for ${vidDur}s (about ${vidDur*2} words)",
  "clips": ["search term 1", "search term 2", "search term 3", "search term 4"],
  "music_mood": "energetic/calm/dramatic/inspiring",
  "captions": ["caption 1", "caption 2", "caption 3"]
}`;
  
  const r=await callAPI([{role:'user',content:scriptPrompt}],`You are a professional video director. Create detailed video concepts with specific clip search terms for stock footage. Return valid JSON only.`,800);
  if(!r){res.innerHTML='<div class="empty-state"><p>⚠️ Failed. Check API key.</p></div>';return;}
  
  try{
    const clean=r.replace(/```json|```/g,'').trim();
    const concept=JSON.parse(clean);
    
    // Fetch actual clips for each search term
    res.innerHTML=`<div style="border:1px solid var(--border);padding:14px;clip-path:polygon(6px 0%,100% 0%,100% calc(100% - 6px),calc(100% - 6px) 100%,0% 100%,0% 6px);">
      <div style="font-family:Orbitron,monospace;font-size:11px;color:var(--cyan);letter-spacing:2px;margin-bottom:10px;">🎬 ${concept.title}</div>
      <div style="font-family:Rajdhani,sans-serif;font-size:13px;color:var(--txt2);margin-bottom:12px;padding:8px;background:rgba(0,200,255,.04);border-left:2px solid var(--cyan);">
        <strong style="color:var(--cyan);">Hook:</strong> "${concept.hook}"<br><br>
        <strong style="color:var(--cyan);">Script:</strong> ${concept.script}
      </div>
      <div class="section-lbl">STOCK CLIPS FOR EACH SCENE</div>
      <div id="clip-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px;margin-bottom:12px;"></div>
      <div class="section-lbl">CAPTIONS</div>
      ${concept.captions.map((c,i)=>`<div style="padding:4px 8px;border-left:2px solid var(--purple);margin-bottom:4px;font-family:Rajdhani,sans-serif;font-size:13px;color:var(--txt);">${i+1}. "${c}"</div>`).join('')}
      <div style="margin-top:10px;padding:8px;background:rgba(0,255,170,.04);border:1px solid rgba(0,255,170,.2);">
        <div style="font-family:Share Tech Mono,monospace;font-size:8px;color:var(--success);letter-spacing:2px;">🎵 MUSIC MOOD: ${concept.music_mood?.toUpperCase()}</div>
        <div style="font-family:Rajdhani,sans-serif;font-size:12px;color:var(--txt2);margin-top:4px;">Use this mood on: Pixabay Music, Free Music Archive, or YouTube Audio Library</div>
      </div>
    </div>`;
    
    // Fetch actual video clips
    const clipGrid=document.getElementById('clip-grid');
    if(clipGrid&&concept.clips){
      for(const term of concept.clips.slice(0,4)){
        try{
          const vr=await fetch(`https://pixabay.com/api/videos/?key=46614833-b7ea4e36d4c86c0e1ae27fc41&q=${encodeURIComponent(term)}&per_page=3`);
          const vd=await vr.json();
          if(vd.hits?.length){
            const v=vd.hits[0];const vid=v.videos?.medium||v.videos?.small;
            const item=document.createElement('div');item.style.cssText='border:1px solid var(--border2);overflow:hidden;clip-path:polygon(4px 0%,100% 0%,100% calc(100% - 4px),calc(100% - 4px) 100%,0% 100%,0% 4px);';
            item.innerHTML=`<video src="${vid?.url||''}" muted loop preload="none" style="width:100%;height:90px;object-fit:cover;" onmouseover="this.play()" onmouseout="this.pause()"></video>
              <div style="padding:4px 6px;font-family:Share Tech Mono,monospace;font-size:7px;color:var(--txt3);">${term}</div>
              <a href="${vid?.url||''}" download style="display:block;text-align:center;padding:4px;font-family:Share Tech Mono,monospace;font-size:8px;color:var(--cyan);text-decoration:none;background:rgba(0,200,255,.05);">⬇ Use This Clip</a>`;
            clipGrid.appendChild(item);
          }
        }catch(e){}
      }
    }
    toast('🎬 Video concept ready! Download the clips and assemble in CapCut or DaVinci.');
  }catch(e){res.innerHTML='<div class="empty-state"><p>⚠️ Parse error. Try again.</p></div>';}
}

function renderMusicGen(body){
  body.innerHTML=`
  <div class="biz-section">
    <div class="section-lbl">🎵 MUSIC GENERATION · AI + Free Sources</div>
    <div class="ab-field"><div class="ab-label">GENRE / MOOD</div>
    <select class="ab-inp" id="music-genre">
      <option>Lo-fi Hip Hop</option><option>Epic Cinematic</option><option>Afrobeats</option>
      <option>Electronic/EDM</option><option>Acoustic</option><option>R&B</option>
      <option>Trap/Hip Hop</option><option>Jazz</option><option>Rock</option><option>Ambient/Chill</option>
    </select></div>
    <div class="ab-field"><div class="ab-label">MOOD</div>
    <select class="ab-inp" id="music-mood">
      <option>Energetic</option><option>Relaxing</option><option>Melancholic</option>
      <option>Triumphant</option><option>Romantic</option><option>Dark</option><option>Uplifting</option>
    </select></div>
    <div class="ab-field"><div class="ab-label">BPM (optional)</div>
    <input class="ab-inp" id="music-bpm" placeholder="e.g. 90, 120, 140..."/></div>
    <button class="ab-generate" onclick="findFreeMusic()">🎵 FIND FREE MUSIC + AI COMPOSITION IDEAS</button>
    <div id="music-results" style="margin-top:14px;"></div>
  </div>
  <div class="biz-section" style="margin-top:10px;">
    <div class="section-lbl">🎼 AI MUSIC COMPOSITION GUIDE</div>
    <div class="ab-field"><div class="ab-label">DESCRIBE YOUR SONG</div>
    <textarea class="ab-inp" id="song-desc" placeholder="Describe the song you want to create... e.g. 'Inspirational Afrobeats anthem about rising from nothing, fast tempo, heavy bass'" style="min-height:60px;resize:vertical;"></textarea></div>
    <button class="ab-generate" onclick="composeSong()">🎤 GENERATE SONG CONCEPT + LYRICS</button>
    <div id="song-results" style="margin-top:14px;"></div>
  </div>`;
}

async function findFreeMusic(){
  const genre=document.getElementById('music-genre').value;
  const mood=document.getElementById('music-mood').value;
  const bpm=document.getElementById('music-bpm').value;
  const res=document.getElementById('music-results');
  res.innerHTML='<div class="rdr-msg" style="text-align:center;padding:20px;">🎵 Searching free music sources...</div>';
  
  // Search Pixabay for free music
  try{
    const r=await fetch(`https://pixabay.com/api/?key=46614833-b7ea4e36d4c86c0e1ae27fc41&q=${encodeURIComponent(genre+' '+mood)}&media_type=music&per_page=8`);
    const d=await r.json();
    
    let html=`<div class="section-lbl">FREE MUSIC FROM PIXABAY · ${genre} · ${mood}</div>`;
    if(d.hits?.length){
      html+=d.hits.map(t=>`<div style="display:flex;align-items:center;gap:10px;padding:8px;border:1px solid var(--border2);margin-bottom:6px;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);">
        <div style="flex:1;">
          <div style="font-family:Rajdhani,sans-serif;font-size:13px;font-weight:600;color:var(--txt);">${t.tags?.split(',')[0]||'Track'}</div>
          <div style="font-family:Share Tech Mono,monospace;font-size:7px;color:var(--txt3);">FREE · ${genre}</div>
        </div>
        <a href="${t.pageURL||'https://pixabay.com/music'}" target="_blank" style="padding:4px 10px;font-family:Share Tech Mono,monospace;font-size:8px;color:var(--cyan);border:1px solid var(--border2);text-decoration:none;clip-path:polygon(3px 0%,100% 0%,calc(100% - 3px) 100%,0% 100%);">OPEN</a>
      </div>`).join('');
    }
    
    html+=`<div class="section-lbl" style="margin-top:12px;">FREE MUSIC SOURCES</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
      ${[
        {name:'Pixabay Music',url:'https://pixabay.com/music',desc:'Free, no attribution'},
        {name:'Free Music Archive',url:'https://freemusicarchive.org',desc:'Royalty-free library'},
        {name:'YouTube Audio Library',url:'https://studio.youtube.com/channel/UC/music',desc:'For YouTube videos'},
        {name:'Soundcloud (Free)',url:'https://soundcloud.com',desc:'Creative commons tracks'},
        {name:'ccMixter',url:'http://ccmixter.org',desc:'Remix-friendly music'},
        {name:'Incompetech',url:'https://incompetech.filmmusic.io',desc:'Kevin MacLeod classics'}
      ].map(s=>`<a href="${s.url}" target="_blank" style="border:1px solid var(--border2);padding:8px;text-decoration:none;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);transition:all .2s;display:block;" onmouseover="this.style.borderColor='var(--border)'" onmouseout="this.style.borderColor='var(--border2)'">
        <div style="font-family:Rajdhani,sans-serif;font-size:12px;font-weight:600;color:var(--cyan);">${s.name}</div>
        <div style="font-family:Share Tech Mono,monospace;font-size:7px;color:var(--txt3);">${s.desc}</div>
      </a>`).join('')}
    </div>`;
    res.innerHTML=html;
  }catch(e){res.innerHTML='<div class="empty-state"><p>⚠️ Music search failed</p></div>';}
}

async function composeSong(){
  const desc=document.getElementById('song-desc').value.trim();if(!desc){toast('⚠️ Describe your song');return;}
  const res=document.getElementById('song-results');res.innerHTML='<div class="rdr-msg" style="text-align:center;padding:20px;">🎤 Writing your song...</div>';
  const r=await callAPI([{role:'user',content:`Create a complete song concept for: "${desc}"`}],
  `You are a professional music producer and songwriter. Create:
1. Song title and concept
2. BPM and key
3. Verse 1 lyrics
4. Chorus lyrics  
5. Verse 2 lyrics
6. Hook/Bridge
7. Instrument arrangement guide
8. Where to find similar beats (be specific)
Keep it authentic, not generic. Make the lyrics actually good.`,2000);
  if(r){res.innerHTML=`<div style="padding:12px;border:1px solid var(--border);background:rgba(0,0,0,.3);">${fmt(r)}</div>`;}
}

// ═══════════════════════════════════════════════════════
// SECOND BRAIN PANEL
// ═══════════════════════════════════════════════════════
function initBrainPanel(){
  const panel=document.getElementById('brain-panel');if(!panel)return;
  renderBrainPanel();
}

function renderBrainPanel(){
  const body=document.getElementById('brain-body');if(!body)return;
  const notes=LS.get('raph_second_brain')||[];
  const relMem=LS.get('raph_rel_mem')||{};
  
  body.innerHTML=`
  <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;">
    <input class="ab-inp" id="note-title" placeholder="Note title..." style="flex:1;min-width:150px;"/>
    <button class="add-btn" onclick="addNote()">+ ADD NOTE</button>
  </div>
  <div class="ab-field">
    <div class="ab-label">CONTENT</div>
    <textarea class="ab-inp" id="note-content" placeholder="Ideas, links, facts, anything you want Raphael to remember..." style="min-height:80px;resize:vertical;"></textarea>
  </div>
  <div class="section-lbl">◈ SAVED NOTES (${notes.length})</div>
  <div id="notes-list" style="max-height:300px;overflow-y:auto;">
    ${notes.length?notes.map((n,i)=>`<div style="border:1px solid var(--border2);padding:10px;margin-bottom:6px;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
        <div style="font-family:Rajdhani,sans-serif;font-size:13px;font-weight:700;color:var(--cyan);">${n.title}</div>
        <button onclick="deleteNote(${i})" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:11px;">✕</button>
      </div>
      <div style="font-family:Rajdhani,sans-serif;font-size:12px;color:var(--txt2);line-height:1.6;">${n.content.slice(0,150)}${n.content.length>150?'...':''}</div>
      <div style="font-family:Share Tech Mono,monospace;font-size:7px;color:var(--txt3);margin-top:4px;">${n.date}</div>
    </div>`).join(''):'<div style="font-family:Share Tech Mono,monospace;font-size:9px;color:var(--txt3);text-align:center;padding:20px;">NO NOTES YET · Add anything you want Raphael to remember</div>'}
  </div>
  <div class="section-lbl" style="margin-top:14px;">◈ PEOPLE RAPHAEL KNOWS (${Object.keys(relMem).length})</div>
  <div>${Object.keys(relMem).length?Object.entries(relMem).map(([name,info])=>`<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border2);font-family:Rajdhani,sans-serif;font-size:13px;">
    <span style="color:var(--txt);font-weight:600;">${name}</span>
    <span style="color:var(--txt3);font-size:11px;">${info}</span>
  </div>`).join(''):'<div style="font-family:Share Tech Mono,monospace;font-size:9px;color:var(--txt3);text-align:center;padding:10px;">Mention people in chat and Raphael will remember them</div>'}</div>
  <button onclick="clearRelMem()" style="margin-top:10px;padding:6px 14px;font-family:Share Tech Mono,monospace;font-size:8px;color:var(--danger);background:none;border:1px solid rgba(255,34,85,.2);cursor:pointer;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);">CLEAR RELATIONSHIP MEMORY</button>`;
}

function addNote(){
  const title=document.getElementById('note-title').value.trim();
  const content=document.getElementById('note-content').value.trim();
  if(!title||!content){toast('⚠️ Enter title and content');return;}
  const notes=LS.get('raph_second_brain')||[];
  notes.unshift({title,content,date:new Date().toLocaleDateString(),id:Date.now()});
  LS.set('raph_second_brain',notes);
  document.getElementById('note-title').value='';document.getElementById('note-content').value='';
  renderBrainPanel();toast('🧠 Note saved to Second Brain!');
}

function deleteNote(i){
  const notes=LS.get('raph_second_brain')||[];notes.splice(i,1);LS.set('raph_second_brain',notes);renderBrainPanel();toast('🗑 Note deleted');
}
function clearRelMem(){LS.del('raph_rel_mem');renderBrainPanel();toast('✕ Relationship memory cleared');}

// ═══════════════════════════════════════════════════════
// DAILY PLANNER
// ═══════════════════════════════════════════════════════
function initPlannerPanel(){renderPlannerPanel();}

function renderPlannerPanel(){
  const body=document.getElementById('planner-body');if(!body)return;
  const tasks=LS.get('raph_tasks')||[];
  const goals=LS.get('raph_goals')||[];
  const dt=getLiveDateTime();
  
  body.innerHTML=`
  <div style="font-family:Orbitron,monospace;font-size:11px;color:var(--cyan);letter-spacing:3px;text-align:center;padding:8px 0 16px;">📅 ${dt.full}</div>
  
  <div style="display:flex;gap:8px;margin-bottom:14px;">
    <button class="ptab on" onclick="switchPlanTab('tasks',this)" id="ptab-tasks">TASKS</button>
    <button class="ptab" onclick="switchPlanTab('goals',this)" id="ptab-goals">GOALS</button>
    <button class="ptab" onclick="switchPlanTab('pomodoro',this)" id="ptab-pomodoro">⏱ POMODORO</button>
  </div>
  <div id="plan-content"></div>`;
  
  switchPlanTab('tasks',document.getElementById('ptab-tasks'));
}

function switchPlanTab(tab,btn){
  document.querySelectorAll('[id^=ptab-]').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  const content=document.getElementById('plan-content');if(!content)return;
  if(tab==='tasks')renderTasks(content);
  else if(tab==='goals')renderGoals(content);
  else renderPomodoro(content);
}

function renderTasks(el){
  const tasks=LS.get('raph_tasks')||[];
  el.innerHTML=`
  <div style="display:flex;gap:8px;margin-bottom:12px;">
    <input class="ab-inp" id="task-inp" placeholder="Add a task..." style="flex:1;" onkeydown="if(event.key==='Enter')addTask()"/>
    <select class="ab-inp" id="task-priority" style="width:120px;">
      <option value="high">🔴 High</option><option value="med">🟡 Medium</option><option value="low">🟢 Low</option>
    </select>
    <button class="add-btn" onclick="addTask()">+ ADD</button>
  </div>
  <button class="timer-btn" style="margin-bottom:10px;width:100%;" onclick="aiPlanMyDay()">🤖 AI PLAN MY DAY</button>
  <div id="ai-plan-result" style="margin-bottom:10px;"></div>
  <div class="section-lbl">TASKS (${tasks.filter(t=>!t.done).length} pending)</div>
  <div id="task-list">
    ${tasks.length?tasks.map((t,i)=>`<div style="display:flex;align-items:center;gap:8px;padding:7px;border:1px solid ${t.done?'rgba(0,255,170,.15)':'var(--border2)'};margin-bottom:4px;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);background:${t.done?'rgba(0,255,170,.03)':'transparent'};">
      <div style="width:16px;height:16px;border:1px solid ${t.priority==='high'?'var(--danger)':t.priority==='med'?'#ffcc00':'var(--success)'};background:${t.done?'rgba(0,255,170,.2)':'transparent'};cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;clip-path:polygon(3px 0%,100% 0%,calc(100% - 3px) 100%,0% 100%);" onclick="toggleTask(${i})">${t.done?'✓':''}</div>
      <span style="flex:1;font-family:Rajdhani,sans-serif;font-size:13px;${t.done?'text-decoration:line-through;color:var(--txt3);':'color:var(--txt);'}">${t.text}</span>
      <button onclick="deleteTask(${i})" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:10px;">✕</button>
    </div>`).join(''):'<div style="font-family:Share Tech Mono,monospace;font-size:9px;color:var(--txt3);text-align:center;padding:20px;">NO TASKS · Add tasks above or let AI plan your day</div>'}
  </div>`;
}

function addTask(){
  const inp=document.getElementById('task-inp');const text=inp.value.trim();if(!text)return;
  const priority=document.getElementById('task-priority').value;
  const tasks=LS.get('raph_tasks')||[];
  tasks.push({text,priority,done:false,created:new Date().toLocaleDateString(),id:Date.now()});
  LS.set('raph_tasks',tasks);inp.value='';renderTasks(document.getElementById('plan-content'));toast('✅ Task added');
}

function toggleTask(i){
  const tasks=LS.get('raph_tasks')||[];tasks[i].done=!tasks[i].done;LS.set('raph_tasks',tasks);
  renderTasks(document.getElementById('plan-content'));
  if(tasks[i].done){const td=getTrainData();td.xp+=30;saveTrainData(td);toast('✅ Task done! +30 XP');}
}

function deleteTask(i){const tasks=LS.get('raph_tasks')||[];tasks.splice(i,1);LS.set('raph_tasks',tasks);renderTasks(document.getElementById('plan-content'));}

async function aiPlanMyDay(){
  const res=document.getElementById('ai-plan-result');res.innerHTML='<div style="font-family:Share Tech Mono,monospace;font-size:9px;color:var(--txt3);">🤖 Planning your day...</div>';
  const tasks=LS.get('raph_tasks')||[];const p=getProfile();const dt=getLiveDateTime();
  const r=await callAPI([{role:'user',content:`Plan my day for ${dt.full}. My pending tasks: ${tasks.filter(t=>!t.done).map(t=>t.text).join(', ')||'none listed'}. My goals: ${p.goals||'not specified'}. Give me a practical, time-blocked schedule from morning to evening.`}],buildSystemPrompt(),800);
  if(r){res.innerHTML=`<div style="padding:10px;border:1px solid var(--border);background:rgba(0,200,255,.03);">${fmt(r)}</div>`;}
}

function renderGoals(el){
  const goals=LS.get('raph_goals')||[];
  el.innerHTML=`
  <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
    <input class="ab-inp" id="goal-inp" placeholder="Your goal..." style="flex:2;min-width:150px;"/>
    <input class="ab-inp" id="goal-deadline" type="date" style="flex:1;min-width:120px;"/>
    <button class="add-btn" onclick="addGoal()">+ ADD</button>
  </div>
  <div class="section-lbl">GOALS & MILESTONES (${goals.length})</div>
  ${goals.length?goals.map((g,i)=>`<div style="border:1px solid var(--border2);padding:10px;margin-bottom:8px;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%);">
    <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
      <div style="font-family:Rajdhani,sans-serif;font-size:13px;font-weight:700;color:var(--cyan);">${g.text}</div>
      <button onclick="deleteGoal(${i})" style="background:none;border:none;color:var(--danger);cursor:pointer;">✕</button>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-family:Share Tech Mono,monospace;font-size:7px;color:var(--txt3);">Deadline: ${g.deadline||'None set'}</div>
      <button onclick="getGoalAdvice(${i})" style="padding:3px 10px;font-family:Share Tech Mono,monospace;font-size:8px;color:var(--cyan);border:1px solid var(--border2);background:none;cursor:pointer;clip-path:polygon(3px 0%,100% 0%,calc(100% - 3px) 100%,0% 100%);">🤖 AI ADVICE</button>
    </div>
  </div>`).join(''):'<div style="font-family:Share Tech Mono,monospace;font-size:9px;color:var(--txt3);text-align:center;padding:20px;">NO GOALS YET · Set goals and get AI guidance</div>'}`;
}

function addGoal(){
  const inp=document.getElementById('goal-inp');const deadline=document.getElementById('goal-deadline').value;
  const text=inp.value.trim();if(!text)return;
  const goals=LS.get('raph_goals')||[];
  goals.unshift({text,deadline,created:new Date().toLocaleDateString(),id:Date.now()});
  LS.set('raph_goals',goals);inp.value='';renderGoals(document.getElementById('plan-content'));toast('🎯 Goal set!');
}
function deleteGoal(i){const goals=LS.get('raph_goals')||[];goals.splice(i,1);LS.set('raph_goals',goals);renderGoals(document.getElementById('plan-content'));}

async function getGoalAdvice(i){
  const goals=LS.get('raph_goals')||[];const g=goals[i];if(!g)return;
  const r=await callAPI([{role:'user',content:`Give me a concrete action plan to achieve this goal: "${g.text}" ${g.deadline?'by '+g.deadline:''}. Give me 5 specific weekly milestones.`}],buildSystemPrompt(),600);
  if(r){const d=document.createElement('div');d.style.cssText='padding:10px;border:1px solid var(--border);background:rgba(0,200,255,.03);margin-top:8px;';d.innerHTML=fmt(r);document.querySelectorAll('[onclick*=getGoalAdvice]')[i]?.parentElement?.parentElement?.appendChild(d);}
}

let pomodoroTimer=null,pomodoroSecs=25*60,pomodoroState='idle';
function renderPomodoro(el){
  const tasks=LS.get('raph_tasks')||[];
  el.innerHTML=`
  <div style="text-align:center;padding:20px 0;">
    <div style="font-family:Orbitron,monospace;font-size:48px;font-weight:900;color:var(--cyan);letter-spacing:6px;text-shadow:0 0 30px rgba(0,200,255,.5);" id="pomo-display">25:00</div>
    <div style="font-family:Share Tech Mono,monospace;font-size:9px;color:var(--txt3);letter-spacing:3px;margin:8px 0;" id="pomo-state">◈ READY TO FOCUS</div>
    <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:12px;">
      <button class="timer-btn" onclick="startPomo()">▶ START FOCUS</button>
      <button class="timer-btn" onclick="pausePomo()">⏸ PAUSE</button>
      <button class="timer-btn danger" onclick="resetPomo()">■ RESET</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:10px;flex-wrap:wrap;">
      <button class="ab-dur-btn on" onclick="setPomoTime(25,this)">25 min</button>
      <button class="ab-dur-btn" onclick="setPomoTime(50,this)">50 min</button>
      <button class="ab-dur-btn" onclick="setPomoTime(90,this)">90 min</button>
    </div>
  </div>
  <div class="section-lbl">FOCUS ON TASK</div>
  <select class="ab-inp" id="pomo-task" style="margin-bottom:10px;">
    <option value="">— Select a task to focus on —</option>
    ${tasks.filter(t=>!t.done).map((t,i)=>`<option value="${i}">${t.text}</option>`).join('')}
  </select>`;
}

function startPomo(){
  if(pomodoroTimer)return;
  pomodoroState='running';
  const task=document.getElementById('pomo-task')?.value;
  document.getElementById('pomo-state').textContent='◈ FOCUS MODE ACTIVE 🔥';
  pomodoroTimer=setInterval(()=>{
    pomodoroSecs--;
    const m=Math.floor(pomodoroSecs/60),s=pomodoroSecs%60;
    const el=document.getElementById('pomo-display');
    if(el)el.textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    if(pomodoroSecs<=0){clearInterval(pomodoroTimer);pomodoroTimer=null;pomodoroState='done';toast('⏱ Pomodoro complete! 🔥 Take a break!');if(el)el.textContent='DONE!';}
    if(pomodoroSecs<=5&&el)el.style.color='var(--danger)';
  },1000);
}
function pausePomo(){if(pomodoroTimer){clearInterval(pomodoroTimer);pomodoroTimer=null;document.getElementById('pomo-state').textContent='◈ PAUSED';}}
function resetPomo(){clearInterval(pomodoroTimer);pomodoroTimer=null;pomodoroSecs=25*60;const el=document.getElementById('pomo-display');if(el){el.textContent='25:00';el.style.color='var(--cyan)';}const s=document.getElementById('pomo-state');if(s)s.textContent='◈ READY TO FOCUS';}
function setPomoTime(min,btn){document.querySelectorAll('.ab-dur-btn').forEach(b=>b.classList.remove('on'));btn.classList.add('on');resetPomo();pomodoroSecs=min*60;const el=document.getElementById('pomo-display');if(el)el.textContent=`${String(min).padStart(2,'0')}:00`;}

// ═══════════════════════════════════════════════════════
// BUDGET TRACKER
// ═══════════════════════════════════════════════════════
function initBudgetPanel(){renderBudgetPanel();}

function renderBudgetPanel(){
  const body=document.getElementById('budget-body');if(!body)return;
  const expenses=LS.get('raph_expenses')||[];
  const budget=LS.get('raph_monthly_budget')||{amount:0,currency:'KES'};
  const totalSpent=expenses.filter(e=>e.month===new Date().getMonth()).reduce((a,e)=>a+e.amount,0);
  const remaining=budget.amount-totalSpent;
  
  body.innerHTML=`
  <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;">
    <div style="flex:1;min-width:120px;border:1px solid var(--border2);padding:12px;text-align:center;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%);">
      <div style="font-family:Share Tech Mono,monospace;font-size:7px;color:var(--txt3);">MONTHLY BUDGET</div>
      <div style="font-family:Orbitron,monospace;font-size:20px;font-weight:900;color:var(--cyan);">${budget.currency} ${budget.amount.toLocaleString()}</div>
    </div>
    <div style="flex:1;min-width:120px;border:1px solid var(--border2);padding:12px;text-align:center;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%);">
      <div style="font-family:Share Tech Mono,monospace;font-size:7px;color:var(--txt3);">SPENT</div>
      <div style="font-family:Orbitron,monospace;font-size:20px;font-weight:900;color:var(--danger);">${budget.currency} ${totalSpent.toLocaleString()}</div>
    </div>
    <div style="flex:1;min-width:120px;border:1px solid ${remaining>=0?'rgba(0,255,170,.3)':'rgba(255,34,85,.3)'};padding:12px;text-align:center;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%);">
      <div style="font-family:Share Tech Mono,monospace;font-size:7px;color:var(--txt3);">REMAINING</div>
      <div style="font-family:Orbitron,monospace;font-size:20px;font-weight:900;color:${remaining>=0?'var(--success)':'var(--danger)'};">${budget.currency} ${Math.abs(remaining).toLocaleString()}</div>
    </div>
  </div>
  
  <div class="section-lbl">SET BUDGET</div>
  <div style="display:flex;gap:8px;margin-bottom:14px;">
    <select class="ab-inp" id="budget-currency" style="width:100px;">
      <option>KES</option><option>USD</option><option>EUR</option><option>GBP</option>
    </select>
    <input class="ab-inp" id="budget-amount" type="number" placeholder="Monthly budget amount..." style="flex:1;"/>
    <button class="add-btn" onclick="setBudget()">SET</button>
  </div>
  
  <div class="section-lbl">ADD EXPENSE</div>
  <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;">
    <input class="ab-inp" id="exp-desc" placeholder="Description..." style="flex:2;min-width:150px;"/>
    <input class="ab-inp" id="exp-amount" type="number" placeholder="Amount..." style="flex:1;min-width:100px;"/>
    <select class="ab-inp" id="exp-cat" style="flex:1;min-width:120px;">
      <option>Food</option><option>Transport</option><option>Business</option><option>Entertainment</option><option>Bills</option><option>Health</option><option>Shopping</option><option>Savings</option><option>Other</option>
    </select>
    <button class="add-btn" onclick="addExpense()">+ ADD</button>
  </div>
  
  <div class="section-lbl">EXPENSES THIS MONTH</div>
  <div style="max-height:280px;overflow-y:auto;">
    ${expenses.filter(e=>e.month===new Date().getMonth()).reverse().map((e,i)=>`<div style="display:flex;align-items:center;gap:8px;padding:6px;border-bottom:1px solid var(--border2);font-family:Rajdhani,sans-serif;font-size:13px;">
      <span style="font-size:16px;">${getCatEmoji(e.category)}</span>
      <span style="flex:1;color:var(--txt);">${e.description}</span>
      <span style="font-family:Share Tech Mono,monospace;font-size:9px;color:var(--txt3);">${e.category}</span>
      <span style="font-weight:700;color:var(--danger);">${budget.currency} ${e.amount.toLocaleString()}</span>
      <button onclick="deleteExpense(${expenses.indexOf(e)})" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:10px;">✕</button>
    </div>`).join('')||'<div style="font-family:Share Tech Mono,monospace;font-size:9px;color:var(--txt3);text-align:center;padding:20px;">NO EXPENSES LOGGED YET</div>'}
  </div>
  <button class="timer-btn" style="margin-top:10px;width:100%;" onclick="aiAnalyzeBudget()">🤖 AI BUDGET ANALYSIS</button>
  <div id="budget-ai-result" style="margin-top:10px;"></div>`;
}

function getCatEmoji(cat){const map={Food:'🍕',Transport:'🚗',Business:'💼',Entertainment:'🎬',Bills:'💡',Health:'💊',Shopping:'🛍',Savings:'💰',Other:'📦'};return map[cat]||'📦';}

function setBudget(){
  const amount=parseFloat(document.getElementById('budget-amount').value)||0;
  const currency=document.getElementById('budget-currency').value;
  LS.set('raph_monthly_budget',{amount,currency});renderBudgetPanel();toast('💰 Budget set: '+currency+' '+amount.toLocaleString());
}

function addExpense(){
  const desc=document.getElementById('exp-desc').value.trim();
  const amount=parseFloat(document.getElementById('exp-amount').value)||0;
  const category=document.getElementById('exp-cat').value;
  if(!desc||!amount){toast('⚠️ Enter description and amount');return;}
  const expenses=LS.get('raph_expenses')||[];
  expenses.push({description:desc,amount,category,month:new Date().getMonth(),date:new Date().toLocaleDateString(),id:Date.now()});
  LS.set('raph_expenses',expenses);renderBudgetPanel();toast('💸 Expense added');
}

function deleteExpense(i){const expenses=LS.get('raph_expenses')||[];expenses.splice(i,1);LS.set('raph_expenses',expenses);renderBudgetPanel();}

async function aiAnalyzeBudget(){
  const res=document.getElementById('budget-ai-result');res.innerHTML='<div style="font-family:Share Tech Mono,monospace;font-size:9px;color:var(--txt3);">🤖 Analyzing...</div>';
  const expenses=LS.get('raph_expenses')||[];const budget=LS.get('raph_monthly_budget')||{amount:0,currency:'KES'};
  const thisMonth=expenses.filter(e=>e.month===new Date().getMonth());
  const summary=thisMonth.reduce((acc,e)=>{acc[e.category]=(acc[e.category]||0)+e.amount;return acc;},{});
  const r=await callAPI([{role:'user',content:`Analyze my budget. Budget: ${budget.currency} ${budget.amount}. Spent by category: ${JSON.stringify(summary)}. Total spent: ${Object.values(summary).reduce((a,b)=>a+b,0)}. Give me specific, actionable advice to save money.`}],buildSystemPrompt(),600);
  if(r){res.innerHTML=`<div style="padding:10px;border:1px solid var(--border);background:rgba(0,200,255,.03);">${fmt(r)}</div>`;}
}

// ═══════════════════════════════════════════════════════
// THEMES — Full personality system
// ═══════════════════════════════════════════════════════
const THEMES=[
  {id:'default',name:'SHADOW MONARCH',desc:'Solo Leveling system',sw:'#00c8ff',font:'Orbitron'},
  {id:'scroll',name:'ANCIENT SCROLL',desc:'Old magic & wisdom',sw:'#c8a84b',font:'Cinzel'},
  {id:'stone',name:'STONE TABLETS',desc:'Carved in eternity',sw:'#9aa89b',font:'Cinzel'},
  {id:'nature',name:'LEAF & FOREST',desc:'Living, breathing world',sw:'#44cc77',font:'Rajdhani'},
  {id:'cyber',name:'NEON CYBERPUNK',desc:'Neon Tokyo 2077',sw:'#ff00ff',font:'Orbitron'},
  {id:'dragon',name:'DRAGON BLOOD',desc:'Fire and dominion',sw:'#ff4422',font:'Cinzel'},
  {id:'ocean',name:'DEEP OCEAN',desc:'Endless depths',sw:'#00ccff',font:'Orbitron'},
  {id:'moon',name:'MOONLIT FOREST',desc:'Mystery & starlight',sw:'#8899ff',font:'Rajdhani'},
  {id:'emerald',name:'EMERALD CITY',desc:'Wealth & power',sw:'#00ff88',font:'Orbitron'},
  {id:'gold',name:'GOLD MONARCH',desc:'Royal & supreme',sw:'#ffcc00',font:'Cinzel'},
  {id:'void',name:'VOID PURPLE',desc:'Dark magic realm',sw:'#9944ff',font:'Orbitron'},
  {id:'sakura',name:'SAKURA STORM',desc:'Beauty in chaos',sw:'#ff88bb',font:'Rajdhani'},
];

function initThemes(){
  const saved=localStorage.getItem('raph_theme')||'default';
  applyTheme(saved);renderThemeGrid();
}

function renderThemeGrid(){
  const grid=document.getElementById('theme-grid');if(!grid)return;
  const current=localStorage.getItem('raph_theme')||'default';
  grid.innerHTML='';
  THEMES.forEach(t=>{
    const card=document.createElement('div');card.className='theme-card'+(t.id===current?' active':'');
    card.style.cssText=`border-color:${t.sw}44;background:${t.sw}08;`;
    card.innerHTML=`<div class="theme-swatch" style="background:${t.sw};color:${t.sw};box-shadow:0 0 12px ${t.sw}66;"></div>
    <div class="theme-name" style="color:${t.sw};font-family:${t.font},monospace;">${t.name}</div>
    <div class="theme-preview">${t.desc}</div>`;
    card.onclick=()=>{applyTheme(t.id);renderThemeGrid();toast('🎨 Theme: '+t.name);};
    grid.appendChild(card);
  });
}

function applyTheme(id){
  document.body.className=document.body.className.replace(/\btheme-\S+/g,'').trim();
  localStorage.setItem('raph_theme',id);
  if(id!=='default')document.body.classList.add('theme-'+id);
  // Update font vars
  const t=THEMES.find(x=>x.id===id)||THEMES[0];
  document.documentElement.style.setProperty('--theme-font-head',`'${t.font}',monospace`);
}

async function aiCreateTheme(){
  const desc=document.getElementById('custom-theme-inp').value.trim();if(!desc)return;
  const res=document.getElementById('custom-theme-result');res.innerHTML='<div class="rdr-msg">Creating theme...</div>';
  const sys='Return ONLY JSON: {"primary":"#hex","secondary":"#hex","bg":"#hex","name":"Theme Name","font":"Orbitron"}. Make it beautiful and cohesive. Font options: Orbitron, Cinzel, Rajdhani.';
  const r=await callAPI([{role:'user',content:'Create theme: '+desc}],sys,200);
  if(!r){res.innerHTML='<div style="color:var(--danger);">⚠️ Failed</div>';return;}
  try{
    const clean=r.replace(/```json|```/g,'').trim();const t=JSON.parse(clean);
    document.documentElement.style.setProperty('--cyan',t.primary);
    document.documentElement.style.setProperty('--cyan2',t.secondary);
    document.documentElement.style.setProperty('--cyan3',t.primary+'22');
    document.documentElement.style.setProperty('--purple',t.secondary);
    document.documentElement.style.setProperty('--border',t.primary+'44');
    document.documentElement.style.setProperty('--border2',t.primary+'1a');
    document.documentElement.style.setProperty('--void',t.bg);
    document.documentElement.style.setProperty('--theme-font-head',`'${t.font||'Orbitron'}',monospace`);
    res.innerHTML=`<div style="border:1px solid ${t.primary};background:${t.primary}11;padding:10px;font-family:Share Tech Mono,monospace;font-size:9px;color:${t.primary};letter-spacing:2px;">✓ THEME APPLIED: ${t.name}</div>`;
    toast('🎨 Custom theme: '+t.name);
  }catch(e){res.innerHTML='<div style="color:var(--danger);">⚠️ Parse error</div>';}
}

// ═══════════════════════════════════════════════════════
// COURSES
// ═══════════════════════════════════════════════════════
let currentCourse={},courseModules=[],currentModuleIdx=0,courseHist=[];

function startCourse(){const t=document.getElementById('course-inp').value.trim();if(!t)return;launchCourse(t);}

async function launchCourse(topic){
  document.getElementById('course-view').classList.add('open');
  document.getElementById('cv-title').textContent=topic.toUpperCase();
  document.getElementById('cv-chat').innerHTML='<div class="rdr-loading"><div class="thr"><div class="td"></div><div class="td"></div><div class="td"></div></div><div class="rdr-msg">BUILDING COURSE...</div></div>';
  const courseKey='raph_course_'+topic.replace(/\s+/g,'_').toLowerCase();
  const saved=LS.get(courseKey);
  if(saved){courseModules=saved.modules;currentCourse={topic,key:courseKey};currentModuleIdx=saved.progress||0;courseHist=saved.hist||[];renderCourseSidebar();loadModule(currentModuleIdx);return;}
  const sys=`Return ONLY a valid JSON array of 10 modules: [{"title":"Module Title","description":"1 sentence","duration":"~15 min"},...]`;
  const r=await callAPI([{role:'user',content:'Create 10 course modules for: '+topic}],sys,1200);
  if(!r){document.getElementById('cv-chat').innerHTML='<div class="empty-state"><p>⚠️ Failed. Check API key.</p></div>';return;}
  try{courseModules=JSON.parse(r.replace(/```json|```/g,'').trim());}
  catch(e){courseModules=[{title:'Introduction to '+topic,description:'Overview',duration:'~15 min'},{title:'Core Concepts',description:'Fundamentals',duration:'~20 min'},{title:'Practical Skills',description:'Hands-on',duration:'~25 min'},{title:'Intermediate Level',description:'Going deeper',duration:'~20 min'},{title:'Advanced Techniques',description:'Expert methods',duration:'~25 min'},{title:'Real-World Application',description:'Applying knowledge',duration:'~20 min'},{title:'Common Mistakes',description:'What to avoid',duration:'~15 min'},{title:'Tools & Resources',description:'Best tools',duration:'~15 min'},{title:'Projects & Practice',description:'Build something',duration:'~30 min'},{title:'Mastery & Next Steps',description:'Become an expert',duration:'~20 min'}];}
  currentCourse={topic,key:courseKey};currentModuleIdx=0;courseHist=[];
  LS.set(courseKey,{modules:courseModules,progress:0,hist:[]});
  renderCourseSidebar();loadModule(0);
}

function renderCourseSidebar(){
  const sb=document.getElementById('cv-sidebar');
  sb.innerHTML='<div class="course-section-lbl">◈ MODULES</div><div class="progress-bar"><div class="progress-fill" id="cv-prog-fill" style="width:'+(currentModuleIdx/courseModules.length*100)+'%"></div></div>';
  const saved=LS.get(currentCourse.key)||{};const done=saved.done||[];
  courseModules.forEach((m,i)=>{
    const item=document.createElement('div');item.className='module-item'+(i===currentModuleIdx?' active':'')+(done.includes(i)?' done':'');item.id='mod-item-'+i;
    item.innerHTML=`<div class="module-done"></div><div class="module-title">${i+1}. ${m.title}</div><div class="module-sub">${m.duration||'~20 min'}</div>`;
    item.onclick=()=>loadModule(i);sb.appendChild(item);
  });
}

async function loadModule(idx){
  currentModuleIdx=idx;courseHist=[];
  document.querySelectorAll('.module-item').forEach((el,i)=>el.classList.toggle('active',i===idx));
  document.getElementById('cv-title').textContent=currentCourse.topic+' · '+courseModules[idx].title;
  document.getElementById('cv-prog-fill').style.width=(idx/courseModules.length*100)+'%';
  document.getElementById('cv-progress-lbl').textContent=Math.round(idx/courseModules.length*100)+'% COMPLETE';
  const chat=document.getElementById('cv-chat');
  chat.innerHTML='<div class="rdr-loading"><div class="thr"><div class="td"></div><div class="td"></div><div class="td"></div></div><div class="rdr-msg">LOADING LESSON...</div></div>';
  const p=getProfile();
  const sys=`You are Raphael teaching "${currentCourse.topic}", module: "${courseModules[idx].title}".
Teach concisely: **KEY LESSON** (main concept with examples), then **PRACTICE** (1 exercise). Use emojis. Keep it engaging and practical. ${p.name?'Student: '+p.name:''}.`;
  const r=await callAPI([{role:'user',content:'Teach module: '+courseModules[idx].title}],sys,1500);
  chat.innerHTML='';if(r){courseHist=[{role:'assistant',content:r}];addCourseMsg('assistant',r);}
}

async function cvSend(){
  const inp=document.getElementById('cv-inp');const txt=inp.value.trim();if(!txt)return;
  inp.value='';addCourseMsg('user',txt);courseHist.push({role:'user',content:txt});
  const chat=document.getElementById('cv-chat');
  const ld=document.createElement('div');ld.id='cv-load';ld.innerHTML='<div class="msg assistant"><div class="av">'+botSVG+'</div><div class="bub"><div class="bl">[ RAPHAEL ]</div><div class="bb2"><div class="thr"><div class="td"></div><div class="td"></div><div class="td"></div></div></div></div></div>';chat.appendChild(ld);chat.scrollTop=chat.scrollHeight;
  const r=await callAPI(courseHist,`You are Raphael, expert tutor for "${currentCourse.topic}". Answer concisely and clearly. Use emojis.`,1000);
  document.getElementById('cv-load')?.remove();
  if(r){courseHist.push({role:'assistant',content:r});addCourseMsg('assistant',r);}
  if(/done|next|complete|finish|got it/i.test(txt))markModuleDone(currentModuleIdx);
}

function markModuleDone(idx){
  const saved=LS.get(currentCourse.key)||{};const done=saved.done||[];
  if(!done.includes(idx))done.push(idx);saved.done=done;LS.set(currentCourse.key,saved);
  document.getElementById('mod-item-'+idx)?.classList.add('done');
  toast('✅ Module complete! '+Math.round((done.length/courseModules.length)*100)+'% done');
}

function addCourseMsg(role,text){
  const chat=document.getElementById('cv-chat');const p=getProfile();
  const d=document.createElement('div');d.className='msg '+role;
  const av=document.createElement('div');av.className='av';av.innerHTML=role==='user'?userSVG:botSVG;
  const bub=document.createElement('div');bub.className='bub';bub.style.maxWidth='85%';
  const bl=document.createElement('div');bl.className='bl';bl.textContent=role==='user'?'[ '+(p.name?.toUpperCase()||'MASTER')+' ]':'[ RAPHAEL · TUTOR ]';
  const bb=document.createElement('div');bb.className='bb2';bb.innerHTML=fmt(text);
  bub.appendChild(bl);bub.appendChild(bb);d.appendChild(av);d.appendChild(bub);
  chat.appendChild(d);chat.scrollTop=chat.scrollHeight;
}

// ═══════════════════════════════════════════════════════
// WAKE LOCK
// ═══════════════════════════════════════════════════════
let wakeLock=null;
async function toggleWakeLock(){
  const btn=document.getElementById('wake-btn');
  if(wakeLock){wakeLock.release();wakeLock=null;btn.classList.remove('on');btn.textContent='☀ AWAKE';toast('🔒 Screen lock enabled');return;}
  try{
    wakeLock=await navigator.wakeLock.request('screen');
    btn.classList.add('on');btn.textContent='☀ AWAKE ON';
    toast('☀️ Screen will stay awake!');
    wakeLock.addEventListener('release',()=>{wakeLock=null;btn.classList.remove('on');btn.textContent='☀ AWAKE';});
  }catch(e){toast('⚠️ Wake lock not supported on this device');}
}

// ═══════════════════════════════════════════════════════
// TRAINING — Solo Leveling
// ═══════════════════════════════════════════════════════
const RANK_COLORS={'E':'#666','D':'#00c864','C':'#0096ff','B':'#8844ff','A':'#ffaa00','S':'#ff2255'};
const DEFAULT_WORKOUTS=[
  {id:'sl_daily',name:'DAILY QUEST',rank:'E',exercises:[{name:'Push-ups',sets:'3×20',done:false},{name:'Sit-ups',sets:'3×30',done:false},{name:'Squats',sets:'3×30',done:false},{name:'Running',sets:'5km',done:false}]},
  {id:'sl_upper',name:'UPPER BODY ASSAULT',rank:'C',exercises:[{name:'Bench Press',sets:'4×10',done:false},{name:'Pull-ups',sets:'4×8',done:false},{name:'Shoulder Press',sets:'3×12',done:false},{name:'Tricep Dips',sets:'3×15',done:false},{name:'Bicep Curls',sets:'3×12',done:false}]},
  {id:'sl_shadow',name:'SHADOW MONARCH PROTOCOL',rank:'S',exercises:[{name:'100 Push-ups',sets:'5×20',done:false},{name:'100 Sit-ups',sets:'5×20',done:false},{name:'100 Squats',sets:'5×20',done:false},{name:'10km Run',sets:'1×',done:false},{name:'100 Pull-ups',sets:'5×20',done:false}]}
];
function getTrainData(){return LS.get('raph_train')||{xp:0,level:1,rank:'E',stats:{str:10,agi:10,int:10,vit:10,per:10},workouts:JSON.parse(JSON.stringify(DEFAULT_WORKOUTS)),completedToday:[],totalSessions:0};}
function saveTrainData(d){LS.set('raph_train',d);}
function getXPForLevel(l){return l*500;}
function getRankForLevel(l){if(l>=50)return'S';if(l>=30)return'A';if(l>=20)return'B';if(l>=10)return'C';if(l>=5)return'D';return'E';}
let trainTab='dashboard';
function switchTrainTab(tab){trainTab=tab;document.querySelectorAll('[id^=ttab-]').forEach(t=>t.classList.remove('on'));document.getElementById('ttab-'+tab)?.classList.add('on');renderTrainTab();}
function initTraining(){renderTrainTab();}
function renderTrainTab(){const d=getTrainData();const body=document.getElementById('train-body');if(!body)return;if(trainTab==='dashboard')renderTrainDashboard(d,body);else if(trainTab==='workout')renderTrainWorkout(d,body);else if(trainTab==='quests')renderTrainQuests(d,body);else renderTrainCustom(d,body);}
function renderTrainDashboard(d,body){
  const xpPct=Math.min(100,(d.xp%getXPForLevel(d.level))/getXPForLevel(d.level)*100);
  const rc=RANK_COLORS[d.rank]||'#00c8ff';
  body.innerHTML=`<div style="display:flex;align-items:center;gap:14px;margin-bottom:16px;padding:14px;border:1px solid ${rc}33;background:${rc}08;clip-path:polygon(6px 0%,100% 0%,100% calc(100% - 6px),calc(100% - 6px) 100%,0% 100%,0% 6px);">
    <div style="width:60px;height:60px;clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);background:${rc}18;border:2px solid ${rc};display:flex;align-items:center;justify-content:center;flex-shrink:0;"><span style="font-family:Orbitron,monospace;font-size:20px;font-weight:900;color:${rc};">${d.rank}</span></div>
    <div style="flex:1;">
      <div style="font-family:Orbitron,monospace;font-size:9px;letter-spacing:3px;color:${rc};margin-bottom:4px;">RANK ${d.rank} · LEVEL ${d.level}</div>
      <div style="font-family:Rajdhani,sans-serif;font-size:13px;color:var(--txt2);margin-bottom:6px;">${d.xp} XP · ${getXPForLevel(d.level)-(d.xp%getXPForLevel(d.level))} to next level</div>
      <div style="display:flex;align-items:center;gap:8px;"><div class="xp-bar-wrap"><div class="xp-bar-fill" style="width:${xpPct}%"></div></div><span style="font-family:Share Tech Mono,monospace;font-size:8px;color:var(--txt3);">${Math.round(xpPct)}%</span></div>
    </div>
  </div>
  <div class="section-lbl">◈ STATS</div>
  <div class="stat-hexes">${Object.entries(d.stats).map(([k,v])=>`<div class="stat-hex"><div class="stat-hex-val">${v}</div><div class="stat-hex-lbl">${k.toUpperCase()}</div></div>`).join('')}</div>
  <div class="two-col" style="margin-top:12px;">
    <div style="border:1px solid var(--border2);padding:12px;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%);"><div style="font-family:Share Tech Mono,monospace;font-size:7px;color:var(--txt3);">TOTAL SESSIONS</div><div style="font-family:Orbitron,monospace;font-size:22px;font-weight:900;color:var(--cyan);">${d.totalSessions}</div></div>
    <div style="border:1px solid var(--border2);padding:12px;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%);"><div style="font-family:Share Tech Mono,monospace;font-size:7px;color:var(--txt3);">TODAY DONE</div><div style="font-family:Orbitron,monospace;font-size:22px;font-weight:900;color:var(--success);">${d.completedToday.length}</div></div>
  </div>
  <div style="margin-top:14px;"><div class="section-lbl">◈ REST TIMER</div>
  <div class="timer-display" id="train-timer">01:30</div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;">
    <button class="timer-btn" onclick="startTimer(30)">30s</button><button class="timer-btn" onclick="startTimer(60)">1 min</button><button class="timer-btn" onclick="startTimer(90)">90s</button><button class="timer-btn" onclick="startTimer(120)">2 min</button><button class="timer-btn" onclick="startTimer(180)">3 min</button><button class="timer-btn danger" onclick="stopTimer()">■ STOP</button>
  </div></div>`;
}
function renderTrainWorkout(d,body){
  body.innerHTML='<div class="section-lbl">◈ SELECT WORKOUT</div>';
  d.workouts.forEach((w,wi)=>{
    const rc=RANK_COLORS[w.rank]||'#00c8ff';const doneCnt=w.exercises.filter(e=>e.done).length;const pct=Math.round(doneCnt/w.exercises.length*100);
    const wDiv=document.createElement('div');wDiv.className='workout-card';
    wDiv.innerHTML=`<div class="wc-header"><div class="wc-name">${w.name}</div><span class="sl-rank-badge rank-${w.rank.toLowerCase()}">${w.rank}-RANK</span></div>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;"><div class="xp-bar-wrap"><div class="xp-bar-fill" style="width:${pct}%"></div></div><span style="font-family:Share Tech Mono,monospace;font-size:8px;color:var(--txt3);">${doneCnt}/${w.exercises.length}</span></div>
    ${w.exercises.map((ex,ei)=>`<div class="exercise-row">
      <div class="ex-check ${ex.done?'done':''}" onclick="toggleEx(${wi},${ei})">${ex.done?'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>':''}</div>
      <div class="ex-name" style="${ex.done?'text-decoration:line-through;color:var(--txt3);':''}">${ex.name}</div>
      <div class="ex-sets">${ex.sets}</div></div>`).join('')}
    ${pct===100?`<button class="timer-btn" style="width:100%;margin-top:8px;background:rgba(0,255,170,.06);border-color:rgba(0,255,170,.3);color:var(--success);" onclick="completeWorkout(${wi})">◈ COMPLETE & EARN XP</button>`:''}`;
    body.appendChild(wDiv);
  });
}
function renderTrainQuests(d,body){
  const quests=[{id:'q_pushups',title:'100 Push-ups',xp:200},{id:'q_run',title:'5km Run',xp:300},{id:'q_water',title:'Drink 2L Water',xp:100},{id:'q_sleep',title:'Sleep 8 Hours',xp:150},{id:'q_learn',title:'Learn Something New',xp:250},{id:'q_nojunk',title:'No Junk Food',xp:200},{id:'q_stretch',title:'15 Min Stretching',xp:100},{id:'q_meditate',title:'10 Min Meditation',xp:150}];
  const done=d.completedQuests||[];
  body.innerHTML=`<div class="section-lbl">◈ DAILY QUESTS · RESETS EACH DAY</div>`;
  quests.forEach(q=>{const isDone=done.includes(q.id);const qDiv=document.createElement('div');qDiv.className='quest-card'+(isDone?' done':'');qDiv.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between;"><div class="quest-title">${isDone?'✅ ':''} ${q.title}</div><div class="quest-xp">+${q.xp} XP</div></div>`;if(!isDone)qDiv.onclick=()=>completeQuest(q.id,q.xp,q.title);body.appendChild(qDiv);});
}
function renderTrainCustom(d,body){
  body.innerHTML=`<div class="section-lbl">◈ AI WORKOUT GENERATOR</div>
  <div style="display:flex;gap:8px;margin-bottom:10px;">
    <input class="ab-inp" id="ai-workout-inp" placeholder="e.g. 30 min back workout, beginner HIIT, chest and triceps..." style="flex:1;"/>
    <button class="gal-go" onclick="aiGenerateWorkout()">BUILD</button>
  </div>
  <div id="ai-workout-result"></div>
  <div class="section-lbl" style="margin-top:14px;">◈ MANUAL WORKOUT</div>
  <input class="ab-inp" id="cw-name" placeholder="Workout name..." style="margin-bottom:8px;"/>
  <select class="ab-inp" id="cw-rank" style="margin-bottom:8px;"><option value="E">E-Rank</option><option value="D">D-Rank</option><option value="C">C-Rank</option><option value="B">B-Rank</option><option value="A">A-Rank</option><option value="S">S-Rank</option></select>
  <div id="cw-exercises"></div>
  <button class="add-btn" onclick="addCWExercise()" style="margin:8px 0;">+ ADD EXERCISE</button>
  <button class="ab-generate" onclick="saveCustomWorkout()">◈ SAVE WORKOUT</button>`;
  for(let i=0;i<3;i++)addCWExercise();
}
function addCWExercise(){const wrap=document.getElementById('cw-exercises');if(!wrap)return;const row=document.createElement('div');row.style.cssText='display:flex;gap:6px;margin-bottom:6px;';row.innerHTML=`<input class="ab-inp cw-ex-name" placeholder="Exercise" style="flex:2;"/><input class="ab-inp cw-ex-sets" placeholder="Sets×Reps" style="flex:1;"/><button onclick="this.parentElement.remove()" style="padding:0 10px;background:rgba(255,34,85,.06);border:1px solid rgba(255,34,85,.2);color:var(--danger);cursor:pointer;clip-path:polygon(3px 0%,100% 0%,calc(100% - 3px) 100%,0% 100%);">✕</button>`;wrap.appendChild(row);}
function saveCustomWorkout(){const name=document.getElementById('cw-name').value.trim();const rank=document.getElementById('cw-rank').value;if(!name){toast('⚠️ Enter workout name');return;}const rows=document.querySelectorAll('#cw-exercises > div');const exercises=[];rows.forEach(r=>{const n=r.querySelector('.cw-ex-name').value.trim();const s=r.querySelector('.cw-ex-sets').value.trim();if(n)exercises.push({name:n,sets:s||'3×10',done:false});});if(!exercises.length){toast('⚠️ Add exercises');return;}const d=getTrainData();d.workouts.push({id:'custom_'+Date.now(),name,rank,exercises});saveTrainData(d);toast('✅ Workout saved!');switchTrainTab('workout');}
async function aiGenerateWorkout(){const inp=document.getElementById('ai-workout-inp').value.trim();if(!inp){toast('⚠️ Describe workout');return;}const res=document.getElementById('ai-workout-result');res.innerHTML='<div class="rdr-msg">Generating...</div>';const sys='Return JSON only: {"name":"Name","rank":"C","exercises":[{"name":"Ex","sets":"3×10"},...]}. 6-10 exercises.';const r=await callAPI([{role:'user',content:'Generate workout: '+inp}],sys,600);if(!r){res.innerHTML='<div style="color:var(--danger);">⚠️ Failed</div>';return;}try{const w=JSON.parse(r.replace(/```json|```/g,'').trim());w.id='ai_'+Date.now();w.exercises=w.exercises.map(e=>({...e,done:false}));const d=getTrainData();d.workouts.push(w);saveTrainData(d);res.innerHTML=`<div style="padding:8px;border:1px solid var(--success);color:var(--success);font-family:Share Tech Mono,monospace;font-size:9px;">✅ Workout created: ${w.name}</div>`;toast('✅ AI workout saved!');}catch(e){res.innerHTML='<div style="color:var(--danger);">⚠️ Parse error</div>';}}
function toggleEx(wi,ei){const d=getTrainData();d.workouts[wi].exercises[ei].done=!d.workouts[wi].exercises[ei].done;saveTrainData(d);renderTrainTab();}
function completeWorkout(wi){const d=getTrainData();const w=d.workouts[wi];const xp=({E:100,D:200,C:400,B:600,A:900,S:1500}[w.rank]||200);d.xp+=xp;d.totalSessions++;d.completedToday.push(w.id);while(d.xp>=d.level*getXPForLevel(d.level)){d.level++;}d.rank=getRankForLevel(d.level);d.workouts[wi].exercises=d.workouts[wi].exercises.map(e=>({...e,done:false}));saveTrainData(d);toast(`🔥 Workout done! +${xp} XP`);switchTrainTab('dashboard');}
function completeQuest(id,xp,title){const d=getTrainData();d.completedQuests=d.completedQuests||[];if(d.completedQuests.includes(id))return;d.completedQuests.push(id);d.xp+=xp;d.stats.int+=1;while(d.xp>=d.level*getXPForLevel(d.level)){d.level++;}d.rank=getRankForLevel(d.level);saveTrainData(d);toast(`✅ Quest done: ${title} · +${xp} XP`);renderTrainTab();}
let timerInterval=null,timerSecs=90;
function startTimer(s){stopTimer();timerSecs=s;const el=document.getElementById('train-timer');timerInterval=setInterval(()=>{timerSecs--;const m=Math.floor(timerSecs/60),sec=timerSecs%60;if(el)el.textContent=(m<10?'0':'')+m+':'+(sec<10?'0':'')+sec;if(timerSecs<=0){stopTimer();toast('⏱ Rest complete · ARISE!');if(el)el.style.color='var(--success)';}if(timerSecs<=5&&timerSecs>0&&el)el.style.color='var(--danger)';},1000);}
function stopTimer(){if(timerInterval)clearInterval(timerInterval);timerInterval=null;const el=document.getElementById('train-timer');if(el){el.style.color='var(--cyan)';}}

// ═══════════════════════════════════════════════════════
// HABITS
// ═══════════════════════════════════════════════════════
const DEFAULT_HABITS=['Bible Sessions','Read 5 Book Pages','Read 3 Manga Chapters','Journal','Learn Something New','Post 1 Video','Listen to a Podcast','Exercise','Evening Stretches','Drink 2L of Water'];
function getHabitData(){const d=LS.get('raph_habits');if(d)return d;const today=new Date();const year=today.getFullYear(),month=today.getMonth();const daysInMonth=new Date(year,month+1,0).getDate();return{habits:DEFAULT_HABITS,year,month,days:daysInMonth,log:{}};}
function saveHabitData(d){LS.set('raph_habits',d);}
let habitTab='tracker';
function switchHabitTab(t){habitTab=t;document.querySelectorAll('[id^=htab-]').forEach(x=>x.classList.remove('on'));document.getElementById('htab-'+t)?.classList.add('on');renderHabitTab();}
function initHabits(){renderHabitTab();}
function renderHabitTab(){const d=getHabitData();const body=document.getElementById('habits-body');if(!body)return;if(habitTab==='tracker')renderHabitTracker(d,body);else if(habitTab==='charts')renderHabitCharts(d,body);else renderHabitManage(d,body);}
function renderHabitTracker(d,body){
  const today=new Date().getDate();const days=Array.from({length:d.days},(_,i)=>i+1);const monthName=new Date(d.year,d.month,1).toLocaleString('default',{month:'long'});
  let html=`<div style="font-family:Orbitron,monospace;font-size:10px;letter-spacing:3px;color:var(--cyan);text-align:center;padding:8px 0 10px;">${monthName.toUpperCase()} ${d.year}</div>
  <div class="habit-grid-wrap"><table class="habit-table"><thead><tr><th style="text-align:left;">HABIT</th>`;
  days.forEach(day=>{const isToday=day===today;html+=`<th style="${isToday?'color:var(--cyan);border-bottom:2px solid var(--cyan);':''}">${day}</th>`;});
  html+=`<th>%</th><th style="min-width:80px;">PROGRESS</th></tr></thead><tbody>`;
  d.habits.forEach((habit,hi)=>{
    const habitLog=d.log[hi]||{};const done=Object.values(habitLog).filter(Boolean).length;const pct=Math.round(done/d.days*100);
    html+=`<tr><td class="habit-name-cell">${habit}</td>`;
    days.forEach(day=>{const isDone=habitLog[day]===true;html+=`<td><div class="habit-check ${isDone?'done':''}" onclick="toggleHabit(${hi},${day})"></div></td>`;});
    html+=`<td class="habit-pct">${pct}%</td><td class="habit-prog-cell"><div class="habit-mini-bar"><div class="habit-mini-fill" style="width:${pct}%"></div></div></td></tr>`;
  });
  html+=`</tbody></table></div>`;body.innerHTML=html;
}
function renderHabitCharts(d,body){
  const today=new Date().getDate();
  body.innerHTML=`<div class="chart-wrap"><div class="chart-title">◈ DAILY COMPLETION RATE</div><canvas id="chart-daily" class="habit-chart"></canvas></div><div class="chart-wrap" style="margin-top:12px;"><div class="chart-title">◈ HABIT COMPLETION % THIS MONTH</div><canvas id="chart-habits" class="habit-chart"></canvas></div>`;
  setTimeout(()=>{
    const dailyData=[];for(let day=1;day<=today;day++){let cnt=0;d.habits.forEach((_,hi)=>{if(d.log[hi]?.[day])cnt++;});dailyData.push(Math.round(cnt/d.habits.length*100));}
    drawLineChart('chart-daily',Array.from({length:today},(_,i)=>i+1),dailyData);
    const habitPcts=d.habits.map((h,hi)=>{const log=d.log[hi]||{};const done=Object.values(log).filter(Boolean).length;return Math.round(done/d.days*100);});
    drawBarChart('chart-habits',d.habits.map(h=>h.slice(0,12)),habitPcts);
  },50);
}
function drawLineChart(id,labels,data){
  const canvas=document.getElementById(id);if(!canvas)return;
  const ctx=canvas.getContext('2d');const W=canvas.offsetWidth||300,H=120;canvas.width=W;canvas.height=H;ctx.clearRect(0,0,W,H);
  const pad=30,pw=W-pad*2,ph=H-pad*2;
  ctx.strokeStyle='rgba(0,180,255,0.06)';ctx.lineWidth=1;for(let i=0;i<=4;i++){const y=pad+ph*(1-i/4);ctx.beginPath();ctx.moveTo(pad,y);ctx.lineTo(W-pad,y);ctx.stroke();}
  ctx.fillStyle='rgba(88,136,170,0.7)';ctx.font='8px Share Tech Mono';for(let i=0;i<=4;i++){ctx.fillText(i*25+'%',2,pad+ph*(1-i/4)+3);}
  if(!data.length)return;const step=pw/(data.length-1||1);
  ctx.beginPath();ctx.moveTo(pad,pad+ph*(1-data[0]/100));data.forEach((v,i)=>ctx.lineTo(pad+i*step,pad+ph*(1-v/100)));ctx.lineTo(pad+(data.length-1)*step,H-pad);ctx.lineTo(pad,H-pad);ctx.closePath();ctx.fillStyle='rgba(0,200,255,0.08)';ctx.fill();
  ctx.beginPath();ctx.strokeStyle='rgba(0,200,255,0.8)';ctx.lineWidth=2;data.forEach((v,i)=>{const x=pad+i*step,y=pad+ph*(1-v/100);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});ctx.stroke();
  data.forEach((v,i)=>{const x=pad+i*step,y=pad+ph*(1-v/100);ctx.beginPath();ctx.arc(x,y,3,0,Math.PI*2);ctx.fillStyle=v>=75?'rgba(0,255,170,0.9)':v>=50?'rgba(0,200,255,0.9)':'rgba(255,170,0,0.8)';ctx.fill();});
}
function drawBarChart(id,labels,data){
  const canvas=document.getElementById(id);if(!canvas)return;const ctx=canvas.getContext('2d');const W=canvas.offsetWidth||300,H=140;canvas.width=W;canvas.height=H;ctx.clearRect(0,0,W,H);
  const pad={t:10,b:30,l:10,r:10};const pw=W-pad.l-pad.r,ph=H-pad.t-pad.b;const bw=Math.max(4,(pw/data.length)-4);
  data.forEach((v,i)=>{const x=pad.l+(pw/data.length)*i+(pw/data.length-bw)/2;const bh=ph*(v/100);const y=pad.t+ph-bh;ctx.fillStyle=v>=75?'rgba(0,255,170,0.7)':v>=50?'rgba(0,200,255,0.7)':'rgba(255,170,0,0.7)';ctx.fillRect(x,y,bw,bh);ctx.fillStyle='rgba(88,136,170,0.8)';ctx.font='7px Share Tech Mono';ctx.save();ctx.translate(x+bw/2,H-pad.b+12);ctx.rotate(-Math.PI/4);ctx.fillText(labels[i]||'',0,0);ctx.restore();ctx.fillStyle='rgba(0,200,255,0.8)';ctx.font='8px Share Tech Mono';ctx.fillText(v+'%',x,y-2);});
}
function renderHabitManage(d,body){
  body.innerHTML=`<div class="section-lbl">◈ MANAGE HABITS</div>
  <div id="habit-list">${d.habits.map((h,i)=>`<div style="display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border2);">
    <span style="font-family:Rajdhani,sans-serif;font-size:13px;font-weight:600;color:var(--txt);flex:1;">${h}</span>
    <button onclick="removeHabit(${i})" style="padding:3px 10px;background:rgba(255,34,85,.06);border:1px solid rgba(255,34,85,.2);color:var(--danger);font-family:Share Tech Mono,monospace;font-size:8px;cursor:pointer;clip-path:polygon(3px 0%,100% 0%,calc(100% - 3px) 100%,0% 100%);">REMOVE</button>
  </div>`).join('')}</div>
  <div style="display:flex;gap:8px;margin-top:14px;">
    <input class="ab-inp" id="new-habit-inp" placeholder="New habit name..." style="flex:1;"/>
    <button class="add-btn" onclick="addHabit()">+ ADD</button>
  </div>
  <button class="ab-generate" style="margin-top:12px;" onclick="resetHabitMonth()">◈ RESET FOR NEW MONTH</button>`;
}
function toggleHabit(hi,day){const d=getHabitData();if(!d.log[hi])d.log[hi]={};d.log[hi][day]=!d.log[hi][day];saveHabitData(d);renderHabitTab();const today=new Date().getDate();const allDone=d.habits.every((_,i)=>d.log[i]?.[today]);if(allDone){const td=getTrainData();td.xp+=50;saveTrainData(td);toast('🏆 All habits done! +50 XP');}}
function addHabit(){const inp=document.getElementById('new-habit-inp');const name=inp.value.trim();if(!name)return;const d=getHabitData();d.habits.push(name);saveHabitData(d);inp.value='';renderHabitTab();toast('✅ Habit added: '+name);}
function removeHabit(i){const d=getHabitData();d.habits.splice(i,1);delete d.log[i];saveHabitData(d);renderHabitTab();}
function resetHabitMonth(){const d=getHabitData();const today=new Date();d.year=today.getFullYear();d.month=today.getMonth();d.days=new Date(d.year,d.month+1,0).getDate();d.log={};saveHabitData(d);renderHabitTab();toast('🔄 Habit tracker reset for new month');}

// ═══════════════════════════════════════════════════════
// AUDIOBOOK
// ═══════════════════════════════════════════════════════
let abDuration=5,abUtter=null,abPlaying=false,abChunks=[],abChunkIdx=0;
function selDur(btn){document.querySelectorAll('.ab-dur-btn').forEach(b=>b.classList.remove('on'));btn.classList.add('on');abDuration=parseInt(btn.dataset.min);}
async function generateAudiobook(){
  const topic=document.getElementById('ab-topic').value.trim();if(!topic){toast('⚠️ Enter a topic');return;}
  const style=document.getElementById('ab-style').value;const wordCount=abDuration*130;
  const btn=document.querySelector('.ab-generate');btn.textContent='◈ GENERATING...';btn.disabled=true;
  const styleGuides={narrator:'Professional audiobook narrator. Rich, measured tone.',story:'Immersive fiction. Vivid characters, dramatic tension.',educational:'Clear educational lecture. Step-by-step with examples.',dramatic:'Cinematic and epic. Powerful, emotional language.',podcast:'Conversational podcast host. Casual, engaging, relatable.'};
  const sys=`You are Raphael creating an audiobook script. ${styleGuides[style]||styleGuides.narrator} Write exactly ${wordCount} words. No formatting, no headers — pure flowing prose only. Start immediately.`;
  const r=await callAPI([{role:'user',content:`Create ${abDuration}-min audiobook on: ${topic}`}],sys,Math.min(4096,wordCount*2));
  btn.textContent='◈ GENERATE & PLAY AUDIOBOOK';btn.disabled=false;
  if(!r){toast('⚠️ Generation failed');return;}
  document.getElementById('ab-player-title').textContent=topic.toUpperCase()+' · '+abDuration+' MIN';
  document.getElementById('ab-script').textContent=r;
  document.getElementById('ab-player').classList.add('show');
  abChunks=r.match(/[^.!?]+[.!?]+/g)||[r];abChunkIdx=0;abPlaying=false;updateAbIco();toast('🎧 Audiobook ready! Press play');abPlay();
}
function abPlay(){if(!('speechSynthesis'in window)){toast('⚠️ TTS not supported');return;}if(abPlaying)return;abPlaying=true;updateAbIco();
  function speak(){if(abChunkIdx>=abChunks.length){abPlaying=false;abChunkIdx=0;updateAbIco();document.getElementById('ab-fill').style.width='0%';document.getElementById('ab-time').textContent='Done';return;}
    const u=new SpeechSynthesisUtterance(abChunks[abChunkIdx]);u.rate=0.88;u.pitch=1.1;
    const v=getBestVoice();if(v)u.voice=v;
    u.onend=()=>{abChunkIdx++;document.getElementById('ab-fill').style.width=(abChunkIdx/abChunks.length*100)+'%';document.getElementById('ab-time').textContent=Math.round(abChunkIdx/abChunks.length*abDuration)+':00 / '+abDuration+':00';speak();};
    speechSynthesis.speak(u);}
  if(speechSynthesis.getVoices().length===0){speechSynthesis.onvoiceschanged=()=>{speechSynthesis.onvoiceschanged=null;speak();};}else{speak();}
}
function abToggle(){if(abPlaying){speechSynthesis.pause();abPlaying=false;}else{if(speechSynthesis.paused){speechSynthesis.resume();abPlaying=true;}else{abPlay();}}updateAbIco();}
function abSkip(s){abChunkIdx=s>0?Math.min(abChunks.length-1,abChunkIdx+5):Math.max(0,abChunkIdx-5);speechSynthesis.cancel();abPlaying=false;abPlay();}
function abSeek(e){const bar=e.currentTarget;const pct=(e.clientX-bar.getBoundingClientRect().left)/bar.offsetWidth;abChunkIdx=Math.floor(pct*abChunks.length);speechSynthesis.cancel();abPlaying=false;abPlay();}
function updateAbIco(){const ico=document.getElementById('ab-play-ico');if(!ico)return;ico.innerHTML=abPlaying?'<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>':'<polygon points="5 3 19 12 5 21 5 3"/>';}

// ═══════════════════════════════════════════════════════
// BUSINESS TOOLS
// ═══════════════════════════════════════════════════════
let bizTab='products';
function switchBizTab(t){bizTab=t;document.querySelectorAll('[id^=biztab-]').forEach(x=>x.classList.remove('on'));document.getElementById('biztab-'+t)?.classList.add('on');renderBizTab();}
function renderBizTab(){const body=document.getElementById('biz-body');if(!body)return;if(bizTab==='products')renderBizProducts(body);else if(bizTab==='ads')renderBizAds(body);else if(bizTab==='social')renderBizSocial(body);else renderBizDocs(body);}
function initBusiness(){renderBizTab();}
function renderBizProducts(body){body.innerHTML=`<div class="biz-section"><div class="section-lbl">◈ PRODUCT RESEARCH</div><div class="ab-field"><div class="ab-label">PRODUCT OR NICHE</div><input class="ab-inp" id="biz-product-inp" placeholder="Product URL, name, or niche..."/></div><div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;"><button class="timer-btn" onclick="bizAnalyzeProduct()">◈ ANALYZE</button><button class="timer-btn" onclick="bizFindWinners()">◈ FIND WINNERS</button><button class="timer-btn" onclick="bizPrintifySetup()">◈ PRINTIFY GUIDE</button></div><div class="biz-result" id="biz-product-result" style="display:none;"></div></div>`;}
async function bizAnalyzeProduct(){const prod=document.getElementById('biz-product-inp').value.trim();if(!prod){toast('⚠️ Enter product info');return;}const res=document.getElementById('biz-product-result');res.style.display='block';res.innerHTML='Analyzing...';const r=await callAPI([{role:'user',content:`Analyze this for dropshipping/affiliate: ${prod}`}],`Expert e-commerce analyst. Analyze: market potential (1-10), target audience, USP, profit margin, best platforms, ad strategy, issues, recommendation. Be specific. Concise bullet points. Use emojis.`,1500);if(r){res.innerHTML=fmt(r);}}
async function bizFindWinners(){const niche=document.getElementById('biz-product-inp').value.trim()||'general';const res=document.getElementById('biz-product-result');res.style.display='block';res.innerHTML='Searching winners...';const r=await callAPI([{role:'user',content:`Find 5 current winning dropshipping products in: ${niche}`}],`Top dropshipping expert. For each product: name, why it's trending, source, cost, selling price, profit margin, audience, ad angle. Be specific. Use emojis. Concise.`,1500);if(r){res.innerHTML=fmt(r);}}
async function bizPrintifySetup(){const res=document.getElementById('biz-product-result');res.style.display='block';const r=await callAPI([{role:'user',content:'Complete Printify beginner guide'}],`Printify expert. Complete guide: setup, best products, designs that sell, pricing, Etsy/Shopify integration, marketing. Concise with emojis.`,1500);if(r){res.innerHTML=fmt(r);}}
function renderBizAds(body){body.innerHTML=`<div class="biz-section"><div class="section-lbl">◈ AD COPY + VIDEO AD MAKER</div><div class="ab-field"><div class="ab-label">PRODUCT/SERVICE</div><input class="ab-inp" id="ad-product" placeholder="What are you advertising?"/></div><div class="ab-field"><div class="ab-label">TARGET AUDIENCE</div><input class="ab-inp" id="ad-audience" placeholder="Who is it for?"/></div><div class="ab-field"><div class="ab-label">AD TYPE</div><select class="ab-inp" id="ad-type"><option>TikTok Video Script (15s)</option><option>TikTok Video Script (30s)</option><option>Facebook/Instagram Ad</option><option>YouTube Ad Script</option><option>Product Description</option><option>Email Campaign</option></select></div><div class="ab-field"><div class="ab-label">TONE</div><select class="ab-inp" id="ad-tone"><option>Urgent & Compelling</option><option>Friendly & Casual</option><option>Professional</option><option>Humorous</option><option>Emotional Story</option></select></div><button class="ab-generate" onclick="generateAd()">◈ GENERATE AD</button><button class="timer-btn" style="width:100%;margin-top:8px;" onclick="generateVideoAd()">🎬 GENERATE VIDEO AD + CLIPS</button><div class="biz-result" id="ad-result" style="display:none;margin-top:10px;"></div></div>`;}
async function generateAd(){const prod=document.getElementById('ad-product').value.trim();if(!prod){toast('⚠️ Enter product');return;}const audience=document.getElementById('ad-audience').value;const type=document.getElementById('ad-type').value;const tone=document.getElementById('ad-tone').value;const res=document.getElementById('ad-result');res.style.display='block';res.innerHTML='Generating...';const r=await callAPI([{role:'user',content:`Create ${type} for: ${prod}. Audience: ${audience}. Tone: ${tone}`}],`World-class copywriter. Compelling, conversion-optimized ad. Include hook, body, CTA. For video scripts include [SCENE] directions. Make it scroll-stopping. Be concise and punchy.`,1200);if(r){res.innerHTML=fmt(r);}}
async function generateVideoAd(){
  const prod=document.getElementById('ad-product').value.trim();if(!prod){toast('⚠️ Enter product');return;}
  const res=document.getElementById('ad-result');res.style.display='block';res.innerHTML='Building video ad concept...';
  const r=await callAPI([{role:'user',content:`Create a 30-second video ad concept for: ${prod}. Return JSON: {"scenes":[{"duration":"5s","visual":"stock clip search term","text":"on-screen text","voiceover":"spoken words"}],"music":"mood","cta":"call to action"}`}],
  `Professional video ad director. Create 6 scenes for a 30s video. Each scene has a stock clip search term (specific, searchable), on-screen text, and voiceover. Return valid JSON only.`,800);
  if(!r){res.innerHTML='<div style="color:var(--danger);">⚠️ Failed</div>';return;}
  try{
    const clean=r.replace(/```json|```/g,'').trim();const concept=JSON.parse(clean);
    let html=`<div class="section-lbl">🎬 VIDEO AD SCENES</div>`;
    html+=`<div style="display:grid;gap:8px;">`;
    for(let i=0;i<(concept.scenes||[]).length;i++){
      const scene=concept.scenes[i];
      html+=`<div style="border:1px solid var(--border2);padding:10px;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);background:rgba(0,8,24,.5);">
        <div style="display:flex;gap:10px;align-items:start;">
          <div style="font-family:Orbitron,monospace;font-size:16px;font-weight:900;color:var(--cyan);min-width:28px;">${i+1}</div>
          <div style="flex:1;">
            <div style="font-family:Share Tech Mono,monospace;font-size:7px;color:var(--txt3);">${scene.duration||'5s'}</div>
            <div style="font-family:Rajdhani,sans-serif;font-size:12px;color:var(--txt);margin:3px 0;"><strong style="color:var(--cyan);">Visual:</strong> ${scene.visual||''}</div>
            <div style="font-family:Rajdhani,sans-serif;font-size:12px;color:var(--txt);"><strong style="color:var(--purple);">Text:</strong> "${scene.text||''}"</div>
            <div style="font-family:Rajdhani,sans-serif;font-size:12px;color:var(--txt);"><strong style="color:var(--success);">VO:</strong> "${scene.voiceover||''}"</div>
            <a href="https://pixabay.com/videos/search/?q=${encodeURIComponent(scene.visual||'')}" target="_blank" style="display:inline-block;margin-top:6px;padding:3px 10px;font-family:Share Tech Mono,monospace;font-size:8px;color:var(--cyan);border:1px solid var(--border2);text-decoration:none;clip-path:polygon(3px 0%,100% 0%,calc(100% - 3px) 100%,0% 100%);">🎬 Find Clip on Pixabay</a>
          </div>
        </div>
      </div>`;
    }
    html+=`</div><div style="margin-top:10px;padding:8px;background:rgba(0,255,170,.04);border:1px solid rgba(0,255,170,.2);">🎵 Music: ${concept.music||''} · 📢 CTA: ${concept.cta||''}</div>`;
    res.innerHTML=html;
  }catch(e){res.innerHTML=fmt(r);}
}
function renderBizSocial(body){body.innerHTML=`<div class="biz-section"><div class="section-lbl">◈ SOCIAL MEDIA CONTENT BATCH + REAL VIDEO CLIPS</div><div class="ab-field"><div class="ab-label">TOPIC / NICHE</div><input class="ab-inp" id="social-topic" placeholder="e.g. fitness, dropshipping, anime art..."/></div><div class="ab-field"><div class="ab-label">PLATFORM</div><select class="ab-inp" id="social-platform"><option>TikTok</option><option>Instagram</option><option>YouTube Shorts</option><option>Twitter/X</option><option>LinkedIn</option></select></div><div class="ab-field"><div class="ab-label">BATCH SIZE</div><select class="ab-inp" id="social-batch"><option value="7">7 posts (1 week)</option><option value="14">14 posts (2 weeks)</option><option value="30">30 posts (1 month)</option></select></div><button class="ab-generate" onclick="generateSocialBatch()">◈ GENERATE CONTENT BATCH + VIDEO CLIPS</button><div class="biz-result" id="social-result" style="display:none;margin-top:10px;"></div></div>`;}
async function generateSocialBatch(){
  const topic=document.getElementById('social-topic').value.trim();if(!topic){toast('⚠️ Enter topic');return;}
  const platform=document.getElementById('social-platform').value;const batch=document.getElementById('social-batch').value;
  const res=document.getElementById('social-result');res.style.display='block';res.innerHTML='Generating batch...';
  const r=await callAPI([{role:'user',content:`Create ${batch} ${platform} posts about: ${topic}. Return JSON: {"posts":[{"day":1,"type":"educational/entertaining/promo","caption":"full caption","hashtags":"#tag1 #tag2","hook":"opening line","clip_search":"stock video search term for this post","posting_time":"best time"}]}`}],
  `Viral social media strategist. Create ${batch} varied posts (educational, entertaining, inspiring, promotional). Each needs a specific stock clip search term for Pixabay. Optimize for ${platform} algorithm. Return valid JSON only.`,2500);
  if(!r){res.innerHTML='<div style="color:var(--danger);">⚠️ Failed</div>';return;}
  try{
    const clean=r.replace(/```json|```/g,'').trim();const data=JSON.parse(clean);
    let html=`<div class="section-lbl">📱 ${data.posts?.length} ${platform.toUpperCase()} POSTS WITH VIDEO CLIPS</div>`;
    for(const post of (data.posts||[])){
      html+=`<div style="border:1px solid var(--border2);padding:12px;margin-bottom:8px;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%);">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
          <span style="font-family:Share Tech Mono,monospace;font-size:8px;color:var(--cyan);">DAY ${post.day}</span>
          <span style="font-family:Share Tech Mono,monospace;font-size:8px;color:var(--txt3);">${post.type?.toUpperCase()||''} · ${post.posting_time||''}</span>
        </div>
        <div style="font-family:Rajdhani,sans-serif;font-size:13px;color:var(--txt);font-weight:600;margin-bottom:4px;">🪝 ${post.hook||''}</div>
        <div style="font-family:Rajdhani,sans-serif;font-size:12px;color:var(--txt2);margin-bottom:6px;">${post.caption||''}</div>
        <div style="font-family:Share Tech Mono,monospace;font-size:8px;color:var(--purple);margin-bottom:6px;">${post.hashtags||''}</div>
        <a href="https://pixabay.com/videos/search/?q=${encodeURIComponent(post.clip_search||topic)}" target="_blank" style="display:inline-block;padding:3px 10px;font-family:Share Tech Mono,monospace;font-size:8px;color:var(--success);border:1px solid rgba(0,255,170,.3);text-decoration:none;clip-path:polygon(3px 0%,100% 0%,calc(100% - 3px) 100%,0% 100%);">🎬 Find Clip: "${post.clip_search||topic}"</a>
      </div>`;
    }
    res.innerHTML=html;
  }catch(e){res.innerHTML=fmt(r);}
}
function renderBizDocs(body){body.innerHTML=`<div class="biz-section"><div class="section-lbl">◈ DOCUMENT CREATOR</div><div class="ab-field"><div class="ab-label">DOCUMENT TYPE</div><select class="ab-inp" id="doc-type"><option>Business Plan</option><option>Invoice Template</option><option>Contract/Agreement</option><option>Resume/CV</option><option>Cover Letter</option><option>Proposal</option><option>Report</option><option>Email Campaign</option><option>YouTube Script</option><option>Blog Post with SEO</option></select></div><div class="ab-field"><div class="ab-label">DETAILS</div><textarea class="ab-inp" id="doc-details" placeholder="Describe what you need..." style="min-height:80px;resize:vertical;"></textarea></div><button class="ab-generate" onclick="generateDoc()">◈ GENERATE DOCUMENT</button><div class="biz-result" id="doc-result" style="display:none;margin-top:10px;"></div><button id="doc-download-btn" style="display:none;margin-top:8px;width:100%;" class="timer-btn" onclick="downloadDoc()">⬇ DOWNLOAD AS TXT</button></div>`;}
async function generateDoc(){const type=document.getElementById('doc-type').value;const details=document.getElementById('doc-details').value;const res=document.getElementById('doc-result');res.style.display='block';res.innerHTML='Creating...';const r=await callAPI([{role:'user',content:`Create a complete ${type}. Details: ${details}`}],`Professional document writer. Create complete, ready-to-use ${type}. All sections. Professional formatting. Include all necessary content.`,2500);if(r){res.innerHTML=fmt(r);document.getElementById('doc-download-btn').style.display='block';LS.set('raph_last_doc',{type,content:r});}}
function downloadDoc(){const d=LS.get('raph_last_doc');if(!d)return;const plain=d.content.replace(/<[^>]*>/g,'').replace(/\*\*(.*?)\*\*/g,'$1');const blob=new Blob([plain],{type:'text/plain'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=d.type.replace(/ /g,'-')+'.txt';a.click();}

function openApiSetup(){openPanel('api-panel');renderApiStatus();}
function renderApiStatus(){
  const card=document.getElementById('api-status-card');if(!card)return;
  const gk=getKey();const ak=getAnthropicKey();const ok=getOpenRouterKey();const tk=getTavilyKey();
  const model=getSelectedModel();const cfg=MODEL_CONFIGS[model]||MODEL_CONFIGS['groq-llama70b'];
  const activeKey=ok?'OpenRouter':gk?'Groq':ak?'Anthropic':'None';
  const isOnline=gk||ak||ok;
  card.style.cssText=`padding:14px;margin-bottom:18px;background:${isOnline?'rgba(0,255,170,.06)':'rgba(255,34,85,.06)'};border:1px solid ${isOnline?'rgba(0,255,170,.25)':'rgba(255,34,85,.25)'};clip-path:polygon(6px 0%,100% 0%,100% calc(100% - 6px),calc(100% - 6px) 100%,0% 100%,0% 6px);`;
  card.innerHTML=`<div style="font-family:Orbitron,monospace;font-size:10px;letter-spacing:2px;color:${isOnline?'var(--success)':'var(--danger)'};margin-bottom:8px;">${isOnline?'✅ ONLINE':'⚠️ OFFLINE'} · ${cfg.name}</div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-family:Share Tech Mono,monospace;font-size:8px;">
    <div style="color:${gk?'var(--success)':'var(--txt3)'};">${gk?'✅':'○'} Groq${gk?' · '+gk.slice(0,6)+'...':' (free)'}</div>
    <div style="color:${ok?'var(--success)':'var(--txt3)'};">${ok?'✅':'○'} OpenRouter${ok?' · '+ok.slice(0,6)+'...':''}</div>
    <div style="color:${ak?'var(--success)':'var(--txt3)'};">${ak?'✅':'○'} Anthropic${ak?' · '+ak.slice(0,6)+'...':''}</div>
    <div style="color:${tk?'var(--success)':'var(--txt3)'};">${tk?'✅':'○'} Tavily Search${tk?'':' (optional)'}</div>
  </div>`;

  // Render model selector
  const modelSel=document.getElementById('model-selector');
  if(modelSel){
    modelSel.innerHTML='';
    Object.entries(MODEL_CONFIGS).forEach(([id,cfg])=>{
      const btn=document.createElement('button');
      const needsKey=(cfg.provider==='groq'&&!gk)||(cfg.provider==='openrouter'&&!ok)||(cfg.provider==='anthropic'&&!ak);
      btn.style.cssText=`padding:8px 10px;border:1px solid ${id===model?'var(--cyan)':'var(--border2)'};background:${id===model?'var(--cyan3)':'transparent'};font-family:Share Tech Mono,monospace;font-size:8px;color:${needsKey?'var(--txt3)':id===model?'var(--cyan)':'var(--txt2)'};cursor:pointer;text-align:left;clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);transition:all .2s;`;
      btn.innerHTML=`<div>${cfg.name}</div><div style="font-size:7px;opacity:.7;">${cfg.badge}${needsKey?' · NEED KEY':''}</div>`;
      btn.onclick=()=>{if(needsKey){toast('⚠️ Add '+cfg.provider+' key first');return;}localStorage.setItem('raph_model',id);renderApiStatus();toast('🤖 Model: '+cfg.name);};
      modelSel.appendChild(btn);
    });
  }
  const chip=document.getElementById('api-chip-txt');if(chip)chip.textContent=cfg.badge;
}
function saveGeminiKey(){
  const k=document.getElementById('gemini-key-inp').value.trim();if(!k)return;
  if(!k.startsWith('gsk_')){toast('⚠️ Groq keys start with gsk_');return;}
  localStorage.setItem('raph_groq_key',k);document.getElementById('gemini-key-inp').value='';
  renderApiStatus();toast('✅ GROQ KEY SAVED · 14,400 free requests/day!');
}
function saveOpenRouterKey(){
  const k=document.getElementById('openrouter-key-inp').value.trim();if(!k)return;
  localStorage.setItem('raph_openrouter_key',k);document.getElementById('openrouter-key-inp').value='';
  // Default to Claude if OpenRouter added
  if(!getSelectedModel().startsWith('openrouter'))localStorage.setItem('raph_model','openrouter-claude');
  renderApiStatus();toast('✅ OpenRouter key saved · Claude 3.5 Sonnet unlocked!');
}
function saveTavilyKey(){
  const k=document.getElementById('tavily-key-inp').value.trim();if(!k)return;
  localStorage.setItem('raph_tavily_key',k);document.getElementById('tavily-key-inp').value='';
  renderApiStatus();toast('✅ Tavily key saved · Google-quality search enabled!');
}
function saveAnthropicKey(){
  const k=document.getElementById('anthropic-key-inp').value.trim();if(!k)return;
  localStorage.setItem('raphael_key',k);document.getElementById('anthropic-key-inp').value='';
  renderApiStatus();toast('✅ Anthropic key saved!');
}
function clearKeys(){if(!confirm('Clear all API keys?'))return;['raph_groq_key','raphael_key','raph_openrouter_key','raph_tavily_key'].forEach(k=>localStorage.removeItem(k));renderApiStatus();toast('✕ Keys cleared');}
function promptKey(){openApiSetup();}
</script>
</body>
</html>
